<!DOCTYPE html>
<html lang="ar" dir="rtl" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' }
                    },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
      import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyB5aT_4wx3fXD_3uyz7bMtGUbG1ECaRMYI",
        authDomain: "dmcode-eafe2.firebaseapp.com",
        projectId: "dmcode-eafe2",
        storageBucket: "dmcode-eafe2.firebasestorage.app",
        messagingSenderId: "1011397956804",
        appId: "1:1011397956804:web:9ec42580702e2d130d6591",
        measurementId: "G-Z23YM2RBH7"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const firestoreDB = getFirestore(app);

      // Expose Firebase to global scope
      window.firebaseApp = app;
      
      // Firebase API Helper
      window.firebaseAPI = {
          async loadData() {
              const data = { orders: [], staff: [], users: [], payouts: [], logs: [], clients: [], settings: [], adjustments: [] };
              const collections = ['orders', 'staff', 'users', 'payouts', 'logs', 'clients', 'settings', 'adjustments'];
              
              try {
                  for (const colName of collections) {
                      const querySnapshot = await getDocs(collection(firestoreDB, colName));
                      querySnapshot.forEach((doc) => {
                          data[colName].push(doc.data());
                      });
                  }
              } catch (error) {
                  console.error("Error loading data:", error);
                  alert("حدث خطأ أثناء تحميل البيانات من السيرفر");
              }
              return data;
          },
          async save(col, id, data) {
              await setDoc(doc(firestoreDB, col, String(id)), data);
          },
          async delete(col, id) {
              await deleteDoc(doc(firestoreDB, col, String(id)));
          },
          async clearCollection(colName, ids) {
              const batch = writeBatch(firestoreDB);
              ids.forEach(id => {
                  const docRef = doc(firestoreDB, colName, String(id));
                  batch.delete(docRef);
              });
              await batch.commit();
          }
      };
      
      // Trigger app init when ready
      window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        
        /* Custom Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-section { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15); }

        /* Status Badges */
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-bold inline-flex items-center gap-1; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-700 rounded-full; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-slate-400 dark:bg-slate-600; }

        /* Mobile Responsive Table to Cards */
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { 
                display: flex; 
                flex-direction: column; 
                background: white; 
                margin-bottom: 1rem; 
                border-radius: 1rem; 
                padding: 1rem; 
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border: 1px solid #e2e8f0;
            }
            .dark .responsive-table tbody tr {
                background: #1e293b;
                border-color: #334155;
            }
            .responsive-table td { 
                padding: 0.5rem 0; 
                border: none !important;
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #64748b;
                font-size: 0.75rem;
                margin-left: 1rem;
            }
            .responsive-table td:last-child {
                justify-content: center;
                margin-top: 0.5rem;
                padding-top: 1rem;
                border-top: 1px dashed #e2e8f0 !important;
            }
            .dark .responsive-table td:last-child {
                border-color: #334155 !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 antialiased selection:bg-indigo-500 selection:text-white transition-colors duration-300">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold">جاري الاتصال بقاعدة البيانات...</h2>
    </div>

    <!-- Notifications -->
    <div id="notification-area" class="fixed top-6 left-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- 1. LOGIN SCREEN -->
    <section id="login-screen" class="h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center relative">
        <div class="absolute inset-0 bg-indigo-950/90 backdrop-blur-sm"></div>
        <div class="bg-white/95 dark:bg-slate-900/95 p-10 rounded-3xl shadow-2xl w-full max-w-md fade-in relative z-10 border border-white/10 backdrop-blur-md">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-indigo-600 text-white mb-6 shadow-lg rotate-3 hover:rotate-6 transition duration-300">
                    <i class="fas fa-cube text-4xl"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white" id="login-title">بوابة الإدارة</h2>
                <p class="text-slate-500 dark:text-slate-400 mt-2 font-medium">نظام الوكالة المتطور</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-5">
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">اسم المستخدم</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400"><i class="fas fa-user"></i></span>
                        <input type="text" id="username" class="w-full pr-10 pl-4 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Username" required>
                    </div>
                </div>
                <div class="mb-8">
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">كلمة المرور</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400"><i class="fas fa-lock"></i></span>
                        <input type="password" id="password" class="w-full pr-10 pl-4 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="••••••••" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg shadow-indigo-500/30 transform active:scale-95">
                    تسجيل الدخول <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 py-2 rounded-lg">
                معلومات تجريبية: admin / admin
            </div>
        </div>
    </section>

    <!-- 2. MAIN DASHBOARD -->
    <section id="dashboard-screen" class="hidden-section min-h-screen flex flex-col md:flex-row bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-slate-900 dark:bg-slate-950 text-white flex-shrink-0 flex flex-col shadow-2xl z-20 md:h-screen sticky top-0">
            <div class="p-6 flex items-center justify-between border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i class="fas fa-layer-group text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight" id="sidebar-title">الوكالة</h1>
                        <span class="text-xs text-slate-400 font-normal">لوحة التحكم</span>
                    </div>
                </div>
                <button class="md:hidden text-slate-400 hover:text-white transition" onclick="toggleMobileMenu()"><i class="fas fa-bars text-xl"></i></button>
            </div>
            
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto hidden md:block">
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">إدارة العمل</p>
                <button onclick="switchTab('orders')" id="nav-orders" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-clipboard-list"></i></span>
                    الطلبات والعملاء
                </button>
                <button onclick="switchTab('deliveries')" id="nav-deliveries" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-pink-600 group-hover:text-white transition"><i class="fas fa-truck"></i></span>
                    التسليمات والمواعيد
                </button>
                <button onclick="switchTab('collections')" id="nav-collections" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-teal-600 group-hover:text-white transition"><i class="fas fa-money-bill-wave"></i></span>
                    التحصيلات والمالية
                </button>
                <button onclick="switchTab('marketers')" id="nav-marketers" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-emerald-600 group-hover:text-white transition"><i class="fas fa-bullhorn"></i></span>
                    المسوقين والنسب
                </button>
                <button onclick="switchTab('designers')" id="nav-designers" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-palette"></i></span>
                    المصممين
                </button>
                <button onclick="switchTab('clients')" id="nav-clients" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition"><i class="fas fa-user-tie"></i></span>
                    العملاء (VIP)
                </button>
                <button onclick="switchTab('adjustments')" id="nav-adjustments" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition"><i class="fas fa-file-invoice-dollar"></i></span>
                    الحوافز والخصومات
                </button>
                <button onclick="switchTab('my-tasks')" id="nav-my-tasks" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group hidden">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-yellow-600 group-hover:text-white transition"><i class="fas fa-tasks"></i></span>
                    مهامي (المطلوب)
                </button>
                <button onclick="switchTab('profile')" id="nav-profile" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group hidden">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-cyan-600 group-hover:text-white transition"><i class="fas fa-id-card"></i></span>
                    الملف الشخصي
                </button>
                
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6">النظام</p>
                <button onclick="switchTab('users')" id="nav-users" id="users-tab-btn" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition"><i class="fas fa-users-cog"></i></span>
                    المستخدمين
                </button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition"><i class="fas fa-database"></i></span>
                    الإعدادات والنظام
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <button onclick="toggleDarkMode()" class="w-full mb-3 px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-moon"></i> الوضع الليلي
                </button>
                <button onclick="logout()" class="w-full px-4 py-3 rounded-xl bg-red-600/10 hover:bg-red-600 text-red-400 hover:text-white transition flex items-center justify-center gap-2 font-bold text-sm">
                    <i class="fas fa-sign-out-alt"></i> تسجيل خروج
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen relative">
            
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight" id="page-title">لوحة التحكم</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1" id="current-date"></p>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Notifications Bell -->
                    <div class="relative" id="notification-bell-container">
                        <button onclick="toggleNotificationMenu()" class="relative w-14 h-14 rounded-2xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 transition shadow-sm flex items-center justify-center group">
                            <i class="fas fa-bell text-xl group-hover:text-indigo-500 transition"></i>
                            <span id="notification-badge" class="absolute top-3 right-3 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800 hidden animate-pulse"></span>
                        </button>
                        
                        <div id="notification-menu" class="absolute left-0 mt-3 w-80 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 hidden z-50 overflow-hidden origin-top-left">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-800 dark:text-white text-sm">التنبيهات (تأخير التسليم)</h3>
                            </div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-lg" id="user-avatar">A</div>
                        <div class="hidden md:block px-2">
                            <div class="text-sm font-bold text-slate-800 dark:text-white" id="user-name-display">Admin</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">مدير النظام</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATS CARDS -->
            <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8 fade-in">
                <!-- Total Orders -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">إجمالي الطلبات</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="stat-total-orders">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center"><i class="fas fa-folder-open text-lg"></i></div>
                    </div>
                </div>
                <!-- Revenue -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">الخزينة (المدفوع)</p>
                            <h3 class="text-2xl font-black text-emerald-600 dark:text-emerald-400 dir-ltr" id="stat-revenue">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center"><i class="fas fa-wallet text-lg"></i></div>
                    </div>
                </div>
                <!-- Net Profit -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">صافي الربح</p>
                            <h3 class="text-2xl font-black text-blue-600 dark:text-blue-400 dir-ltr" id="stat-net-profit">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center"><i class="fas fa-chart-line text-lg"></i></div>
                    </div>
                </div>
                <!-- Debt (New Logic) -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">مديونيات (لنا)</p>
                            <h3 class="text-2xl font-black text-orange-500 dark:text-orange-400 dir-ltr" id="stat-debt">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center"><i class="fas fa-hand-holding-usd text-lg"></i></div>
                    </div>
                </div>
                <!-- Late Tasks -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">تأخيرات (24H)</p>
                            <h3 class="text-2xl font-black text-red-600 dark:text-red-400" id="stat-late-tasks">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center"><i class="fas fa-alarm-clock text-lg"></i></div>
                    </div>
                </div>
            </div>

            <!-- CHARTS SECTION (New) -->
            <div id="charts-area" class="mb-8 fade-in space-y-6">
                <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold text-slate-700 dark:text-slate-300">تحليل البيانات</h3>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-500 dark:text-slate-400 font-bold">الفترة:</label>
                        <input type="month" id="chart-month-filter" onchange="renderCharts()" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-1.5 text-sm dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">توزيع حالات الطلبات</h3>
                        <div class="h-64 flex items-center justify-center relative">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">أعلى المسوقين مبيعاً</h3>
                        <div class="h-64 flex items-center justify-center relative">
                            <canvas id="marketerChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">الإيرادات اليومية</h3>
                    <div class="h-64 w-full relative">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 id="chart-title-designers" class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">أداء المصممين (عدد التصاميم المكتملة)</h3>
                    <div class="h-64 w-full relative">
                        <canvas id="designerChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">توزيع العملاء حسب المصدر</h3>
                    <div class="h-64 flex items-center justify-center relative">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TAB 1: ORDERS -->
            <div id="tab-orders" class="tab-content fade-in">
                <!-- Advanced Controls -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <div class="flex w-full md:w-auto gap-2">
                         <button onclick="openModal('order-modal')" class="flex-1 md:flex-none bg-indigo-600 text-white px-6 py-2.5 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition flex items-center justify-center gap-2 font-bold">
                            <i class="fas fa-plus"></i> <span class="hidden md:inline">طلب جديد</span><span class="md:hidden">إضافة</span>
                        </button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="filterToday()" class="relative px-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition shadow-sm whitespace-nowrap">
                            <i class="fas fa-calendar-day text-indigo-500"></i> طلبات اليوم
                            <span id="today-orders-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-sm">0</span>
                        </button>
                        <!-- Date Filter -->
                        <div class="relative w-full md:w-40">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-calendar-alt"></i></span>
                            <select id="filter-date" onchange="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white cursor-pointer appearance-none">
                                <option value="all">كل الأوقات</option>
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                                <option value="month">هذا الشهر</option>
                            </select>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="relative w-full md:w-40">
                             <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-filter"></i></span>
                            <select id="filter-status" onchange="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white cursor-pointer appearance-none">
                                <option value="all">كل الحالات</option>
                                <option value="pending">قيد التنفيذ</option>
                                <option value="review">مراجعة</option>
                                <option value="done">مكتمل</option>
                                <option value="rejected">مرفوض</option>
                            </select>
                        </div>

                        <!-- Search -->
                         <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-orders" onkeyup="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="بحث (اسم، رقم)...">
                        </div>
                    </div>
                </div>

                <!-- Responsive Table/Grid -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right responsive-table">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">العميل</th>
                                    <th class="p-5">تفاصيل الخدمة</th>
                                    <th class="p-5">المالية</th>
                                    <th class="p-5 text-center">عربون</th>
                                    <th class="p-5">الفريق</th>
                                    <th class="p-5">الحالة</th>
                                    <th class="p-5 text-center">تحكم</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-orders-state" class="hidden p-10 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-400 mb-4">
                            <i class="fas fa-inbox text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-300">لا توجد طلبات</h3>
                        <p class="text-slate-500 dark:text-slate-500">حاول تغيير الفلتر أو أضف طلب جديد</p>
                    </div>
                </div>
            </div>

            <!-- TAB: DELIVERIES (New) -->
            <div id="tab-deliveries" class="tab-content hidden-section fade-in">
                <!-- Delivery Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">تسليمات اليوم</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="del-today-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center"><i class="fas fa-calendar-day"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">تسليمات غداً</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="del-tmrw-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center"><i class="fas fa-sun"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">متأخرة</p>
                            <h3 class="text-2xl font-black text-red-600 dark:text-red-400" id="del-late-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center"><i class="fas fa-exclamation-circle"></i></div>
                    </div>
                </div>

                <!-- Deliveries Table -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">جدول التسليمات</h3>
                            <div class="text-sm text-slate-500">مرتبة حسب الأقرب للتسليم</div>
                        </div>
                        <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-deliveries" onkeyup="renderDeliveries()" class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="بحث في التسليمات...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">تاريخ التسليم</th>
                                    <th class="p-5">العميل</th>
                                    <th class="p-5">الخدمة</th>
                                    <th class="p-5">المتبقي</th>
                                    <th class="p-5">المصمم</th>
                                    <th class="p-5">الحالة</th>
                                    <th class="p-5 text-center">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="deliveries-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: COLLECTIONS (New) -->
            <div id="tab-collections" class="tab-content hidden-section fade-in">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">سجل التحصيلات والديون</h3>
                            <div class="text-sm text-slate-500">يعرض هذا الجدول الحالة المالية وحالة الطلب فقط</div>
                        </div>
                        <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-collections" onkeyup="renderCollections()" class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="بحث (عميل، رقم)...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-teal-50 dark:bg-teal-900/20 text-teal-800 dark:text-teal-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">رقم المرجع</th>
                                    <th class="p-5">العميل</th>
                                    <th class="p-5">الخدمة</th>
                                    <th class="p-5">إجمالي السعر</th>
                                    <th class="p-5 text-emerald-600">المدفوع</th>
                                    <th class="p-5 text-red-500">المتبقي (ديون)</th>
                                    <th class="p-5">حالة الطلب</th>
                                </tr>
                            </thead>
                            <tbody id="collections-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200"></tbody>
                            <tfoot id="collections-table-footer" class="bg-slate-50 dark:bg-slate-800 font-bold text-slate-800 dark:text-white border-t-2 border-slate-200 dark:border-slate-700"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 3: MARKETERS -->
            <div id="tab-marketers" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex gap-3">
                        <button onclick="openModal('staff-modal', 'marketer')" class="bg-emerald-600 text-white px-6 py-2.5 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition font-bold">
                            <i class="fas fa-plus"></i> إضافة مسوق
                        </button>
                        <button onclick="openReportModal()" class="bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 px-6 py-2.5 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition font-bold">
                            <i class="fas fa-chart-pie text-emerald-500"></i> تقرير العمولات
                        </button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-marketers" onkeyup="renderMarketers()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="بحث عن مسوق...">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="marketers-grid">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- TAB 4: DESIGNERS -->
            <div id="tab-designers" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('staff-modal', 'designer')" class="bg-purple-600 text-white px-6 py-2.5 rounded-xl hover:bg-purple-700 shadow-lg shadow-purple-500/30 transition font-bold">
                        <i class="fas fa-plus"></i> إضافة مصمم
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-designers" onkeyup="renderDesigners()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 dark:text-white" placeholder="بحث عن مصمم...">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6" id="designers-grid">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- TAB: CLIENTS (VIP) -->
            <div id="tab-clients" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('client-modal')" class="bg-orange-600 text-white px-6 py-2.5 rounded-xl hover:bg-orange-700 shadow-lg shadow-orange-500/30 transition font-bold">
                        <i class="fas fa-plus"></i> إضافة عميل VIP
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-clients" onkeyup="renderClients()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 dark:text-white" placeholder="بحث عن عميل...">
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                                <th class="p-4 text-slate-500 font-bold">العميل</th>
                                <th class="p-4 text-slate-500 font-bold">رقم الهاتف</th>
                                <th class="p-4 text-slate-500 font-bold">رصيد المحفظة</th>
                                <th class="p-4 text-slate-500 font-bold text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: ADJUSTMENTS (BONUS & DEDUCTIONS) -->
            <div id="tab-adjustments" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('adjustment-modal')" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition font-bold">
                        <i class="fas fa-plus"></i> إضافة حافز / خصم
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-adjustments" onkeyup="renderAdjustments()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="بحث باسم الموظف...">
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                                <th class="p-4 text-slate-500 font-bold">التاريخ</th>
                                <th class="p-4 text-slate-500 font-bold">الموظف</th>
                                <th class="p-4 text-slate-500 font-bold">النوع</th>
                                <th class="p-4 text-slate-500 font-bold">المبلغ</th>
                                <th class="p-4 text-slate-500 font-bold">السبب</th>
                                <th class="p-4 text-slate-500 font-bold text-center">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="adjustments-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: MY TASKS (New) -->
            <div id="tab-my-tasks" class="tab-content hidden-section fade-in">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">مهامي المطلوبة</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">قائمة بالأعمال المسندة إليك والتي لم تكتمل بعد.</p>
                </div>
                <div id="my-tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- TAB: PROFILE (New) -->
            <div id="tab-profile" class="tab-content hidden-section fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Profile Card -->
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                            <div class="relative w-24 h-24 mx-auto bg-white dark:bg-slate-800 rounded-full p-1 shadow-lg -mt-4 mb-4">
                                <div class="w-full h-full rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-3xl font-bold text-slate-600 dark:text-slate-300" id="profile-avatar">A</div>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-1" id="profile-name">User</h2>
                            <p class="text-indigo-600 dark:text-indigo-400 font-medium mb-6" id="profile-role">Role</p>
                            
                            <div class="space-y-4 text-right">
                                <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                                    <span class="text-slate-500 dark:text-slate-400">اسم المستخدم</span>
                                    <span class="font-bold text-slate-800 dark:text-white" id="profile-username">-</span>
                                </div>
                                <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                                    <span class="text-slate-500 dark:text-slate-400">رقم الهاتف</span>
                                    <span class="font-bold text-slate-800 dark:text-white" id="profile-phone">-</span>
                                </div>
                                <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                                    <span class="text-slate-500 dark:text-slate-400">النسبة / العمولة</span>
                                    <span class="font-bold text-emerald-600 dark:text-emerald-400" id="profile-commission">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Stats -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <p class="text-slate-500 text-xs font-bold uppercase mb-2">إجمالي الأرباح (الراتب)</p>
                                <h3 class="text-2xl font-black text-emerald-600 dark:text-emerald-400" id="profile-total-earnings">0</h3>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <p class="text-slate-500 text-xs font-bold uppercase mb-2">أرباح هذا الشهر</p>
                                <h3 class="text-2xl font-black text-blue-600 dark:text-blue-400" id="profile-month-earnings">0</h3>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <p class="text-slate-500 text-xs font-bold uppercase mb-2">المحفظة (عهدة)</p>
                                <h3 class="text-2xl font-black text-orange-600 dark:text-orange-400" id="profile-wallet">0</h3>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-4">سجل الحوافز والخصومات</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 text-xs uppercase">
                                        <tr>
                                            <th class="p-3">التاريخ</th>
                                            <th class="p-3">النوع</th>
                                            <th class="p-3">المبلغ</th>
                                            <th class="p-3">السبب</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profile-adjustments-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: USERS -->
            <div id="tab-users" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('user-modal')" class="bg-slate-800 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl hover:bg-slate-900 shadow-lg transition font-bold">
                        <i class="fas fa-user-shield"></i> إضافة مستخدم
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-users" onkeyup="renderUsers()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="بحث عن مستخدم...">
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden max-w-3xl mx-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                                <th class="p-4 text-slate-500 font-bold">المستخدم</th>
                                <th class="p-4 text-slate-500 font-bold">الصلاحية</th>
                                <th class="p-4 text-slate-500 font-bold">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 6: SETTINGS -->
            <div id="tab-settings" class="tab-content hidden-section fade-in">
                <div class="max-w-2xl mx-auto space-y-6">
                    
                    <!-- General Settings -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-cog text-slate-500"></i> إعدادات النظام</h3>
                        <form onsubmit="saveAppSettings(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">اسم البرنامج / الوكالة</label>
                                <input type="text" id="setting-app-name" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="مثلاً: DM Agency">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">رابط الشعار (Logo URL)</label>
                                <input type="text" id="setting-logo-url" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="https://...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">بنود الفاتورة (الشروط والأحكام)</label>
                                <textarea id="setting-invoice-terms" rows="4" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="أدخل الشروط التي ستظهر أسفل الفاتورة..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">تخصيص المسميات والعملة</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" id="setting-currency" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="العملة (مثلاً: ج.م)">
                                    <input type="text" id="setting-designer-label-s" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="مسمى المصمم (مفرد)">
                                    <input type="text" id="setting-designer-label-p" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" placeholder="مسمى المصمم (جمع)">
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" class="bg-slate-800 dark:bg-slate-600 text-white px-6 py-3 rounded-xl hover:bg-slate-900 font-bold transition">حفظ الإعدادات</button>
                            </div>
                        </form>
                    </div>

                    <!-- Service Types Management -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2">
                            <i class="fas fa-list text-blue-500"></i> أنواع المشاريع / الخدمات
                        </h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-service-type" class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2 dark:text-white" placeholder="اسم الخدمة الجديدة...">
                            <button onclick="addServiceType()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 font-bold">إضافة</button>
                        </div>
                        <div id="settings-services-list" class="flex flex-wrap gap-2">
                            <!-- JS Generated -->
                        </div>
                    </div>

                    <!-- Sources Management (New) -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2">
                            <i class="fas fa-share-alt text-pink-500"></i> مصادر العملاء (Facebook, Instagram...)
                        </h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-source-type" class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2 dark:text-white" placeholder="اسم المصدر الجديد...">
                            <button onclick="addSource()" class="bg-pink-600 text-white px-4 py-2 rounded-xl hover:bg-pink-700 font-bold">إضافة</button>
                        </div>
                        <div id="settings-sources-list" class="flex flex-wrap gap-2">
                            <!-- JS Generated -->
                        </div>
                    </div>

                    <!-- Change Password -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-key text-indigo-500"></i> تغيير كلمة المرور</h3>
                        <form onsubmit="changePassword(event)" class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">كلمة المرور الجديدة</label>
                                <input type="password" id="new-system-password" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" required placeholder="أدخل كلمة المرور الجديدة">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-bold transition">تحديث</button>
                        </form>
                    </div>

                    <!-- Activity Log -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-history text-slate-500"></i> سجل النشاطات (آخر 50 عملية)</h3>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto rounded-xl border border-slate-100 dark:border-slate-700">
                            <table class="w-full text-right">
                                <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3">التوقيت</th>
                                        <th class="p-3">المستخدم</th>
                                        <th class="p-3">الحدث</th>
                                        <th class="p-3">التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-log-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Backup -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-database text-orange-500"></i> النسخ الاحتياطي</h3>
                        <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">
                            البيانات محفوظة على هذا الجهاز فقط. قم بتحميل نسخة احتياطية بانتظام.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="exportData()" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-indigo-200 dark:border-indigo-800 rounded-xl hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition group">
                                <i class="fas fa-download text-3xl text-indigo-400 group-hover:text-indigo-600 mb-3"></i>
                                <span class="font-bold text-indigo-700 dark:text-indigo-400">تحميل نسخة (Export)</span>
                            </button>
                            <label class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-emerald-200 dark:border-emerald-800 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition cursor-pointer group h-full">
                                <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                                <i class="fas fa-upload text-3xl text-emerald-400 group-hover:text-emerald-600 mb-3"></i>
                                <span class="font-bold text-emerald-700 dark:text-emerald-400">استعادة نسخة (Import)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red-50 dark:bg-red-900/10 p-8 rounded-2xl shadow-sm border border-red-200 dark:border-red-900/30">
                        <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 border-b border-red-200 dark:border-red-800 pb-2"><i class="fas fa-exclamation-triangle"></i> منطقة الخطر</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-6 text-sm">
                            تصفير النظام سيقوم بحذف <strong>جميع الطلبات والمدفوعات والتقارير</strong> لبدء موسم جديد. لن يتم حذف حسابات الموظفين أو المستخدمين.
                        </p>
                        <button onclick="resetSystem()" class="w-full bg-red-600 text-white py-4 rounded-xl hover:bg-red-700 font-bold shadow-lg shadow-red-500/30 transition">تصفير النظام (بدء موسم جديد)</button>
                    </div>

                </div>
            </div>

        </main>
    </section>

    <!-- MODAL: ORDER -->
    <div id="order-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 md:p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white" id="modal-title">بيانات الطلب</h3>
                <button onclick="closeModal('order-modal')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <form id="order-form" onsubmit="saveOrder(event)">
                <input type="hidden" id="order-id">
                
                <!-- VIP Client Selection -->
                <div class="mb-5 bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-900/30">
                    <label class="flex items-center gap-2 cursor-pointer mb-2">
                        <input type="checkbox" id="is-vip-order" onchange="toggleVipMode()" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500">
                        <span class="font-bold text-orange-800 dark:text-orange-400">عميل VIP (خصم من المحفظة)</span>
                    </label>
                    <div id="vip-selection" class="hidden mt-2">
                        <select id="vip-client-select" onchange="selectVipClient()" class="w-full bg-white dark:bg-slate-800 border border-orange-200 dark:border-orange-900 rounded-xl px-4 py-2 dark:text-white"></select>
                        <p id="vip-balance-display" class="text-xs font-bold mt-2 text-slate-500"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">اسم العميل</label>
                        <input type="text" id="client-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition" required placeholder="الاسم">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">رقم الهاتف</label>
                        <input type="tel" id="client-phone" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition" placeholder="01xxxxxxxxx">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المصدر</label>
                        <select id="order-source" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <!-- JS Populated -->
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">نوع الخدمة</label>
                        <select id="service-type" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <!-- JS Populated -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">تاريخ التسليم</label>
                        <input type="date" id="delivery-date" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">إجمالي السعر</label>
                        <input type="number" id="order-price" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white font-bold" placeholder="0.00" oninput="calculateRemaining(); calculateOrderCommission()">
                    </div>
                </div>

                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-2xl mb-5 border border-indigo-100 dark:border-indigo-800">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-end">
                        <div class="flex items-center gap-3 mb-2 md:mb-0 bg-white dark:bg-slate-800 p-3 rounded-xl border border-indigo-100 dark:border-indigo-900">
                            <input type="checkbox" id="deposit-paid" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                            <label for="deposit-paid" class="font-bold text-slate-700 dark:text-slate-300 cursor-pointer select-none">عربون؟</label>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-indigo-500 mb-1 uppercase">المدفوع</label>
                            <input type="number" id="amount-paid" class="w-full bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-900 rounded-xl px-3 py-2 text-indigo-700 dark:text-indigo-400 font-bold" placeholder="0" oninput="calculateRemaining()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-red-500 mb-1 uppercase">المتبقي</label>
                            <input type="text" id="amount-remaining" class="w-full bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900 rounded-xl px-3 py-2 text-red-600 dark:text-red-400 font-bold" readonly value="0">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المسوق</label>
                        <select id="order-marketer" onchange="calculateOrderCommission()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="">-- مباشر --</option>
                        </select>
                        <div id="order-commission-preview" class="text-xs font-bold text-emerald-600 mt-2 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المصمم</label>
                        <select id="order-designer" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="">-- اختر مصمم --</option>
                        </select>
                    </div>
                </div>

                <div class="mb-5 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3"><i class="fas fa-layer-group text-indigo-500"></i> تفاصيل التصميم والملفات</label>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="text" id="design-link" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition text-sm" placeholder="🔗 رابط ملفات التصميم (Google Drive / Dropbox / Images URL)">
                        <textarea id="design-notes" rows="2" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition text-sm" placeholder="📝 ملاحظات إضافية للتصميم..."></textarea>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2"><i class="fas fa-lock text-red-500"></i> ملاحظات خاصة (لا تظهر للعميل)</label>
                    <textarea id="private-notes" rows="2" class="w-full bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 rounded-xl px-4 py-3 focus:ring-2 focus:ring-red-500 dark:text-white transition text-sm" placeholder="ملاحظات داخلية للفريق فقط..."></textarea>
                </div>

                <div class="mb-8">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">الحالة</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="pending" class="peer hidden" checked onchange="updateStatusSelect('pending')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-yellow-100 peer-checked:text-yellow-700 font-bold transition">قيد التنفيذ</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="review" class="peer hidden" onchange="updateStatusSelect('review')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-blue-100 peer-checked:text-blue-700 font-bold transition">مراجعة</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="done" class="peer hidden" onchange="updateStatusSelect('done')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-emerald-100 peer-checked:text-emerald-700 font-bold transition">مكتمل</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="rejected" class="peer hidden" onchange="updateStatusSelect('rejected')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-red-100 peer-checked:text-red-700 font-bold transition">مرفوض</div>
                        </label>
                    </div>
                    <select id="order-status" class="hidden"><option value="pending"></option></select>
                </div>

                <div class="flex gap-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3.5 rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-500/30 transition">حفظ</button>
                    <button type="button" onclick="closeModal('order-modal')" class="px-8 py-3.5 border border-slate-200 dark:border-slate-700 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold transition">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- STAFF MODAL -->
    <div id="staff-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl fade-in border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white" id="staff-modal-title">إضافة موظف</h3>
            <form onsubmit="saveStaff(event)">
                <input type="hidden" id="staff-id">
                <input type="hidden" id="staff-role">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">الاسم</label>
                    <input type="text" id="staff-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">رقم الهاتف</label>
                    <input type="text" id="staff-phone" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white">
                </div>
                
                <div id="marketer-fields" class="hidden p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl mb-4 border border-emerald-100 dark:border-emerald-900">
                    <label class="block text-sm font-bold text-emerald-800 dark:text-emerald-400 mb-2">نسبة العمولة (%)</label>
                    <input type="number" id="staff-commission" class="w-full bg-white dark:bg-slate-800 border border-emerald-200 dark:border-emerald-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="مثلاً: 10">
                </div>

                <div id="designer-fields" class="hidden p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-4 border border-purple-100 dark:border-purple-900 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-800 dark:text-purple-400 mb-2">التخصص</label>
                        <input type="text" id="staff-specialty" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-purple-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-purple-800 dark:text-purple-400 mb-2">نسبة المصمم (%)</label>
                        <input type="number" id="staff-designer-commission" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-purple-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 dark:text-white" placeholder="مثلاً: 5">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-purple-800 dark:text-purple-400 mb-2">محفظة (كاش)</label>
                        <input type="text" id="staff-wallet" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-purple-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 dark:text-white">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold">حفظ</button>
                    <button type="button" onclick="closeModal('staff-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">إغلاق</button>
                </div>
            </form>
        </div>
    </div>

    <!-- USER MODAL -->
    <div id="user-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white" id="user-modal-title">إضافة مستخدم جديد</h3>
            <form onsubmit="saveUser(event)">
                <input type="hidden" id="user-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">اسم المستخدم</label>
                    <input type="text" id="new-username" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">كلمة المرور <span class="text-xs font-normal text-slate-400">(اتركها فارغة عند التعديل للإبقاء عليها)</span></label>
                    <input type="text" id="new-password" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">صلاحيات الوصول للصفحات</label>
                    <div class="grid grid-cols-2 gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="orders"><span class="text-sm text-slate-600 dark:text-slate-400">الطلبات</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="deliveries"><span class="text-sm text-slate-600 dark:text-slate-400">التسليمات</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="collections"><span class="text-sm text-slate-600 dark:text-slate-400">التحصيلات</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="marketers"><span class="text-sm text-slate-600 dark:text-slate-400">المسوقين</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="designers"><span class="text-sm text-slate-600 dark:text-slate-400">المصممين</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="users"><span class="text-sm text-slate-600 dark:text-slate-400">المستخدمين</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="settings"><span class="text-sm text-slate-600 dark:text-slate-400">الإعدادات</span></label>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">نوع الحساب</label>
                    <select id="new-role" onchange="toggleUserFields()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                        <option value="assistant">مساعد (Assistant)</option>
                        <option value="admin">مدير (Admin)</option>
                        <option value="marketer">مسوق (Marketer)</option>
                        <option value="designer">مصمم (Designer)</option>
                    </select>
                </div>
                
                <div id="user-staff-fields" class="hidden bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800 mb-4">
                    <h4 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-3 border-b dark:border-slate-700 pb-2">بيانات الموظف (سيتم إضافته تلقائياً)</h4>
                    <div class="space-y-3">
                        <input type="text" id="new-user-realname" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white" placeholder="الاسم الحقيقي">
                        <input type="text" id="new-user-phone" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white" placeholder="رقم الهاتف">
                        <input type="number" id="new-user-commission" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white" placeholder="النسبة %">
                        <input type="text" id="new-user-specialty" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white hidden" placeholder="التخصص (للمصممين)">
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-800 dark:bg-slate-700 text-white py-3 rounded-xl hover:bg-slate-900 dark:hover:bg-slate-600 font-bold">حفظ البيانات</button>
                <button type="button" onclick="closeModal('user-modal')" class="w-full mt-2 py-3 text-slate-500 dark:text-slate-400">إلغاء</button>
            </form>
        </div>
    </div>

    <!-- CLIENT MODAL -->
    <div id="client-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white" id="client-modal-title">إضافة عميل VIP</h3>
            <form onsubmit="saveClient(event)">
                <input type="hidden" id="client-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">اسم العميل</label>
                    <input type="text" id="client-modal-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">رقم الهاتف</label>
                    <input type="text" id="client-modal-phone" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">الرصيد الافتتاحي</label>
                    <input type="number" id="client-modal-balance" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" placeholder="0.00">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-orange-600 text-white py-3 rounded-xl hover:bg-orange-700 font-bold">حفظ</button>
                    <button type="button" onclick="closeModal('client-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOPUP MODAL -->
    <div id="topup-modal" class="fixed inset-0 bg-slate-900/80 hidden z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <h3 class="text-xl font-bold mb-4 text-slate-800 dark:text-white">شحن محفظة</h3>
            <p id="topup-client-name" class="text-slate-500 mb-6 font-bold"></p>
            <form onsubmit="saveTopUp(event)">
                <input type="hidden" id="topup-client-id">
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المبلغ المراد إضافته</label>
                <input type="number" id="topup-amount" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 mb-6 font-bold text-lg dark:text-white" required>
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-xl hover:bg-emerald-700 font-bold mb-2">تأكيد الشحن</button>
                <button type="button" onclick="closeModal('topup-modal')" class="w-full py-3 text-slate-500">إلغاء</button>
            </form>
        </div>
    </div>

    <!-- ADJUSTMENT MODAL -->
    <div id="adjustment-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white">إضافة حافز أو خصم</h3>
            <form onsubmit="saveAdjustment(event)">
                <input type="hidden" id="adj-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">الموظف</label>
                    <select id="adj-staff" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" required></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">النوع</label>
                    <select id="adj-type" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                        <option value="bonus">مكافأة (Bonus) +</option>
                        <option value="deduction">خصم (Deduction) -</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المبلغ</label>
                    <input type="number" id="adj-amount" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 font-bold dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">السبب / ملاحظات</label>
                    <input type="text" id="adj-reason" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" placeholder="مثلاً: تأخير، عمل إضافي...">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold">حفظ</button>
                    <button type="button" onclick="closeModal('adjustment-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CLIENT HISTORY MODAL -->
    <div id="client-history-modal" class="fixed inset-0 bg-slate-900/80 hidden z-[70] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-2xl p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">سجل حركات المحفظة</h3>
                    <p id="history-client-name" class="text-sm text-slate-500 dark:text-slate-400 mt-1"></p>
                </div>
                <button onclick="closeModal('client-history-modal')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-right">
                    <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">التاريخ</th>
                            <th class="p-4">النوع</th>
                            <th class="p-4">المبلغ</th>
                            <th class="p-4">التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody id="client-history-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300"></tbody>
                </table>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeModal('client-history-modal')" class="px-6 py-2.5 border border-slate-200 dark:border-slate-700 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- PAYOUT MODAL -->
    <div id="payout-modal" class="fixed inset-0 bg-slate-900/80 hidden z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white">تسجيل دفعة مالية</h3>
            <form onsubmit="savePayout(event)">
                <input type="hidden" id="payout-staff-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">الموظف</label>
                    <input type="text" id="payout-staff-name" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-slate-400" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">المبلغ</label>
                    <input type="number" id="payout-amount" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white font-bold" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">تاريخ الدفع</label>
                    <input type="date" id="payout-date" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ملاحظات</label>
                    <textarea id="payout-notes" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" rows="2" placeholder="أي تفاصيل إضافية..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl hover:bg-emerald-700 font-bold">تسجيل</button>
                    <button type="button" onclick="closeModal('payout-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="report-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl p-8 shadow-2xl fade-in border border-slate-200 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-white">تقرير العمولات الشهري</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">تحليل مالي لأداء المسوقين</p>
                </div>
                <button onclick="closeModal('report-modal')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-6 flex items-center gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                <label class="font-bold text-slate-700 dark:text-slate-300">اختر الشهر:</label>
                <input type="month" id="report-month" onchange="renderReportTable()" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-700 dark:text-white focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>

            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-3 border-r-4 border-emerald-500 pr-3">المسوقين (العمولات)</h4>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">المسوق</th>
                            <th class="p-4">إجمالي المبيعات</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">صافي المستحق (عمولة + حوافز)</th>
                            <th class="p-4 text-blue-600 dark:text-blue-400">محصلة (من المدفوع)</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">تم صرفه</th>
                            <th class="p-4 text-slate-500">ملاحظات الدفع</th>
                            <th class="p-4 text-center">تسجيل دفع</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-900"></tbody>
                    <tfoot class="bg-slate-50 dark:bg-slate-800 font-bold text-slate-800 dark:text-white border-t-2 border-slate-200 dark:border-slate-700">
                        <tr id="report-table-footer"></tr>
                    </tfoot>
                </table>
            </div>

            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-3 mt-8 border-r-4 border-purple-500 pr-3">المصممين (المدفوعات)</h4>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">المصمم</th>
                            <th class="p-4">التخصص</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">صافي المستحق (نسبة + حوافز)</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">تم صرفه (هذا الشهر)</th>
                            <th class="p-4 text-slate-500">ملاحظات الدفع</th>
                            <th class="p-4 text-center">تسجيل دفع</th>
                        </tr>
                    </thead>
                    <tbody id="report-designers-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-900"></tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl hover:bg-slate-900 transition font-bold flex items-center gap-2">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const defaultData = {
            users: [{ id: 1, username: 'admin', password: 'admin', role: 'admin' }],
            staff: [],
            orders: [],
            payouts: [],
            logs: [],
            clients: [],
            adjustments: [],
            settings: [{ 
                appName: 'DM Agency', 
                logoUrl: '', 
                invoiceTerms: '',
                currency: 'ج.م',
                designerLabelS: 'مصمم',
                designerLabelP: 'المصممين',
                serviceTypes: ['سوشيال ميديا', 'غلاف', 'بوستر مراجعة', 'كروت شخصيه', 'صور مصغرة', 'لوجو', 'بانر', 'شهادة', 'منيو'],
                orderSources: ['فيسبوك', 'انستجرام', 'تيك توك', 'جوجل', 'ترشيح', 'واتساب', 'أخرى']
            }]
        };

        let db = { orders: [], staff: [], users: [], payouts: [], logs: [], clients: [], settings: [], adjustments: [] };
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

        // --- HELPERS ---
        function getCurrency() {
            return (db.settings[0] && db.settings[0].currency) ? db.settings[0].currency : 'ج.م';
        }
        function getDesignerLabel(plural = false) {
            const s = (db.settings[0] && db.settings[0].designerLabelS) ? db.settings[0].designerLabelS : 'مصمم';
            const p = (db.settings[0] && db.settings[0].designerLabelP) ? db.settings[0].designerLabelP : 'المصممين';
            return plural ? p : s;
        }

        // --- INIT APP ---
        window.addEventListener('firebase-ready', async () => {
            try {
                const cloudData = await window.firebaseAPI.loadData();
                // Merge with default if empty (first run)
                if (cloudData.users.length === 0) {
                    db = JSON.parse(JSON.stringify(defaultData));
                    // Save default admin to cloud
                    window.firebaseAPI.save('users', db.users[0].id, db.users[0]);
                    window.firebaseAPI.save('settings', 'global', db.settings[0]);
                } else {
                    db = cloudData;
                    // Migration for existing data (add serviceTypes if missing)
                    if (!db.settings || db.settings.length === 0) db.settings = [JSON.parse(JSON.stringify(defaultData.settings[0]))];
                    if (!db.settings[0].serviceTypes) {
                        db.settings[0].serviceTypes = defaultData.settings[0].serviceTypes;
                        window.firebaseAPI.save('settings', 'global', db.settings[0]);
                    }
                    if (!db.settings[0].orderSources) {
                        db.settings[0].orderSources = defaultData.settings[0].orderSources;
                        window.firebaseAPI.save('settings', 'global', db.settings[0]);
                    }
                }
                
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => document.getElementById('loading-screen').remove(), 500);
                
                applyAppSettings();
                checkAuth();
            } catch (e) {
                console.error(e);
            }
        });

        // Chart Instances
        let statusChartInstance = null;
        let marketerChartInstance = null;
        let revenueChartInstance = null;
        let designerChartInstance = null;
        let sourceChartInstance = null;

        // Dark Mode Logic
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            // Fix Chart.js colors on toggle
            if(Chart.defaults) {
                Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
                Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0';
            }
            if(currentUser) renderCharts(); // Re-render charts to update colors
        }
        
        // Init Dark Mode
        if(localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        // Date Display
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // --- AUTH ---
        function checkAuth() {
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            
            if (currentUser) {
                loginScreen.classList.add('hidden-section');
                dashboardScreen.classList.remove('hidden-section');
                
                document.getElementById('user-name-display').innerText = currentUser.username;
                document.getElementById('user-avatar').innerText = currentUser.username.charAt(0).toUpperCase();
                
                initDashboard();
            } else {
                loginScreen.classList.remove('hidden-section');
                dashboardScreen.classList.add('hidden-section');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const user = db.users.find(usr => usr.username === u && usr.password === p);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                checkAuth();
                showNotification('تم تسجيل الدخول بنجاح', 'success');
            } else {
                showNotification('خطأ في البيانات', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            checkAuth();
        }

        // --- DASHBOARD ---
        function initDashboard() {
            // Set default month for charts
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7);
            const chartFilter = document.getElementById('chart-month-filter');
            if(chartFilter && !chartFilter.value) chartFilter.value = monthStr;

            renderOrders();
            renderStats();
            applyPermissions();
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'text-white'));
            document.getElementById('nav-orders').classList.add('bg-slate-800', 'text-white');
        }

        function switchTab(tabName) {
            // Permission Check
            if (currentUser.role !== 'admin' && currentUser.permissions && !currentUser.permissions.includes(tabName)) {
                showNotification('ليس لديك صلاحية للوصول لهذه الصفحة', 'error');
                return;
            }

            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('bg-slate-800', 'text-white');
                el.classList.add('text-slate-300');
            });

            document.getElementById(`tab-${tabName}`).classList.remove('hidden-section');
            document.getElementById(`nav-${tabName}`).classList.add('bg-slate-800', 'text-white');
            document.getElementById(`nav-${tabName}`).classList.remove('text-slate-300');

            document.getElementById('page-title').innerText = document.getElementById(`nav-${tabName}`).innerText.trim();
            
            if(tabName === 'orders') {
                document.getElementById('stats-overview').classList.remove('hidden');
                document.getElementById('charts-area').classList.remove('hidden');
            } else {
                document.getElementById('stats-overview').classList.add('hidden');
                document.getElementById('charts-area').classList.add('hidden');
            }
            
            if(tabName === 'marketers') renderMarketers();
            if(tabName === 'collections') renderCollections();
            if(tabName === 'deliveries') renderDeliveries();
            if(tabName === 'designers') renderDesigners();
            if(tabName === 'users') renderUsers();
            if(tabName === 'settings') { renderLogs(); renderSettingsServiceTypes(); renderSettingsSources(); }
            if(tabName === 'my-tasks') renderMyTasks();
            if(tabName === 'profile') renderProfile();
        }

        function applyPermissions() {
            const allTabs = ['orders', 'deliveries', 'collections', 'marketers', 'designers', 'users', 'settings', 'clients', 'adjustments', 'my-tasks', 'profile'];
            
            if (currentUser.role === 'admin') {
                allTabs.forEach(t => document.getElementById('nav-' + t)?.classList.remove('hidden'));
            } else {
                const perms = currentUser.permissions || [];
                // Auto-permissions based on role
                if(currentUser.role === 'designer') {
                    perms.push('my-tasks', 'profile');
                }
                if(currentUser.role === 'marketer') {
                    perms.push('profile', 'orders');
                }

                allTabs.forEach(t => {
                    const el = document.getElementById('nav-' + t);
                    if(perms.includes(t)) el?.classList.remove('hidden');
                    else el?.classList.add('hidden');
                });
            }
        }

        function toggleMobileMenu() {
            document.getElementById('sidebar-nav').classList.toggle('hidden');
        }

        // --- SETTINGS LOGIC ---
        function applyAppSettings() {
            const settings = (db.settings && db.settings.length > 0) ? db.settings[0] : defaultData.settings[0];
            if(settings) {
                if(settings.appName) {
                    document.title = settings.appName;
                    const sidebarTitle = document.getElementById('sidebar-title');
                    const loginTitle = document.getElementById('login-title');
                    if(sidebarTitle) sidebarTitle.innerText = settings.appName;
                    if(loginTitle) loginTitle.innerText = settings.appName;
                }
                
                // Update Sidebar & Static Texts
                const navDesigners = document.getElementById('nav-designers');
                if(navDesigners) navDesigners.innerHTML = `<span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-palette"></i></span> ${getDesignerLabel(true)}`;
                
                const chartTitle = document.getElementById('chart-title-designers');
                if(chartTitle) chartTitle.innerText = `أداء ${getDesignerLabel(true)} (عدد التصاميم المكتملة)`;

                // Update Inputs in Settings
                if(document.getElementById('setting-currency')) {
                    document.getElementById('setting-currency').value = settings.currency || 'ج.م';
                    document.getElementById('setting-designer-label-s').value = settings.designerLabelS || 'مصمم';
                    document.getElementById('setting-designer-label-p').value = settings.designerLabelP || 'المصممين';
                }
            }
        }

        function renderSettingsServiceTypes() {
            const container = document.getElementById('settings-services-list');
            container.innerHTML = '';
            const types = (db.settings[0] && db.settings[0].serviceTypes) ? db.settings[0].serviceTypes : defaultData.settings[0].serviceTypes;
            
            types.forEach((type, index) => {
                container.innerHTML += `
                    <div class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-200">
                        ${type}
                        <button onclick="deleteServiceType(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                    </div>
                `;
            });
        }

        function addServiceType() {
            const input = document.getElementById('new-service-type');
            const val = input.value.trim();
            if(!val) return;
            
            if(!db.settings[0].serviceTypes) db.settings[0].serviceTypes = [];
            db.settings[0].serviceTypes.push(val);
            
            window.firebaseAPI.save('settings', 'global', db.settings[0]);
            input.value = '';
            renderSettingsServiceTypes();
            showNotification('تم إضافة نوع المشروع', 'success');
        }

        function deleteServiceType(index) {
            if(!confirm('هل أنت متأكد من حذف هذا النوع؟')) return;
            
            if(db.settings[0].serviceTypes) {
                db.settings[0].serviceTypes.splice(index, 1);
                window.firebaseAPI.save('settings', 'global', db.settings[0]);
                renderSettingsServiceTypes();
            }
        }

        // --- SOURCES SETTINGS ---
        function renderSettingsSources() {
            const container = document.getElementById('settings-sources-list');
            container.innerHTML = '';
            const sources = (db.settings[0] && db.settings[0].orderSources) ? db.settings[0].orderSources : defaultData.settings[0].orderSources;
            
            sources.forEach((source, index) => {
                container.innerHTML += `
                    <div class="bg-pink-50 dark:bg-pink-900/20 border border-pink-100 dark:border-pink-900 px-3 py-1 rounded-lg flex items-center gap-2 text-sm font-bold text-pink-700 dark:text-pink-400">
                        ${source}
                        <button onclick="deleteSource(${index})" class="text-pink-400 hover:text-pink-600"><i class="fas fa-times"></i></button>
                    </div>
                `;
            });
        }

        function addSource() {
            const input = document.getElementById('new-source-type');
            const val = input.value.trim();
            if(!val) return;
            
            if(!db.settings[0].orderSources) db.settings[0].orderSources = [];
            db.settings[0].orderSources.push(val);
            
            window.firebaseAPI.save('settings', 'global', db.settings[0]);
            input.value = '';
            renderSettingsSources();
            showNotification('تم إضافة المصدر', 'success');
        }

        function deleteSource(index) {
            if(!confirm('هل أنت متأكد من حذف هذا المصدر؟')) return;
            
            if(db.settings[0].orderSources) {
                db.settings[0].orderSources.splice(index, 1);
                window.firebaseAPI.save('settings', 'global', db.settings[0]);
                renderSettingsSources();
            }
        }

        // --- ORDERS LOGIC ---
        function renderOrders() {
            const tbody = document.getElementById('orders-table-body');
            const search = document.getElementById('search-orders').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;
            const filterDate = document.getElementById('filter-date').value;
            const emptyState = document.getElementById('empty-orders-state');
            
            tbody.innerHTML = '';

            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

            const filteredOrders = db.orders.filter(order => {
                const matchesSearch = order.client.toLowerCase().includes(search) || order.phone.includes(search);
                const matchesStatus = filterStatus === 'all' || order.status === filterStatus;
                
                let matchesDate = true;
                const orderDate = new Date(order.dateCreated);
                if(filterDate === 'today') matchesDate = orderDate.toDateString() === new Date().toDateString();
                if(filterDate === 'week') matchesDate = orderDate >= startOfWeek;
                if(filterDate === 'month') matchesDate = orderDate >= startOfMonth;

                return matchesSearch && matchesStatus && matchesDate;
            }).sort((a, b) => b.id - a.id);

            if (filteredOrders.length === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            filteredOrders.forEach(order => {
                const marketer = db.staff.find(s => s.id == order.marketerId)?.name || '<span class="text-slate-400">مباشر</span>';
                const designer = db.staff.find(s => s.id == order.designerId)?.name || '<span class="text-slate-400">---</span>';
                
                let statusBadge = '';
                if(order.status === 'pending') statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400">⏳ قيد التنفيذ</span>';
                else if(order.status === 'done') statusBadge = '<span class="status-badge bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">✅ مكتمل</span>';
                else if(order.status === 'rejected') statusBadge = '<span class="status-badge bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">❌ مرفوض</span>';
                else statusBadge = '<span class="status-badge bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">👀 مراجعة</span>';

                const depositBadge = order.deposit 
                    ? '<span class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 flex items-center justify-center mx-auto"><i class="fas fa-check"></i></span>' 
                    : '<span class="w-8 h-8 rounded-full bg-slate-100 text-slate-300 dark:bg-slate-700 dark:text-slate-500 flex items-center justify-center mx-auto"><i class="fas fa-times"></i></span>';

                let rowClass = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                
                if (order.deliveryDate && order.status !== 'done' && order.status !== 'rejected') {
                    const now = new Date();
                    const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                    const tmrw = new Date(now);
                    tmrw.setDate(tmrw.getDate() + 1);
                    const tomorrow = tmrw.getFullYear() + '-' + String(tmrw.getMonth() + 1).padStart(2, '0') + '-' + String(tmrw.getDate()).padStart(2, '0');

                    if (order.deliveryDate < today) rowClass = "bg-red-100/60 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 transition border-b border-red-200 dark:border-red-800 last:border-0";
                    else if (order.deliveryDate === today) rowClass = "bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/20 transition border-b border-red-100 dark:border-red-900/30 last:border-0";
                    else if (order.deliveryDate === tomorrow) rowClass = "bg-orange-50 hover:bg-orange-100 dark:bg-orange-900/10 dark:hover:bg-orange-900/20 transition border-b border-orange-100 dark:border-orange-900/30 last:border-0";
                }

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="p-5" data-label="العميل">
                        <div>
                            <div class="font-bold text-slate-800 dark:text-slate-100">${order.client}</div>
                            <div class="text-xs text-slate-400 font-mono mt-1">${order.phone}</div>
                            ${order.source ? `<div class="text-[10px] text-pink-500 font-bold mt-0.5"><i class="fas fa-share-alt"></i> ${order.source}</div>` : ''}
                        </div>
                    </td>
                    <td class="p-5" data-label="الخدمة">
                        <span class="bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 px-2 py-1 rounded text-xs font-bold">${order.service}</span>
                        ${order.deliveryDate ? `<div class="text-xs text-slate-500 mt-1"><i class="fas fa-calendar-alt ml-1"></i> ${order.deliveryDate}</div>` : ''}
                        ${order.designNotes ? `<div class="text-[10px] text-slate-500 mt-1 bg-slate-50 dark:bg-slate-800 p-1 rounded border border-slate-100 dark:border-slate-700 truncate max-w-[150px]" title="${order.designNotes}"><i class="fas fa-sticky-note text-yellow-500"></i> ${order.designNotes}</div>` : ''}
                        ${order.privateNotes ? `<div class="text-[10px] text-red-500 mt-1 bg-red-50 dark:bg-red-900/20 p-1 rounded border border-red-100 dark:border-red-800 truncate max-w-[150px]" title="${order.privateNotes}"><i class="fas fa-lock"></i> ${order.privateNotes}</div>` : ''}
                        ${order.designLink ? `<a href="${order.designLink}" target="_blank" class="text-[10px] text-blue-500 hover:underline mt-1 block"><i class="fas fa-link"></i> رابط الملفات</a>` : ''}
                    </td>
                    <td class="p-5" data-label="المالية">
                        <div>
                            <div class="font-bold text-slate-800 dark:text-slate-200">${parseFloat(order.price).toLocaleString()} ${getCurrency()}</div>
                            ${(order.price - order.paid) > 0 ? `<div class="text-xs text-red-500 font-bold mt-1">مديونية: ${(order.price - order.paid)}</div>` : '<div class="text-xs text-emerald-500 font-bold mt-1">خالص</div>'}
                        </div>
                    </td>
                    <td class="p-5 text-center" data-label="العربون">${depositBadge}</td>
                    <td class="p-5" data-label="الفريق">
                        <div class="text-xs text-slate-500 dark:text-slate-400 mb-1"><i class="fas fa-bullhorn w-4"></i> ${marketer}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400"><i class="fas fa-paint-brush w-4"></i> ${designer}</div>
                    </td>
                    <td class="p-5" data-label="الحالة">${statusBadge}</td>
                    <td class="p-5 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editOrder(${order.id})" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="printInvoice(${order.id})" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400 hover:bg-slate-200 transition" title="طباعة فاتورة"><i class="fas fa-print"></i></button>
                            <button onclick="copyOrderDetails(${order.id})" class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 hover:bg-purple-100 transition" title="نسخ التفاصيل"><i class="fas fa-copy"></i></button>
                            <button onclick="sendWhatsApp(${order.id})" class="w-8 h-8 rounded-lg bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400 hover:bg-green-100 transition" title="إرسال واتساب"><i class="fab fa-whatsapp"></i></button>
                            ${currentUser.role === 'admin' ? `<button onclick="deleteOrder(${order.id})" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 dark:bg-red-900/30 dark:text-red-400 hover:bg-red-100 transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterToday() {
            document.getElementById('filter-date').value = 'today';
            renderOrders();
        }

        function updateStatusSelect(val) {
            document.getElementById('order-status').value = val;
        }

        function toggleVipMode() {
            const isVip = document.getElementById('is-vip-order').checked;
            const selectionDiv = document.getElementById('vip-selection');
            if(isVip) {
                selectionDiv.classList.remove('hidden');
                const select = document.getElementById('vip-client-select');
                select.innerHTML = '<option value="">-- اختر العميل --</option>';
                db.clients.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name} (رصيد: ${c.balance} ${getCurrency()})</option>`;
                });
            } else {
                selectionDiv.classList.add('hidden');
                document.getElementById('client-name').readOnly = false;
                document.getElementById('client-phone').readOnly = false;
            }
        }

        function selectVipClient() {
            const clientId = document.getElementById('vip-client-select').value;
            const client = db.clients.find(c => c.id == clientId);
            if(client) {
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-phone').value = client.phone;
                document.getElementById('vip-balance-display').innerText = `الرصيد الحالي: ${client.balance} ${getCurrency()}`;
            }
        }

        function toggleUserFields() {
            const role = document.getElementById('new-role').value;
            const fields = document.getElementById('user-staff-fields');
            const specialty = document.getElementById('new-user-specialty');
            
            if(role === 'marketer' || role === 'designer') fields.classList.remove('hidden');
            else fields.classList.add('hidden');

            if(role === 'designer') specialty.classList.remove('hidden');
            else specialty.classList.add('hidden');
        }

        function saveOrder(e) {
            e.preventDefault();
            const id = document.getElementById('order-id').value;
            const currentTimestamp = Date.now();
            const orderId = id ? id : currentTimestamp; // Use existing ID or generate new one for linking
            const statusRadio = document.querySelector('input[name="status-radio"]:checked').value;
            let newOrder = {
                client: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                source: document.getElementById('order-source').value,
                service: document.getElementById('service-type').value,
                deliveryDate: document.getElementById('delivery-date').value,
                designLink: document.getElementById('design-link').value,
                designNotes: document.getElementById('design-notes').value,
                privateNotes: document.getElementById('private-notes').value,
                price: parseFloat(document.getElementById('order-price').value) || 0,
                paid: parseFloat(document.getElementById('amount-paid').value) || 0,
                deposit: document.getElementById('deposit-paid').checked,
                marketerId: document.getElementById('order-marketer').value,
                designerId: document.getElementById('order-designer').value,
                status: statusRadio
            };

            // VIP Logic
            const isVip = document.getElementById('is-vip-order').checked;
            if(isVip && !id) { // Only apply wallet deduction on new orders to avoid double deduction
                const vipClientId = document.getElementById('vip-client-select').value;
                const client = db.clients.find(c => c.id == vipClientId);
                if(client) {
                    if(client.balance < newOrder.price) {
                        alert('رصيد العميل غير كافي!');
                        return;
                    }
                    // Deduct from wallet
                    client.balance -= newOrder.price;
                    
                    // Add Transaction Record
                    if(!client.transactions) client.transactions = [];
                    client.transactions.unshift({
                        id: Date.now(),
                        type: 'payment',
                        amount: newOrder.price,
                        date: Date.now(),
                        details: `دفع تكلفة طلب خدمة: ${newOrder.service}`,
                        orderId: orderId
                    });

                    newOrder.paid = newOrder.price; // Mark as fully paid
                    newOrder.deposit = false; // Full payment
                    window.firebaseAPI.save('clients', client.id, client); // Update client balance
                    logActivity('خصم محفظة', `تم خصم ${newOrder.price} من محفظة العميل ${client.name}`);
                }
            }

            let dateCreated = Date.now();
            let dateAssigned = null;

            if (id) {
                const index = db.orders.findIndex(o => o.id == id);
                const existing = db.orders[index];
                dateCreated = existing.dateCreated;
                dateAssigned = existing.dateAssigned;
                if ((!existing.designerId && newOrder.designerId) || (existing.designerId && newOrder.designerId && existing.designerId != newOrder.designerId)) {
                    dateAssigned = Date.now();
                }
                db.orders[index] = { ...existing, ...newOrder, dateAssigned };
                window.firebaseAPI.save('orders', id, db.orders[index]); // Save to Cloud
                logActivity('تعديل طلب', `تم تعديل بيانات الطلب #${id} للعميل ${newOrder.client}`);
            } else {
                if (newOrder.designerId) dateAssigned = Date.now();
                const newId = orderId; // Use the ID we generated above
                const fullOrder = { id: newId, ...newOrder, dateCreated, dateAssigned };
                db.orders.push(fullOrder);
                window.firebaseAPI.save('orders', newId, fullOrder); // Save to Cloud
                logActivity('إضافة طلب', `تم إضافة طلب جديد #${newId} للعميل ${newOrder.client}`);
            }

            saveDB();
            closeModal('order-modal');
            renderOrders();
            showNotification('تم الحفظ', 'success');
        }

        function editOrder(id) {
            const order = db.orders.find(o => o.id == id);
            if (!order) return;

            populateStaffSelects();
            document.getElementById('order-id').value = order.id;
            document.getElementById('client-name').value = order.client;
            document.getElementById('client-phone').value = order.phone;
            document.getElementById('order-source').value = order.source || '';
            document.getElementById('service-type').value = order.service;
            document.getElementById('delivery-date').value = order.deliveryDate || '';
            document.getElementById('design-link').value = order.designLink || '';
            document.getElementById('design-notes').value = order.designNotes || '';
            document.getElementById('private-notes').value = order.privateNotes || '';
            document.getElementById('order-price').value = order.price;
            document.getElementById('amount-paid').value = order.paid;
            document.getElementById('deposit-paid').checked = order.deposit;
            document.getElementById('order-marketer').value = order.marketerId || "";
            document.getElementById('order-designer').value = order.designerId || "";
            
            const radios = document.getElementsByName('status-radio');
            radios.forEach(r => { if(r.value === order.status) r.checked = true; });
            document.getElementById('order-status').value = order.status;

            calculateRemaining();
            calculateOrderCommission();
            document.getElementById('modal-title').innerText = "تعديل الطلب";
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function deleteOrder(id) {
            if(confirm('حذف هذا الطلب؟')) {
                const order = db.orders.find(o => o.id == id);
                db.orders = db.orders.filter(o => o.id != id);
                window.firebaseAPI.delete('orders', id); // Delete from Cloud
                saveDB(); renderOrders();
                logActivity('حذف طلب', `تم حذف الطلب #${id} للعميل ${order ? order.client : 'غير معروف'}`);
                showNotification('تم الحذف', 'warning');
            }
        }

        function calculateRemaining() {
            const price = parseFloat(document.getElementById('order-price').value) || 0;
            const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
            const rem = price - paid;
            const el = document.getElementById('amount-remaining');
            el.value = rem.toFixed(2);
            if(rem <= 0) { el.classList.remove('text-red-600', 'bg-red-50'); el.classList.add('text-emerald-600', 'bg-emerald-50'); }
            else { el.classList.add('text-red-600', 'bg-red-50'); el.classList.remove('text-emerald-600', 'bg-emerald-50'); }
        }

        function calculateOrderCommission() {
            const marketerId = document.getElementById('order-marketer').value;
            const price = parseFloat(document.getElementById('order-price').value) || 0;
            const displayEl = document.getElementById('order-commission-preview');
            
            if(!marketerId) {
                displayEl.classList.add('hidden');
                return;
            }

            const marketer = db.staff.find(s => s.id == marketerId);
            if(marketer && marketer.commission) {
                const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
                const totalComm = (price * parseFloat(marketer.commission)) / 100;
                const currentComm = (paid * parseFloat(marketer.commission)) / 100;
                displayEl.innerHTML = `<i class="fas fa-coins ml-1"></i> عمولة حالية (من العربون/المدفوع): ${currentComm.toLocaleString()} ${getCurrency()} <span class="text-slate-400">| الكلية: ${totalComm.toLocaleString()}</span>`;
                displayEl.classList.remove('hidden');
            } else {
                displayEl.classList.add('hidden');
            }
        }

        // --- DELIVERIES LOGIC ---
        function renderDeliveries() {
            const tbody = document.getElementById('deliveries-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-deliveries').value.toLowerCase();

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            // Filter orders that have a delivery date and are not rejected
            // Sort by delivery date ascending (earliest first)
            const deliveryOrders = db.orders
                .filter(o => o.deliveryDate && o.status !== 'rejected' && (o.status !== 'done' || o.deliveryDate === todayStr) &&
                             (o.client.toLowerCase().includes(search) || o.service.toLowerCase().includes(search))
                )
                .sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));

            // Stats Calculation
            const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1);
            const tmrwStr = tmrw.toISOString().split('T')[0];

            let todayCount = 0;
            let tmrwCount = 0;
            let lateCount = 0;

            deliveryOrders.forEach(order => {
                if (order.deliveryDate === todayStr) todayCount++;
                else if (order.deliveryDate === tmrwStr) tmrwCount++;
                else if (order.deliveryDate < todayStr) lateCount++;

                const designer = db.staff.find(s => s.id == order.designerId)?.name || '<span class="text-slate-400">---</span>';
                const remaining = order.price - order.paid;
                
                let dateClass = "text-slate-700 dark:text-slate-300";
                let dateIcon = "fa-calendar-alt";
                if (order.deliveryDate < todayStr) { dateClass = "text-red-600 font-bold"; dateIcon = "fa-exclamation-circle"; }
                else if (order.deliveryDate === todayStr) { dateClass = "text-indigo-600 font-bold"; dateIcon = "fa-star"; }
                else if (order.deliveryDate === tmrwStr) { dateClass = "text-orange-500 font-bold"; dateIcon = "fa-clock"; }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="p-5">
                        <div class="${dateClass} flex items-center gap-2">
                            <i class="fas ${dateIcon}"></i>
                            <span dir="ltr">${order.deliveryDate}</span>
                        </div>
                    </td>
                    <td class="p-5 font-bold">${order.client}</td>
                    <td class="p-5"><span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs">${order.service}</span></td>
                    <td class="p-5 ${remaining > 0 ? 'text-red-500 font-bold' : 'text-emerald-500'}">${remaining > 0 ? remaining.toLocaleString() + ' ' + getCurrency() : 'خالص'}</td>
                    <td class="p-5 text-sm">${designer}</td>
                    <td class="p-5">
                        <span class="px-2 py-1 rounded text-xs font-bold ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : (order.status === 'done' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700')}">
                            ${order.status === 'pending' ? 'قيد التنفيذ' : (order.status === 'done' ? 'مكتمل' : 'مراجعة')}
                        </span>
                    </td>
                    <td class="p-5 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editOrder(${order.id})" class="text-blue-500 hover:text-blue-700 transition" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button onclick="sendDeliveryWhatsApp(${order.id})" class="text-green-500 hover:text-green-700 transition" title="إرسال واتساب (تسليم)"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('del-today-count').innerText = todayCount;
            document.getElementById('del-tmrw-count').innerText = tmrwCount;
            document.getElementById('del-late-count').innerText = lateCount;

            if(deliveryOrders.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">لا توجد تسليمات قادمة</td></tr>';
        }

        // --- COLLECTIONS LOGIC ---
        function renderCollections() {
            const tbody = document.getElementById('collections-table-body');
            const tfoot = document.getElementById('collections-table-footer');
            const search = document.getElementById('search-collections').value.toLowerCase();
            tbody.innerHTML = '';
            
            let totalPrices = 0;
            let totalPaid = 0;
            let totalDebt = 0;

            const sortedOrders = db.orders
                .filter(o => o.client.toLowerCase().includes(search) || o.id.toString().includes(search))
                .sort((a, b) => b.dateCreated - a.dateCreated);

            sortedOrders.forEach(order => {
                const remaining = order.price - order.paid;
                totalPrices += parseFloat(order.price);
                totalPaid += parseFloat(order.paid);
                totalDebt += remaining;

                let statusText = '';
                let statusColor = '';
                if(order.status === 'pending') { statusText = 'قيد التنفيذ'; statusColor = 'text-yellow-600'; }
                else if(order.status === 'done') { statusText = 'مكتمل'; statusColor = 'text-emerald-600'; }
                else if(order.status === 'rejected') { statusText = 'مرفوض'; statusColor = 'text-red-600'; }
                else { statusText = 'مراجعة'; statusColor = 'text-blue-600'; }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="p-5 font-mono text-slate-500">#${order.id}</td>
                    <td class="p-5 font-bold text-slate-800 dark:text-slate-200">${order.client}</td>
                    <td class="p-5"><span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs">${order.service}</span></td>
                    <td class="p-5 font-bold">${parseFloat(order.price).toLocaleString()} ${getCurrency()}</td>
                    <td class="p-5 text-emerald-600 font-bold">${parseFloat(order.paid).toLocaleString()} ${getCurrency()}</td>
                    <td class="p-5 font-bold ${remaining > 0 ? 'text-red-500' : 'text-slate-400'}">${remaining > 0 ? remaining.toLocaleString() + ' ' + getCurrency() : '-'}</td>
                    <td class="p-5 font-bold ${statusColor}">${statusText}</td>
                `;
                tbody.appendChild(tr);
            });

            tfoot.innerHTML = `
                <tr>
                    <td colspan="3" class="p-5 text-left">الإجماليات</td>
                    <td class="p-5">${totalPrices.toLocaleString()} ${getCurrency()}</td>
                    <td class="p-5 text-emerald-600">${totalPaid.toLocaleString()} ${getCurrency()}</td>
                    <td class="p-5 text-red-500">${totalDebt.toLocaleString()} ${getCurrency()}</td>
                    <td></td>
                </tr>
            `;
        }

        // --- DESIGNERS ---
        function renderDesigners() {
            const container = document.getElementById('designers-grid');
            
            // Update Header Buttons/Inputs dynamically
            const addBtn = document.querySelector('#tab-designers button');
            if(addBtn) addBtn.innerHTML = `<i class="fas fa-plus"></i> إضافة ${getDesignerLabel()}`;
            const searchInp = document.getElementById('search-designers');
            if(searchInp) searchInp.placeholder = `بحث عن ${getDesignerLabel()}...`;

            container.innerHTML = '';
            const search = document.getElementById('search-designers').value.toLowerCase();
            
            db.staff.filter(s => s.type === 'designer' && (s.name.toLowerCase().includes(search) || s.specialty.toLowerCase().includes(search))).forEach(d => {
                const activeTasks = db.orders.filter(o => o.designerId == d.id && (o.status === 'pending' || o.status === 'review'));
                const completedTasks = db.orders.filter(o => o.designerId == d.id && o.status === 'done');
                
                // Calculate Earnings
                const totalCompletedPrice = completedTasks.reduce((sum, o) => sum + parseFloat(o.price), 0);
                const earnings = (totalCompletedPrice * (parseFloat(d.commission) || 0)) / 100;

                let tasksHtml = '';
                if(activeTasks.length > 0) {
                    tasksHtml = '<div class="space-y-4 mt-4">';
                    activeTasks.forEach(t => {
                        const now = Date.now();
                        const timeElapsed = t.dateAssigned ? (now - t.dateAssigned) : 0;
                        const hoursElapsed = timeElapsed / (1000 * 60 * 60);
                        const percent = Math.min((hoursElapsed / 24) * 100, 100);
                        let colorClass = 'bg-emerald-500';
                        if(percent > 50) colorClass = 'bg-yellow-500';
                        if(percent > 90) colorClass = 'bg-red-500';

                        tasksHtml += `
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-sm text-slate-700 dark:text-slate-200">${t.client}</span>
                                    <span class="text-xs bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 px-2 py-0.5 rounded">${t.service}</span>
                                </div>
                                <div class="progress-bar-container bg-slate-200 dark:bg-slate-700">
                                    <div class="progress-bar-fill ${colorClass}" style="width: ${percent}%"></div>
                                </div>
                                <div class="flex justify-between mt-1 text-[10px] font-bold text-slate-400">
                                    <span>مرّ ${Math.floor(hoursElapsed)}س</span>
                                    <span>24س</span>
                                </div>
                            </div>
                        `;
                    });
                    tasksHtml += '</div>';
                } else {
                    tasksHtml = `<div class="text-center py-4 text-slate-400 text-sm">لا مهام نشطة</div>`;
                }

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 flex items-center justify-center text-xl font-bold">${d.name.charAt(0)}</div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 dark:text-white">${d.name}</h3>
                                <p class="text-purple-600 dark:text-purple-400 text-sm">${d.specialty}</p>
                                <p class="text-xs text-slate-500 mt-1">نسبة: ${d.commission || 0}% | أرباح: ${earnings.toLocaleString()} ${getCurrency()}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editStaff(${d.id})" class="text-slate-300 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                            ${currentUser.role === 'admin' ? `<button onclick="deleteStaff(${d.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <div class="bg-slate-50 dark:bg-slate-700 p-2 rounded-xl text-center"><div class="text-lg font-bold text-purple-600 dark:text-purple-400">${activeTasks.length}</div><div class="text-xs text-slate-400">جاري</div></div>
                        <div class="bg-slate-50 dark:bg-slate-700 p-2 rounded-xl text-center"><div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${completedTasks.length}</div><div class="text-xs text-slate-400">منجز</div></div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">${tasksHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        // --- MARKETERS ---
        function renderMarketers() {
            const container = document.getElementById('marketers-grid');
            container.innerHTML = '';
            const search = document.getElementById('search-marketers').value.toLowerCase();
            
            db.staff.filter(s => s.type === 'marketer' && (s.name.toLowerCase().includes(search) || s.phone.includes(search))).forEach(m => {
                const mOrders = db.orders.filter(o => o.marketerId == m.id && o.status !== 'rejected');
                const totalSales = mOrders.reduce((sum, o) => sum + parseFloat(o.price), 0);
                const totalPaid = mOrders.reduce((sum, o) => sum + parseFloat(o.paid), 0);
                // Commission based on COLLECTED amounts (Deposits + Full Payments)
                const commissionVal = (totalPaid * (parseFloat(m.commission) || 0)) / 100;

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover relative overflow-hidden";
                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-green-600"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-bold text-xl text-slate-800 dark:text-white">${m.name}</h3>
                            <p class="text-sm text-slate-500">${m.phone}</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-bold px-3 py-1 rounded-lg text-sm">%${m.commission}</div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">الطلبات</span>
                            <span class="font-bold text-slate-800 dark:text-white">${mOrders.length}</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">المبيعات</span>
                            <span class="font-bold text-slate-800 dark:text-white">${totalSales.toLocaleString()} ${getCurrency()}</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">التحصيلات (عربون/كامل)</span>
                            <span class="font-bold text-emerald-600 dark:text-emerald-400">${totalPaid.toLocaleString()} ${getCurrency()}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-emerald-600 text-white rounded-xl shadow-lg mt-2">
                            <span class="font-bold text-emerald-100">العمولة</span>
                            <span class="font-bold text-xl">${commissionVal.toLocaleString()} ${getCurrency()}</span>
                        </div>
                    </div>
                    <div class="absolute top-4 left-4 flex gap-2">
                        <button onclick="editStaff(${m.id})" class="text-slate-300 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteStaff(${m.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- ADJUSTMENTS LOGIC ---
        function renderAdjustments() {
            const tbody = document.getElementById('adjustments-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-adjustments').value.toLowerCase();
            
            const list = (db.adjustments || []).sort((a,b) => b.date - a.date);
            
            list.forEach(adj => {
                const staff = db.staff.find(s => s.id == adj.staffId);
                if(staff && staff.name.toLowerCase().includes(search)) {
                    const isBonus = adj.type === 'bonus';
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">
                            <td class="p-4 text-slate-500 text-xs font-mono">${new Date(adj.date).toLocaleDateString('ar-EG')}</td>
                            <td class="p-4 font-bold text-slate-800 dark:text-white">${staff.name}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${isBonus ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${isBonus ? 'مكافأة' : 'خصم'}</span></td>
                            <td class="p-4 font-bold ${isBonus ? 'text-emerald-600' : 'text-red-600'}">${parseFloat(adj.amount).toLocaleString()} ${getCurrency()}</td>
                            <td class="p-4 text-slate-600 dark:text-slate-300 text-sm">${adj.reason}</td>
                            <td class="p-4 text-center">
                                <button onclick="deleteAdjustment(${adj.id})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }
            });
            if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">لا توجد بيانات</td></tr>';
        }

        function saveAdjustment(e) {
            e.preventDefault();
            const staffId = document.getElementById('adj-staff').value;
            const type = document.getElementById('adj-type').value;
            const amount = parseFloat(document.getElementById('adj-amount').value);
            const reason = document.getElementById('adj-reason').value;
            
            const newAdj = {
                id: Date.now(),
                staffId,
                type,
                amount,
                reason,
                date: Date.now()
            };
            
            if(!db.adjustments) db.adjustments = [];
            db.adjustments.push(newAdj);
            window.firebaseAPI.save('adjustments', newAdj.id, newAdj);
            saveDB(); closeModal('adjustment-modal'); renderAdjustments();
        }

        function deleteAdjustment(id) {
            if(confirm('حذف هذا السجل؟')) {
                db.adjustments = db.adjustments.filter(a => a.id != id);
                window.firebaseAPI.delete('adjustments', id);
                saveDB(); renderAdjustments();
            }
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "agency_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
            showNotification('تم تحميل النسخة', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.users && json.orders) {
                        if(confirm('استبدال البيانات؟')) {
                            db = json; saveDB(); location.reload();
                        }
                    } else showNotification('ملف غير صالح', 'error');
                } catch(err) { showNotification('خطأ في الملف', 'error'); }
            };
            reader.readAsText(file);
        }
        
        function changePassword(e) {
            e.preventDefault();
            const newPass = document.getElementById('new-system-password').value;
            if(!newPass) return;
            
            if(currentUser) {
                const userIdx = db.users.findIndex(u => u.id === currentUser.id);
                if(userIdx !== -1) {
                    db.users[userIdx].password = newPass;
                    currentUser.password = newPass;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    window.firebaseAPI.save('users', currentUser.id, db.users[userIdx]); // Save to Cloud
                    saveDB();
                    showNotification('تم تغيير كلمة المرور بنجاح', 'success');
                    document.getElementById('new-system-password').value = '';
                }
            }
        }

        function resetSystem() {
            if(confirm('هل أنت متأكد تماماً؟ سيتم حذف جميع الطلبات والمدفوعات لبدء موسم جديد! لا يمكن التراجع عن هذا الإجراء.')) {
                if(confirm('تأكيد نهائي: هل تريد تصفير النظام؟')) {
                    // Delete from Cloud
                    const orderIds = db.orders.map(o => o.id);
                    const payoutIds = db.payouts.map(p => p.id);
                    window.firebaseAPI.clearCollection('orders', orderIds);
                    window.firebaseAPI.clearCollection('payouts', payoutIds);
                    // Note: Adjustments are not cleared here by default, but can be added if needed
                    
                    db.orders = [];
                    db.payouts = [];
                    saveDB();
                    location.reload();
                }
            }
        }

        // --- ACTIVITY LOG LOGIC ---
        function logActivity(action, details) {
            if(!db.logs) db.logs = [];
            const user = currentUser ? currentUser.username : 'System';
            const logEntry = {
                id: Date.now(),
                user,
                action,
                details,
                timestamp: Date.now()
            };
            db.logs.unshift(logEntry);
            window.firebaseAPI.save('logs', logEntry.id, logEntry); // Save to Cloud
            // Keep only last 1000 logs to prevent storage bloat
            if(db.logs.length > 1000) db.logs = db.logs.slice(0, 1000);
            // Note: saveDB() is usually called after this in the parent function
        }

        function renderLogs() {
            const container = document.getElementById('activity-log-body');
            if(!container) return;
            container.innerHTML = '';
            const logs = db.logs || [];
            
            if(logs.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">لا يوجد نشاطات مسجلة</td></tr>';
                return;
            }

            logs.slice(0, 50).forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('ar-EG');
                let actionClass = 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
                if(log.action.includes('إضافة')) actionClass = 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400';
                if(log.action.includes('تعديل')) actionClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
                if(log.action.includes('حذف')) actionClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';

                container.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition text-sm">
                        <td class="p-3 text-slate-500 dark:text-slate-400 font-mono text-xs">${date}</td>
                        <td class="p-3 font-bold text-slate-800 dark:text-slate-200">${log.user}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${actionClass}">${log.action}</span></td>
                        <td class="p-3 text-slate-600 dark:text-slate-300">${log.details}</td>
                    </tr>
                `;
            });
        }

        // --- UTILS ---
        function saveDB() {
            // localStorage.setItem('agencyDB', JSON.stringify(db)); // Disabled in favor of Firebase
            renderStats();
        }

        function saveStaff(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            const type = document.getElementById('staff-role').value;
            const name = document.getElementById('staff-name').value;
            const phone = document.getElementById('staff-phone').value;
            let extraData = {};
            if(type === 'marketer') extraData.commission = document.getElementById('staff-commission').value;
            else {
                extraData.specialty = document.getElementById('staff-specialty').value;
                extraData.commission = document.getElementById('staff-designer-commission').value;
                extraData.wallet = document.getElementById('staff-wallet').value;
            }
            
            if (id) {
                const index = db.staff.findIndex(s => s.id == id);
                if (index !== -1) {
                    db.staff[index] = { ...db.staff[index], name, phone, ...extraData };
                    window.firebaseAPI.save('staff', id, db.staff[index]); // Save to Cloud
                }
            } else {
                const newStaff = { id: Date.now(), name, type, phone, ...extraData };
                db.staff.push(newStaff);
                window.firebaseAPI.save('staff', newStaff.id, newStaff); // Save to Cloud
            }
            
            saveDB(); closeModal('staff-modal');
            if(type === 'marketer') renderMarketers(); else renderDesigners();
            showNotification('تم الحفظ بنجاح', 'success');
        }

        function editStaff(id) {
            const staff = db.staff.find(s => s.id == id);
            if(!staff) return;
            
            openModal('staff-modal', staff.type);
            document.getElementById('staff-id').value = staff.id;
            document.getElementById('staff-name').value = staff.name;
            document.getElementById('staff-phone').value = staff.phone;
            document.getElementById('staff-modal-title').innerText = "تعديل بيانات الموظف";

            if(staff.type === 'marketer') {
                document.getElementById('staff-commission').value = staff.commission;
            } else {
                document.getElementById('staff-specialty').value = staff.specialty;
                document.getElementById('staff-designer-commission').value = staff.commission || '';
                document.getElementById('staff-wallet').value = staff.wallet;
            }
        }

        function deleteStaff(id) {
            if(confirm('حذف الموظف؟')) {
                db.staff = db.staff.filter(s => s.id != id);
                window.firebaseAPI.delete('staff', id); // Delete from Cloud
                saveDB();
                if(!document.getElementById('tab-marketers').classList.contains('hidden-section')) renderMarketers();
                if(!document.getElementById('tab-designers').classList.contains('hidden-section')) renderDesigners();
            }
        }
        
        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const r = document.getElementById('new-role').value;
            
            // Collect Permissions
            const perms = [];
            document.querySelectorAll('.perm-checkbox:checked').forEach(cb => perms.push(cb.value));

            if (id) {
                // Edit Mode
                const index = db.users.findIndex(usr => usr.id == id);
                if (index !== -1) {
                    const existing = db.users[index];
                    // Check duplicate username if changed
                    if (existing.username !== u && db.users.find(usr => usr.username === u)) { showNotification('اسم المستخدم موجود بالفعل', 'error'); return; }
                    
                    db.users[index] = { 
                        ...existing, 
                        username: u, 
                        role: r, 
                        permissions: perms,
                        password: p ? p : existing.password // Update password only if provided
                    };
                    window.firebaseAPI.save('users', id, db.users[index]); // Save to Cloud
                }
            } else {
                // Add Mode
                if(db.users.find(usr => usr.username === u)) { showNotification('المستخدم موجود', 'error'); return; }
                if(!p) { showNotification('كلمة المرور مطلوبة', 'error'); return; }
                
                let staffId = null;
                // If Marketer or Designer, create Staff entry first
                if(r === 'marketer' || r === 'designer') {
                    const sName = document.getElementById('new-user-realname').value || u;
                    const sPhone = document.getElementById('new-user-phone').value || '';
                    const sComm = document.getElementById('new-user-commission').value || 0;
                    const sSpec = document.getElementById('new-user-specialty').value || '';
                    
                    const newStaff = { 
                        id: Date.now(), 
                        name: sName, 
                        type: r, 
                        phone: sPhone, 
                        commission: sComm, 
                        specialty: sSpec,
                        wallet: 0
                    };
                    db.staff.push(newStaff);
                    window.firebaseAPI.save('staff', newStaff.id, newStaff);
                    staffId = newStaff.id;
                }

                const newUser = { id: Date.now(), username: u, password: p, role: r, permissions: perms, staffId: staffId };
                db.users.push(newUser);
                window.firebaseAPI.save('users', newUser.id, newUser); // Save to Cloud
            }

            saveDB(); closeModal('user-modal'); renderUsers();
            showNotification('تم الحفظ بنجاح', 'success');
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-users').value.toLowerCase();
            
            db.users.filter(u => u.username.toLowerCase().includes(search)).forEach(u => {
                const permsCount = u.role === 'admin' ? 'الكل' : (u.permissions ? u.permissions.length : 0);
                tbody.innerHTML += `
                    <tr class="border-b border-slate-50 dark:border-slate-700 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700">
                        <td class="p-4 font-bold text-slate-700 dark:text-slate-200">${u.username}</td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-full ${u.role === 'admin' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400'} text-xs font-bold">${u.role === 'admin' ? 'مدير كامل' : 'مساعد'}</span>
                            ${u.role !== 'admin' ? `<span class="text-xs text-slate-400 mr-2">(${permsCount} صلاحيات)</span>` : ''}
                        </td>
                        <td class="p-4">
                            <div class="flex gap-3">
                                <button onclick="editUser(${u.id})" class="text-blue-400 hover:text-blue-600 transition"><i class="fas fa-edit"></i></button>
                                ${u.username !== 'admin' ? `<button onclick="deleteUser(${u.id})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>` : '<span class="text-slate-300"><i class="fas fa-lock"></i></span>'}
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if(!user) return;

            document.getElementById('user-id').value = user.id;
            document.getElementById('new-username').value = user.username;
            document.getElementById('new-password').value = ''; // Don't show password
            document.getElementById('new-role').value = user.role;
            document.getElementById('user-modal-title').innerText = "تعديل المستخدم";

            // Set Permissions
            const perms = user.permissions || [];
            document.querySelectorAll('.perm-checkbox').forEach(cb => {
                cb.checked = perms.includes(cb.value);
            });
            
            // Hide staff fields on edit for simplicity (or could implement editing linked staff)
            document.getElementById('user-staff-fields').classList.add('hidden');

            openModal('user-modal');
        }
        
        function deleteUser(id) {
            if(confirm('حذف المستخدم؟')) {
                db.users = db.users.filter(u => u.id != id);
                window.firebaseAPI.delete('users', id); // Delete from Cloud
                saveDB(); renderUsers();
                logActivity('حذف مستخدم', `تم حذف المستخدم ID: ${id}`);
            }
        }

        // --- CLIENTS (VIP) LOGIC ---
        function renderClients() {
            const tbody = document.getElementById('clients-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-clients').value.toLowerCase();
            
            (db.clients || []).filter(c => c.name.toLowerCase().includes(search)).forEach(c => {
                tbody.innerHTML += `
                    <tr class="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">
                        <td class="p-4 font-bold text-slate-800 dark:text-white">${c.name}</td>
                        <td class="p-4 text-slate-500">${c.phone}</td>
                        <td class="p-4 font-bold text-orange-600 dark:text-orange-400">${parseFloat(c.balance).toLocaleString()} ${getCurrency()}</td>
                        <td class="p-4 text-center flex justify-center gap-2">
                            <button onclick="openTopUpModal(${c.id})" class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-emerald-200 transition"><i class="fas fa-plus"></i> شحن</button>
                            <button onclick="openHistoryModal(${c.id})" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-200 transition"><i class="fas fa-history"></i> سجل</button>
                            <button onclick="printClientStatement(${c.id})" class="text-slate-400 hover:text-slate-600 transition" title="طباعة كشف حساب"><i class="fas fa-print"></i></button>
                            <button onclick="editClient(${c.id})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function saveClient(e) {
            e.preventDefault();
            const id = document.getElementById('client-id').value;
            const name = document.getElementById('client-modal-name').value;
            const phone = document.getElementById('client-modal-phone').value;
            const balance = parseFloat(document.getElementById('client-modal-balance').value) || 0;

            if(id) {
                const idx = db.clients.findIndex(c => c.id == id);
                if(idx !== -1) {
                    db.clients[idx] = { ...db.clients[idx], name, phone, balance }; // Usually balance isn't edited here directly but for admin power
                    window.firebaseAPI.save('clients', id, db.clients[idx]);
                }
            } else {
                const newClient = { id: Date.now(), name, phone, balance };
                db.clients.push(newClient);
                window.firebaseAPI.save('clients', newClient.id, newClient);
            }
            saveDB(); closeModal('client-modal'); renderClients();
        }

        function editClient(id) {
            const c = db.clients.find(x => x.id == id);
            if(!c) return;
            document.getElementById('client-id').value = c.id;
            document.getElementById('client-modal-name').value = c.name;
            document.getElementById('client-modal-phone').value = c.phone;
            document.getElementById('client-modal-balance').value = c.balance;
            document.getElementById('client-modal-title').innerText = "تعديل بيانات العميل";
            openModal('client-modal');
        }

        function openTopUpModal(id) {
            const c = db.clients.find(x => x.id == id);
            if(!c) return;
            document.getElementById('topup-client-id').value = c.id;
            document.getElementById('topup-client-name').innerText = c.name;
            document.getElementById('topup-amount').value = '';
            openModal('topup-modal');
        }

        function openHistoryModal(id) {
            const c = db.clients.find(x => x.id == id);
            if(!c) return;
            
            document.getElementById('history-client-name').innerText = c.name;
            const tbody = document.getElementById('client-history-body');
            tbody.innerHTML = '';
            
            const transactions = c.transactions || [];
            if(transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">لا توجد حركات مسجلة</td></tr>';
            } else {
                transactions.forEach(t => {
                    const date = new Date(t.date).toLocaleString('ar-EG');
                    let typeBadge = '';
                    if(t.type === 'deposit') typeBadge = '<span class="text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded text-xs font-bold">إيداع (شحن)</span>';
                    else typeBadge = '<span class="text-red-600 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded text-xs font-bold">خصم (دفع)</span>';
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-50 dark:border-slate-800 last:border-0">
                            <td class="p-4 text-slate-500 font-mono text-xs">${date}</td>
                            <td class="p-4">${typeBadge}</td>
                            <td class="p-4 font-bold ${t.type === 'deposit' ? 'text-emerald-600' : 'text-red-600'}">${parseFloat(t.amount).toLocaleString()} ${getCurrency()}</td>
                            <td class="p-4 text-slate-600 dark:text-slate-300 text-xs">${t.details}</td>
                        </tr>
                    `;
                });
            }
            document.getElementById('client-history-modal').classList.remove('hidden');
        }

        function printClientStatement(id) {
            const client = db.clients.find(c => c.id == id);
            if(!client) return;
            const settings = (db.settings && db.settings.length > 0) ? db.settings[0] : { appName: 'DM Agency', logoUrl: 'https://via.placeholder.com/150x80?text=LOGO' };
            
            const printWindow = window.open('', '_blank');
            
            let rows = '';
            const transactions = client.transactions || [];
            if(transactions.length === 0) {
                rows = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #777;">لا توجد حركات مسجلة</td></tr>';
            } else {
                transactions.forEach(t => {
                    const date = new Date(t.date).toLocaleDateString('ar-EG');
                    const typeText = t.type === 'deposit' ? 'إيداع (شحن)' : 'خصم (دفع)';
                    const color = t.type === 'deposit' ? '#10b981' : '#ef4444';
                    rows += `
                        <tr>
                            <td>${date}</td>
                            <td style="color: ${color}; font-weight: bold;">${typeText}</td>
                            <td>${parseFloat(t.amount).toLocaleString()} ${getCurrency()}</td>
                            <td>${t.details}</td>
                        </tr>
                    `;
                });
            }

            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>كشف حساب - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Tajawal', sans-serif; background-color: white; padding: 40px; color: #333; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
                        .header img { max-height: 80px; margin-bottom: 10px; }
                        .header h1 { margin: 0; font-size: 24px; color: #1e293b; }
                        .header p { margin: 5px 0; color: #64748b; }
                        .client-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
                        .client-box h3 { margin: 0 0 10px 0; font-size: 18px; color: #0f172a; }
                        .client-box p { margin: 5px 0; font-size: 14px; }
                        .balance-box { text-align: left; }
                        .balance-amount { font-size: 24px; font-weight: bold; color: #ea580c; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th { background-color: #f1f5f9; color: #475569; font-weight: bold; padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0; }
                        td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #334155; }
                        tr:last-child td { border-bottom: none; }
                        .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px dashed #cbd5e1; padding-top: 20px; }
                        @media print { body { padding: 0; } th { background-color: #eee !important; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="${settings.logoUrl || 'https://via.placeholder.com/150x80?text=LOGO'}" alt="Logo">
                        <h1>كشف حساب عميل</h1>
                        <p>${settings.appName || 'DM Agency'}</p>
                    </div>
                    <div class="client-box">
                        <div>
                            <h3>${client.name}</h3>
                            <p>رقم الهاتف: ${client.phone}</p>
                            <p>تاريخ الاستخراج: ${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>
                        <div class="balance-box">
                            <p>الرصيد الحالي</p>
                            <div class="balance-amount">${parseFloat(client.balance).toLocaleString()} ${getCurrency()}</div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع الحركة</th>
                                <th>المبلغ</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div class="footer"><p>تم استخراج هذا الكشف آلياً من النظام.</p></div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function saveTopUp(e) {
            e.preventDefault();
            const id = document.getElementById('topup-client-id').value;
            const amount = parseFloat(document.getElementById('topup-amount').value);
            const c = db.clients.find(x => x.id == id);
            if(c) {
                c.balance += amount;
                
                // Add Transaction Record
                if(!c.transactions) c.transactions = [];
                c.transactions.unshift({
                    id: Date.now(),
                    type: 'deposit',
                    amount: amount,
                    date: Date.now(),
                    details: 'شحن رصيد مباشر'
                });

                window.firebaseAPI.save('clients', c.id, c);
                logActivity('شحن محفظة', `تم شحن ${amount} لمحفظة العميل ${c.name}`);
                saveDB(); closeModal('topup-modal'); renderClients();
                showNotification('تم الشحن بنجاح', 'success');
            }
        }

        function saveAppSettings(e) {
            e.preventDefault();
            const settings = {
                appName: document.getElementById('setting-app-name').value,
                logoUrl: document.getElementById('setting-logo-url').value,
                invoiceTerms: document.getElementById('setting-invoice-terms').value,
                currency: document.getElementById('setting-currency').value,
                designerLabelS: document.getElementById('setting-designer-label-s').value,
                designerLabelP: document.getElementById('setting-designer-label-p').value
            };
            
            db.settings = [settings];
            window.firebaseAPI.save('settings', 'global', settings);
            applyAppSettings();
            showNotification('تم حفظ الإعدادات', 'success');
        }

        function renderStats() {
            document.getElementById('stat-total-orders').innerText = db.orders.length;
            const revenue = db.orders.filter(o => o.status !== 'rejected').reduce((sum, o) => sum + (parseFloat(o.paid) || 0), 0);
            document.getElementById('stat-revenue').innerText = revenue.toLocaleString() + ' ' + getCurrency();
            
            // Debt Logic
            const debt = db.orders.filter(o => o.status !== 'rejected').reduce((sum, o) => sum + (parseFloat(o.price) - parseFloat(o.paid)), 0);
            document.getElementById('stat-debt').innerText = debt.toLocaleString() + ' ' + getCurrency();
            
            // Net Profit Logic
            const totalPayouts = db.payouts.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const netProfit = revenue - totalPayouts;
            document.getElementById('stat-net-profit').innerText = netProfit.toLocaleString() + ' ' + getCurrency();

            // Today's Orders Badge
            const todayStr = new Date().toDateString();
            const todayCount = db.orders.filter(o => new Date(o.dateCreated).toDateString() === todayStr).length;
            const todayBadge = document.getElementById('today-orders-badge');
            if (todayBadge) {
                todayBadge.innerText = todayCount;
                if (todayCount > 0) todayBadge.classList.remove('hidden');
                else todayBadge.classList.add('hidden');
            }

            let lateCount = 0;
            const now = Date.now();
            db.orders.forEach(o => { if(o.status === 'pending' && o.designerId && (now - o.dateAssigned > 86400000)) lateCount++; });
            document.getElementById('stat-late-tasks').innerText = lateCount;
            updateNotifications();
            
            renderCharts();
        }

        function renderCharts() {
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            const ctxMarketer = document.getElementById('marketerChart').getContext('2d');
            const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
            const ctxDesigner = document.getElementById('designerChart').getContext('2d');
            const ctxSource = document.getElementById('sourceChart').getContext('2d');
            
            // Get Filter
            const filterEl = document.getElementById('chart-month-filter');
            let year, month;
            if (filterEl && filterEl.value) {
                [year, month] = filterEl.value.split('-').map(Number);
            } else {
                const now = new Date();
                year = now.getFullYear();
                month = now.getMonth() + 1;
            }

            // Filter Orders
            const filteredOrders = db.orders.filter(o => {
                const d = new Date(o.dateCreated);
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });

            // Prepare Data
            const statusCounts = { pending: 0, review: 0, done: 0, rejected: 0 };
            filteredOrders.forEach(o => { if(statusCounts[o.status] !== undefined) statusCounts[o.status]++; });

            const marketerSales = {};
            db.staff.filter(s => s.type === 'marketer').forEach(m => marketerSales[m.name] = 0);
            filteredOrders.forEach(o => {
                if(o.status !== 'rejected' && o.marketerId) {
                    const m = db.staff.find(s => s.id == o.marketerId);
                    if(m) marketerSales[m.name] = (marketerSales[m.name] || 0) + parseFloat(o.price);
                }
            });

            // Designer Data
            const designerCounts = {};
            db.staff.filter(s => s.type === 'designer').forEach(d => designerCounts[d.name] = 0);
            
            filteredOrders.forEach(o => {
                if(o.status === 'done' && o.designerId) {
                    const designer = db.staff.find(s => s.id == o.designerId);
                    if(designer) designerCounts[designer.name] = (designerCounts[designer.name] || 0) + 1;
                }
            });

            // Source Data
            const sourceCounts = {};
            filteredOrders.forEach(o => {
                const src = o.source || 'غير محدد';
                sourceCounts[src] = (sourceCounts[src] || 0) + 1;
            });

            // Revenue Data (Daily for selected month)
            const daysInMonth = new Date(year, month, 0).getDate();
            const revenueLabels = [];
            const revenueData = [];
            
            for (let i = 1; i <= daysInMonth; i++) {
                revenueLabels.push(i);
                const dayRevenue = filteredOrders.reduce((sum, o) => {
                    const d = new Date(o.dateCreated);
                    if(o.status !== 'rejected' && d.getDate() === i) {
                        return sum + (parseFloat(o.paid) || 0);
                    }
                    return sum;
                }, 0);
                revenueData.push(dayRevenue);
            }

            // Status Chart
            if(statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['قيد التنفيذ', 'مراجعة', 'مكتمل', 'مرفوض'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts.review, statusCounts.done, statusCounts.rejected],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'Tajawal' } } } } }
            });

            // Marketer Chart
            if(marketerChartInstance) marketerChartInstance.destroy();
            marketerChartInstance = new Chart(ctxMarketer, {
                type: 'bar',
                data: {
                    labels: Object.keys(marketerSales),
                    datasets: [{
                        label: `المبيعات (${getCurrency()})`,
                        data: Object.values(marketerSales),
                        backgroundColor: '#6366f1',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });

            // Revenue Chart
            if(revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(ctxRevenue, {
                type: 'line',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: `الإيرادات (${getCurrency()})`,
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981',
                        pointBorderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });

            // Designer Chart
            if(designerChartInstance) designerChartInstance.destroy();
            designerChartInstance = new Chart(ctxDesigner, {
                type: 'bar',
                data: {
                    labels: Object.keys(designerCounts),
                    datasets: [{
                        label: 'تصاميم مكتملة',
                        data: Object.values(designerCounts),
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });

            // Source Chart
            if(sourceChartInstance) sourceChartInstance.destroy();
            sourceChartInstance = new Chart(ctxSource, {
                type: 'pie',
                data: {
                    labels: Object.keys(sourceCounts),
                    datasets: [{
                        data: Object.values(sourceCounts),
                        backgroundColor: ['#ec4899', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#14b8a6'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'right', labels: { font: { family: 'Tajawal' } } }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });
        }

        function printInvoice(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;
            const settings = (db.settings && db.settings.length > 0) ? db.settings[0] : { appName: 'DM Agency', logoUrl: 'https://via.placeholder.com/150x80?text=LOGO', invoiceTerms: '1. العربون المدفوع لا يسترد.\n2. التسليم بعد سداد كامل المبلغ.' };
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>فاتورة #${order.id}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Tajawal', sans-serif; background-color: #f8f9fa; padding: 20px; -webkit-print-color-adjust: exact; }
                        .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); background: white; font-size: 16px; line-height: 24px; color: #555; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
                        .header img { max-height: 80px; margin-bottom: 10px; }
                        .header h1 { margin: 0; color: #1e293b; font-size: 24px; font-weight: 800; }
                        .header p { margin: 5px 0; color: #64748b; font-size: 14px; }
                        
                        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .info-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
                        .info-table td:first-child { font-weight: bold; color: #334155; width: 150px; }
                        
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 10px; }
                        .row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                        .row.final { border-top: 2px solid #cbd5e1; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 1.2em; color: #0f172a; }
                        
                        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px dashed #cbd5e1; text-align: center; font-size: 12px; color: #94a3b8; }
                        .footer h4 { margin: 0 0 10px; color: #475569; font-size: 14px; }
                        .footer p { margin: 2px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .invoice-box { box-shadow: none; border: none; padding: 0; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-box">
                        <div class="header">
                            <img src="${settings.logoUrl || 'https://via.placeholder.com/150x80?text=LOGO'}" alt="Logo">
                            <h1>${settings.appName || 'فاتورة طلب خدمة'}</h1>
                            <p>رقم المرجع: #${order.id}</p>
                            <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>

                        <table class="info-table">
                            <tr><td>العميل:</td><td>${order.client}</td></tr>
                            <tr><td>رقم الهاتف:</td><td>${order.phone}</td></tr>
                            <tr><td>الخدمة:</td><td>${order.service}</td></tr>
                            <tr><td>تاريخ الإنشاء:</td><td>${new Date(order.dateCreated).toLocaleDateString('ar-EG')}</td></tr>
                        </table>

                        <div class="total-section">
                            <div class="row"><span>الإجمالي:</span> <span>${parseFloat(order.price).toLocaleString()} ${getCurrency()}</span></div>
                            <div class="row"><span>المدفوع:</span> <span>${parseFloat(order.paid).toLocaleString()} ${getCurrency()}</span></div>
                            <div class="row final" style="color: ${(order.price - order.paid) > 0 ? '#dc2626' : '#16a34a'}"><span>المتبقي:</span> <span>${(order.price - order.paid).toLocaleString()} ${getCurrency()}</span></div>
                        </div>

                        <div class="footer">
                            <h4>الشروط والأحكام</h4>
                            <p style="white-space: pre-line;">${settings.invoiceTerms || 'لا توجد شروط إضافية.'}</p>
                            <p style="margin-top: 15px; font-weight: bold;">شكراً لثقتكم بنا!</p>
                        </div>
                    </div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function copyOrderDetails(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;

            const remaining = order.price - order.paid;
            let message = `مرحباً ${order.client}، 👋\n\n`;
            message += `إليك تفاصيل طلبك رقم #${order.id}:\n`;
            message += `📌 الخدمة: ${order.service}\n`;
            message += `💰 الإجمالي: ${parseFloat(order.price).toLocaleString()} ${getCurrency()}\n`;
            message += `✅ المدفوع: ${parseFloat(order.paid).toLocaleString()} ${getCurrency()}\n`;
            
            if(remaining > 0) {
                message += `❗ المتبقي: ${remaining.toLocaleString()} ${getCurrency()}\n`;
            } else {
                message += `✅ الحالة: خالص\n`;
            }

            message += `\nشكراً لثقتك بنا! 🌹`;

            navigator.clipboard.writeText(message).then(() => showNotification('تم نسخ التفاصيل بنجاح', 'success')).catch(() => showNotification('فشل النسخ', 'error'));
        }

        function sendWhatsApp(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;

            let phone = order.phone.replace(/\D/g, '');
            // افتراض أن الأرقام مصرية، إذا بدأت بـ 01 يتم استبدال الصفر بـ 20
            if (phone.startsWith('01')) phone = '2' + phone; 

            const remaining = order.price - order.paid;
            const message = `مرحباً ${order.client}، 👋

إليك تفاصيل فاتورة طلبك رقم #${order.id}:
📌 الخدمة: ${order.service}
💰 الإجمالي: ${parseFloat(order.price).toLocaleString()} ${getCurrency()}
✅ المدفوع: ${parseFloat(order.paid).toLocaleString()} ${getCurrency()}
❗ المتبقي: ${remaining.toLocaleString()} ${getCurrency()}

شكراً لثقتك بنا! 🌹`;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function sendDeliveryWhatsApp(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;

            let phone = order.phone.replace(/\D/g, '');
            if (phone.startsWith('01')) phone = '2' + phone; 

            let message = `مرحباً ${order.client}، 👋\n\n`;
            message += `يسعدنا إخبارك بأن طلبك (${order.service}) جاهز للتسليم! 🚀\n\n`;
            
            if(order.designLink) {
                message += `🔗 رابط التصميم/الملفات:\n${order.designLink}\n\n`;
            }

            const remaining = order.price - order.paid;
            if(remaining > 0) {
                message += `❗ يرجى العلم أن هناك مبلغ متبقي: ${remaining.toLocaleString()} ${getCurrency()}\n\n`;
            }

            message += `شكراً لتعاملك معنا! 🌹`;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- NOTIFICATIONS SYSTEM ---
        function toggleNotificationMenu() {
            const menu = document.getElementById('notification-menu');
            menu.classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.getElementById('notification-bell-container');
            const menu = document.getElementById('notification-menu');
            if (container && !container.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        function updateNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const now = Date.now();
            
            const lateOrders = db.orders.filter(o => 
                o.status === 'pending' && 
                o.designerId && 
                (now - o.dateAssigned > 86400000)
            );

            if (lateOrders.length > 0) {
                badge.classList.remove('hidden');
                list.innerHTML = '';
                lateOrders.forEach(o => {
                    const timeDiff = now - o.dateAssigned;
                    const hoursLate = Math.floor(timeDiff / (1000 * 60 * 60));
                    list.innerHTML += `
                        <div class="p-3 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/30 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/20 transition" onclick="editOrder(${o.id}); toggleNotificationMenu()">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">#${o.id} ${o.client}</h4>
                                <span class="text-[10px] font-bold text-red-500 bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-red-200 dark:border-red-800">${hoursLate}س</span>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">الخدمة: ${o.service}</p>
                        </div>`;
                });
            } else {
                badge.classList.add('hidden');
                list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm"><i class="fas fa-check-circle text-2xl mb-2 text-emerald-500"></i><br>لا توجد تنبيهات</div>`;
            }
        }

        // --- REPORT LOGIC ---
        function openReportModal() {
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('report-month').value = monthStr;
            renderReportTable();
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function renderReportTable() {
            const monthVal = document.getElementById('report-month').value;
            if(!monthVal) return;
            
            const [year, month] = monthVal.split('-').map(Number);
            const tbody = document.getElementById('report-table-body');
            const tfoot = document.getElementById('report-table-footer');
            const tbodyDesigners = document.getElementById('report-designers-body');

            // Update Headers in Report Modal
            const designerHeader = document.querySelector('#report-modal h4:nth-of-type(2)');
            if(designerHeader) designerHeader.innerText = `${getDesignerLabel(true)} (المدفوعات)`;
            
            tbody.innerHTML = '';
            tbodyDesigners.innerHTML = '';
            
            let grandTotalSales = 0;
            let grandCollectedComm = 0;
            let grandPayouts = 0;

            db.staff.filter(s => s.type === 'marketer').forEach(m => {
                // Filter orders for this marketer in the selected month
                const mOrders = db.orders.filter(o => {
                    const d = new Date(o.dateCreated);
                    return o.marketerId == m.id && 
                           d.getMonth() === (month - 1) && 
                           d.getFullYear() === year && 
                           o.status !== 'rejected';
                });

                const commRate = parseFloat(m.commission) || 0;
                const totalSales = mOrders.reduce((sum, o) => sum + parseFloat(o.price), 0);
                
                // Calculate commission based on ALL non-rejected orders (Deposits count)
                const totalPaid = mOrders.reduce((sum, o) => sum + parseFloat(o.paid), 0);
                const collectedComm = (totalPaid * commRate) / 100; 
                
                // Adjustments (Bonus/Deduction) for this month
                const mAdj = (db.adjustments || []).filter(a => {
                    const d = new Date(a.date);
                    return a.staffId == m.id && d.getMonth() === (month - 1) && d.getFullYear() === year;
                });
                const totalBonus = mAdj.filter(a => a.type === 'bonus').reduce((sum, a) => sum + parseFloat(a.amount), 0);
                const totalDeduction = mAdj.filter(a => a.type === 'deduction').reduce((sum, a) => sum + parseFloat(a.amount), 0);
                const netDue = collectedComm + totalBonus - totalDeduction;

                // Calculate Payouts for this month
                const mPayouts = db.payouts.filter(p => {
                    const d = new Date(p.date);
                    return p.staffId == m.id && d.getMonth() === (month - 1) && d.getFullYear() === year;
                });
                const totalPayouts = mPayouts.reduce((sum, p) => sum + parseFloat(p.amount), 0);
                const payoutNotes = mPayouts.map(p => p.notes).filter(n => n).join(' | ');

                grandTotalSales += totalSales;
                grandCollectedComm += collectedComm;
                grandPayouts += totalPayouts;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <td class="p-4 font-bold">${m.name} <span class="text-xs text-slate-400">(${commRate}%)</span></td>
                        <td class="p-4">${totalSales.toLocaleString()} ${getCurrency()}</td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${netDue.toLocaleString()} ${getCurrency()} <span class="text-[10px] text-slate-400 block">(+${totalBonus} / -${totalDeduction})</span></td>
                        <td class="p-4 text-blue-600 dark:text-blue-400 font-bold">${collectedComm.toLocaleString()} ${getCurrency()}</td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${totalPayouts.toLocaleString()} ${getCurrency()}</td>
                        <td class="p-4 text-xs text-slate-500 max-w-[200px] truncate" title="${payoutNotes}">${payoutNotes}</td>
                        <td class="p-4 text-center">
                            <button onclick="openPayoutModal(${m.id}, '${m.name}')" class="bg-emerald-100 text-emerald-600 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 w-8 h-8 rounded-lg transition"><i class="fas fa-hand-holding-usd"></i></button>
                        </td>
                    </tr>
                `;
            });

            if(tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">لا توجد بيانات</td></tr>';
            }

            tfoot.innerHTML = `
                <td class="p-4">الإجمالي الكلي</td>
                <td class="p-4">${grandTotalSales.toLocaleString()} ${getCurrency()}</td>
                <td></td>
                <td class="p-4 text-blue-600 dark:text-blue-400">${grandCollectedComm.toLocaleString()} ${getCurrency()}</td>
                <td class="p-4 text-emerald-600 dark:text-emerald-400">${grandPayouts.toLocaleString()} ${getCurrency()}</td>
                <td></td>
                <td></td>
            `;

            // Render Designers
            db.staff.filter(s => s.type === 'designer').forEach(d => {
                // Calculate Earnings based on completed orders in this month
                const dOrders = db.orders.filter(o => {
                    const date = new Date(o.dateCreated); // Or deliveryDate? Usually commission is on completion. Let's use dateCreated for period matching or maybe completion date if available. Using dateCreated for simplicity consistent with marketers.
                    return o.designerId == d.id && o.status === 'done' && date.getMonth() === (month - 1) && date.getFullYear() === year;
                });
                const totalWork = dOrders.reduce((sum, o) => sum + parseFloat(o.price), 0);
                const commRate = parseFloat(d.commission) || 0;
                const earnings = (totalWork * commRate) / 100;

                // Adjustments
                const dAdj = (db.adjustments || []).filter(a => {
                    const date = new Date(a.date);
                    return a.staffId == d.id && date.getMonth() === (month - 1) && date.getFullYear() === year;
                });
                const totalBonus = dAdj.filter(a => a.type === 'bonus').reduce((sum, a) => sum + parseFloat(a.amount), 0);
                const totalDeduction = dAdj.filter(a => a.type === 'deduction').reduce((sum, a) => sum + parseFloat(a.amount), 0);
                const netDue = earnings + totalBonus - totalDeduction;

                const dPayouts = db.payouts.filter(p => {
                    const date = new Date(p.date);
                    return p.staffId == d.id && date.getMonth() === (month - 1) && date.getFullYear() === year;
                });
                const totalDPayouts = dPayouts.reduce((sum, p) => sum + parseFloat(p.amount), 0);
                const dPayoutNotes = dPayouts.map(p => p.notes).filter(n => n).join(' | ');

                tbodyDesigners.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <td class="p-4 font-bold">${d.name}</td>
                        <td class="p-4 text-slate-500">${d.specialty}</td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${netDue.toLocaleString()} ${getCurrency()} <span class="text-[10px] text-slate-400 block">(نسبة: ${earnings.toLocaleString()} + ${totalBonus} - ${totalDeduction})</span></td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${totalDPayouts.toLocaleString()} ${getCurrency()}</td>
                        <td class="p-4 text-xs text-slate-500 max-w-[200px] truncate" title="${dPayoutNotes}">${dPayoutNotes}</td>
                        <td class="p-4 text-center">
                            <button onclick="openPayoutModal(${d.id}, '${d.name}')" class="bg-emerald-100 text-emerald-600 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 w-8 h-8 rounded-lg transition"><i class="fas fa-hand-holding-usd"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if(tbodyDesigners.innerHTML === '') {
                tbodyDesigners.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400">لا يوجد ${getDesignerLabel(true)}</td></tr>`;
            }
        }

        function populateServiceSelect() {
            const select = document.getElementById('service-type');
            const currentVal = select.value;
            select.innerHTML = '';
            const types = (db.settings[0] && db.settings[0].serviceTypes) ? db.settings[0].serviceTypes : defaultData.settings[0].serviceTypes;
            types.forEach(t => {
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        function populateSourceSelect() {
            const select = document.getElementById('order-source');
            select.innerHTML = '<option value="">-- اختر المصدر --</option>';
            const sources = (db.settings[0] && db.settings[0].orderSources) ? db.settings[0].orderSources : defaultData.settings[0].orderSources;
            sources.forEach(s => {
                select.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function populateStaffSelects() {
            const mSelect = document.getElementById('order-marketer');
            const dSelect = document.getElementById('order-designer');
            mSelect.innerHTML = '<option value="">-- مباشر --</option>';
            dSelect.innerHTML = `<option value="">-- اختر ${getDesignerLabel()} --</option>`;
            db.staff.filter(s => s.type === 'marketer').forEach(m => mSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);
            db.staff.filter(s => s.type === 'designer').forEach(d => dSelect.innerHTML += `<option value="${d.id}">${d.name} (${d.specialty})</option>`);
        }

        function openModal(modalId, type = null) {
            if(modalId === 'staff-modal') {
                document.getElementById('staff-id').value = ''; // Clear ID for new add
                document.getElementById('staff-role').value = type;
                document.getElementById('marketer-fields').classList.add('hidden');
                document.getElementById('designer-fields').classList.add('hidden');
                if(type === 'marketer') {
                    document.getElementById('staff-modal-title').innerText = "إضافة مسوق";
                    document.getElementById('marketer-fields').classList.remove('hidden');
                } else {
                    document.getElementById('staff-modal-title').innerText = `إضافة ${getDesignerLabel()}`;
                    document.getElementById('designer-fields').classList.remove('hidden');
                }
            } else if (modalId === 'order-modal') {
                populateServiceSelect(); // Populate services dynamically
                populateSourceSelect(); // Populate sources dynamically
                document.getElementById('order-form').reset();
                document.getElementById('order-id').value = '';
                document.getElementById('modal-title').innerText = "طلب جديد";
                document.getElementById('amount-remaining').value = '0';
                document.getElementById('design-link').value = '';
                document.getElementById('design-notes').value = '';
                document.getElementById('private-notes').value = '';
                document.getElementById('amount-remaining').classList.remove('bg-emerald-50', 'text-emerald-600');
                document.getElementById('order-commission-preview').classList.add('hidden');
                populateStaffSelects();
                document.querySelector('input[name="status-radio"][value="pending"]').checked = true;
                document.getElementById('order-status').value = 'pending';
            } else if (modalId === 'user-modal') {
                // Reset user modal if opened directly (Add mode)
                if(!document.getElementById('user-id').value) {
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.querySelectorAll('.perm-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('user-modal-title').innerText = "إضافة مستخدم جديد";
                }
            } else if (modalId === 'client-modal') {
                if(!document.getElementById('client-id').value) {
                    document.getElementById('client-modal-name').value = '';
                    document.getElementById('client-modal-phone').value = '';
                    document.getElementById('client-modal-balance').value = '';
                    document.getElementById('client-modal-title').innerText = "إضافة عميل VIP";
                }
            } else if (modalId === 'adjustment-modal') {
                document.getElementById('adj-id').value = '';
                document.getElementById('adj-amount').value = '';
                document.getElementById('adj-reason').value = '';
                const sSelect = document.getElementById('adj-staff');
                sSelect.innerHTML = '';
                db.staff.forEach(s => sSelect.innerHTML += `<option value="${s.id}">${s.name} (${s.type === 'marketer' ? 'مسوق' : getDesignerLabel()})</option>`);
            }
            const el = document.getElementById(modalId);
            el.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            // Reset specific modals logic
            if(modalId === 'order-modal') {
                document.getElementById('is-vip-order').checked = false;
                toggleVipMode();
            }
            if(modalId === 'client-modal') {
                document.getElementById('client-id').value = '';
            }
            if(modalId === 'adjustment-modal') {
                document.getElementById('adj-id').value = '';
            }
        }

        function openPayoutModal(id, name) {
            document.getElementById('payout-staff-id').value = id;
            document.getElementById('payout-staff-name').value = name;
            document.getElementById('payout-amount').value = '';
            document.getElementById('payout-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payout-notes').value = '';
            document.getElementById('payout-modal').classList.remove('hidden');
        }

        function savePayout(e) {
            e.preventDefault();
            const staffId = document.getElementById('payout-staff-id').value;
            const amount = parseFloat(document.getElementById('payout-amount').value);
            const date = document.getElementById('payout-date').value;
            const notes = document.getElementById('payout-notes').value;
            
            const newPayout = { id: Date.now(), staffId, amount, date, notes };
            db.payouts.push(newPayout);
            window.firebaseAPI.save('payouts', newPayout.id, newPayout); // Save to Cloud
            saveDB();
            closeModal('payout-modal');
            renderReportTable(); // Refresh report to show new value
            showNotification('تم تسجيل الدفعة بنجاح', 'success');
        }

        function showNotification(msg, type = 'success') {
            const area = document.getElementById('notification-area');
            const div = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-orange-500');
            div.className = `${colorClass} text-white px-6 py-4 rounded-xl shadow-xl fade-in flex items-center gap-3 min-w-[320px] transform transition-all duration-300`;
            div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} text-xl"></i><span class="font-bold">${msg}</span>`;
            area.appendChild(div);
            setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateX(-20px)'; setTimeout(() => div.remove(), 300); }, 3000);
        }

        // --- MY TASKS LOGIC ---
        function renderMyTasks() {
            const container = document.getElementById('my-tasks-grid');
            container.innerHTML = '';
            
            if(!currentUser || !currentUser.staffId) {
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-slate-400">هذا الحساب غير مرتبط بملف موظف.</div>';
                return;
            }

            const myOrders = db.orders.filter(o => o.designerId == currentUser.staffId && (o.status === 'pending' || o.status === 'review'));
            
            if(myOrders.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-slate-400"><i class="fas fa-mug-hot text-4xl mb-4"></i><br>لا توجد مهام حالياً، استمتع بوقتك!</div>';
                return;
            }

            myOrders.forEach(o => {
                const now = Date.now();
                const timeElapsed = o.dateAssigned ? (now - o.dateAssigned) : 0;
                const hoursElapsed = timeElapsed / (1000 * 60 * 60);
                const percent = Math.min((hoursElapsed / 24) * 100, 100);
                let colorClass = 'bg-emerald-500';
                if(percent > 50) colorClass = 'bg-yellow-500';
                if(percent > 90) colorClass = 'bg-red-500';

                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover relative">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 px-3 py-1 rounded-lg text-xs font-bold">${o.service}</span>
                            <span class="text-xs font-bold text-slate-400">#${o.id}</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">${o.client}</h3>
                        ${o.designNotes ? `<p class="text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl mb-4">${o.designNotes}</p>` : ''}
                        
                        <div class="mb-4">
                            <div class="flex justify-between text-xs font-bold text-slate-400 mb-1">
                                <span>الوقت المستغرق</span>
                                <span>${Math.floor(hoursElapsed)} ساعة</span>
                            </div>
                            <div class="h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full ${colorClass} transition-all duration-500" style="width: ${percent}%"></div>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-4">
                            ${o.designLink ? `<a href="${o.designLink}" target="_blank" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-2 rounded-xl text-center text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition"><i class="fas fa-link"></i> الملفات</a>` : ''}
                            <button onclick="editOrder(${o.id})" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl text-center text-sm font-bold hover:bg-indigo-700 transition">تحديث الحالة</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- PROFILE LOGIC ---
        function renderProfile() {
            if(!currentUser) return;
            
            document.getElementById('profile-username').innerText = currentUser.username;
            document.getElementById('profile-avatar').innerText = currentUser.username.charAt(0).toUpperCase();
            
            let staff = null;
            if(currentUser.staffId) staff = db.staff.find(s => s.id == currentUser.staffId);

            if(staff) {
                document.getElementById('profile-name').innerText = staff.name;
                document.getElementById('profile-role').innerText = staff.type === 'marketer' ? 'مسوق' : (staff.specialty || 'مصمم');
                document.getElementById('profile-phone').innerText = staff.phone;
                document.getElementById('profile-commission').innerText = (staff.commission || 0) + '%';
                document.getElementById('profile-wallet').innerText = (staff.wallet || 0).toLocaleString() + ' ' + getCurrency();

                // Calculate Earnings
                let totalEarnings = 0;
                let monthEarnings = 0;
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Logic differs slightly for Marketer vs Designer
                const relevantOrders = db.orders.filter(o => (staff.type === 'marketer' ? o.marketerId : o.designerId) == staff.id && o.status !== 'rejected');
                
                relevantOrders.forEach(o => {
                    const d = new Date(o.dateCreated); // Or completion date
                    const isThisMonth = d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    
                    let amount = 0;
                    if(staff.type === 'marketer') {
                        // Marketer commission on PAID amount
                        amount = (parseFloat(o.paid) * parseFloat(staff.commission)) / 100;
                    } else {
                        // Designer commission on PRICE (if done)
                        if(o.status === 'done') amount = (parseFloat(o.price) * parseFloat(staff.commission)) / 100;
                    }
                    
                    totalEarnings += amount;
                    if(isThisMonth) monthEarnings += amount;
                });

                // Add Adjustments
                const myAdj = (db.adjustments || []).filter(a => a.staffId == staff.id);
                const adjBody = document.getElementById('profile-adjustments-body');
                adjBody.innerHTML = '';
                
                myAdj.forEach(a => {
                    const isBonus = a.type === 'bonus';
                    const val = parseFloat(a.amount);
                    totalEarnings += (isBonus ? val : -val);
                    
                    const d = new Date(a.date);
                    if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        monthEarnings += (isBonus ? val : -val);
                    }

                    adjBody.innerHTML += `
                        <tr class="border-b border-slate-50 dark:border-slate-800 last:border-0">
                            <td class="p-3 text-slate-500 font-mono text-xs">${d.toLocaleDateString('ar-EG')}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${isBonus ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${isBonus ? 'مكافأة' : 'خصم'}</span></td>
                            <td class="p-3 font-bold ${isBonus ? 'text-emerald-600' : 'text-red-600'}">${val.toLocaleString()}</td>
                            <td class="p-3 text-slate-600 dark:text-slate-300">${a.reason}</td>
                        </tr>
                    `;
                });

                if(myAdj.length === 0) adjBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">لا توجد سجلات</td></tr>';

                document.getElementById('profile-total-earnings').innerText = totalEarnings.toLocaleString() + ' ' + getCurrency();
                document.getElementById('profile-month-earnings').innerText = monthEarnings.toLocaleString() + ' ' + getCurrency();

            } else {
                // Fallback for non-linked users (e.g. pure Admin)
                document.getElementById('profile-name').innerText = currentUser.username;
                document.getElementById('profile-role').innerText = currentUser.role === 'admin' ? 'مدير النظام' : 'مستخدم';
                document.getElementById('profile-phone').innerText = '-';
                document.getElementById('profile-commission').innerText = '-';
                document.getElementById('profile-wallet').innerText = '-';
                document.getElementById('profile-total-earnings').innerText = '-';
                document.getElementById('profile-month-earnings').innerText = '-';
                document.getElementById('profile-adjustments-body').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">هذا الحساب غير مرتبط بملف مالي</td></tr>';
            }
        }

        // checkAuth(); // Moved to firebase-ready event
    </script>
</body>
</html>
