<!DOCTYPE html>
<html lang="ar" dir="rtl" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุงูููุงูุฉ ุงูุงุญุชุฑุงูู | Pro Agency</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' }
                    },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        
        /* Custom Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-section { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15); }

        /* Status Badges */
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-bold inline-flex items-center gap-1; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-700 rounded-full; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-slate-400 dark:bg-slate-600; }

        /* Mobile Responsive Table to Cards */
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { 
                display: flex; 
                flex-direction: column; 
                background: white; 
                margin-bottom: 1rem; 
                border-radius: 1rem; 
                padding: 1rem; 
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border: 1px solid #e2e8f0;
            }
            .dark .responsive-table tbody tr {
                background: #1e293b;
                border-color: #334155;
            }
            .responsive-table td { 
                padding: 0.5rem 0; 
                border: none !important;
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #64748b;
                font-size: 0.75rem;
                margin-left: 1rem;
            }
            .responsive-table td:last-child {
                justify-content: center;
                margin-top: 0.5rem;
                padding-top: 1rem;
                border-top: 1px dashed #e2e8f0 !important;
            }
            .dark .responsive-table td:last-child {
                border-color: #334155 !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 antialiased selection:bg-indigo-500 selection:text-white transition-colors duration-300">

    <!-- Notifications -->
    <div id="notification-area" class="fixed top-6 left-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- 1. LOGIN SCREEN -->
    <section id="login-screen" class="h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center relative">
        <div class="absolute inset-0 bg-indigo-950/90 backdrop-blur-sm"></div>
        <div class="bg-white/95 dark:bg-slate-900/95 p-10 rounded-3xl shadow-2xl w-full max-w-md fade-in relative z-10 border border-white/10 backdrop-blur-md">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-indigo-600 text-white mb-6 shadow-lg rotate-3 hover:rotate-6 transition duration-300">
                    <i class="fas fa-cube text-4xl"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white">ุจูุงุจุฉ ุงูุฅุฏุงุฑุฉ</h2>
                <p class="text-slate-500 dark:text-slate-400 mt-2 font-medium">ูุธุงู ุงูููุงูุฉ ุงููุชุทูุฑ</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-5">
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400"><i class="fas fa-user"></i></span>
                        <input type="text" id="username" class="w-full pr-10 pl-4 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Username" required>
                    </div>
                </div>
                <div class="mb-8">
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">ูููุฉ ุงููุฑูุฑ</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400"><i class="fas fa-lock"></i></span>
                        <input type="password" id="password" class="w-full pr-10 pl-4 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="โขโขโขโขโขโขโขโข" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg shadow-indigo-500/30 transform active:scale-95">
                    ุชุณุฌูู ุงูุฏุฎูู <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 py-2 rounded-lg">
                ูุนูููุงุช ุชุฌุฑูุจูุฉ: admin / admin
            </div>
        </div>
    </section>

    <!-- 2. MAIN DASHBOARD -->
    <section id="dashboard-screen" class="hidden-section min-h-screen flex flex-col md:flex-row bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-slate-900 dark:bg-slate-950 text-white flex-shrink-0 flex flex-col shadow-2xl z-20 md:h-screen sticky top-0">
            <div class="p-6 flex items-center justify-between border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i class="fas fa-layer-group text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">ุงูููุงูุฉ</h1>
                        <span class="text-xs text-slate-400 font-normal">ููุญุฉ ุงูุชุญูู</span>
                    </div>
                </div>
                <button class="md:hidden text-slate-400 hover:text-white transition" onclick="toggleMobileMenu()"><i class="fas fa-bars text-xl"></i></button>
            </div>
            
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto hidden md:block">
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">ุฅุฏุงุฑุฉ ุงูุนูู</p>
                <button onclick="switchTab('orders')" id="nav-orders" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-clipboard-list"></i></span>
                    ุงูุทูุจุงุช ูุงูุนููุงุก
                </button>
                <button onclick="switchTab('deliveries')" id="nav-deliveries" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-pink-600 group-hover:text-white transition"><i class="fas fa-truck"></i></span>
                    ุงูุชุณูููุงุช ูุงูููุงุนูุฏ
                </button>
                <button onclick="switchTab('collections')" id="nav-collections" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-teal-600 group-hover:text-white transition"><i class="fas fa-money-bill-wave"></i></span>
                    ุงูุชุญุตููุงุช ูุงููุงููุฉ
                </button>
                <button onclick="switchTab('marketers')" id="nav-marketers" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-emerald-600 group-hover:text-white transition"><i class="fas fa-bullhorn"></i></span>
                    ุงููุณูููู ูุงููุณุจ
                </button>
                <button onclick="switchTab('designers')" id="nav-designers" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-palette"></i></span>
                    ุงููุตูููู
                </button>
                
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6">ุงููุธุงู</p>
                <button onclick="switchTab('users')" id="nav-users" id="users-tab-btn" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition"><i class="fas fa-users-cog"></i></span>
                    ุงููุณุชุฎุฏููู
                </button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn w-full text-right px-4 py-3.5 rounded-xl hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 font-medium group">
                    <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition"><i class="fas fa-database"></i></span>
                    ุงูุฅุนุฏุงุฏุงุช ูุงููุธุงู
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <button onclick="toggleDarkMode()" class="w-full mb-3 px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-moon"></i> ุงููุถุน ุงููููู
                </button>
                <button onclick="logout()" class="w-full px-4 py-3 rounded-xl bg-red-600/10 hover:bg-red-600 text-red-400 hover:text-white transition flex items-center justify-center gap-2 font-bold text-sm">
                    <i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุฎุฑูุฌ
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen relative">
            
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight" id="page-title">ููุญุฉ ุงูุชุญูู</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1" id="current-date"></p>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Notifications Bell -->
                    <div class="relative" id="notification-bell-container">
                        <button onclick="toggleNotificationMenu()" class="relative w-14 h-14 rounded-2xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 transition shadow-sm flex items-center justify-center group">
                            <i class="fas fa-bell text-xl group-hover:text-indigo-500 transition"></i>
                            <span id="notification-badge" class="absolute top-3 right-3 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800 hidden animate-pulse"></span>
                        </button>
                        
                        <div id="notification-menu" class="absolute left-0 mt-3 w-80 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 hidden z-50 overflow-hidden origin-top-left">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-800 dark:text-white text-sm">ุงูุชูุจููุงุช (ุชุฃุฎูุฑ ุงูุชุณููู)</h3>
                            </div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-lg" id="user-avatar">A</div>
                        <div class="hidden md:block px-2">
                            <div class="text-sm font-bold text-slate-800 dark:text-white" id="user-name-display">Admin</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">ูุฏูุฑ ุงููุธุงู</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATS CARDS -->
            <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8 fade-in">
                <!-- Total Orders -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุฅุฌูุงูู ุงูุทูุจุงุช</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="stat-total-orders">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center"><i class="fas fa-folder-open text-lg"></i></div>
                    </div>
                </div>
                <!-- Revenue -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุงูุฎุฒููุฉ (ุงููุฏููุน)</p>
                            <h3 class="text-2xl font-black text-emerald-600 dark:text-emerald-400 dir-ltr" id="stat-revenue">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center"><i class="fas fa-wallet text-lg"></i></div>
                    </div>
                </div>
                <!-- Net Profit -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุตุงูู ุงูุฑุจุญ</p>
                            <h3 class="text-2xl font-black text-blue-600 dark:text-blue-400 dir-ltr" id="stat-net-profit">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center"><i class="fas fa-chart-line text-lg"></i></div>
                    </div>
                </div>
                <!-- Debt (New Logic) -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ูุฏููููุงุช (ููุง)</p>
                            <h3 class="text-2xl font-black text-orange-500 dark:text-orange-400 dir-ltr" id="stat-debt">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center"><i class="fas fa-hand-holding-usd text-lg"></i></div>
                    </div>
                </div>
                <!-- Late Tasks -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุชุฃุฎูุฑุงุช (24H)</p>
                            <h3 class="text-2xl font-black text-red-600 dark:text-red-400" id="stat-late-tasks">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center"><i class="fas fa-alarm-clock text-lg"></i></div>
                    </div>
                </div>
            </div>

            <!-- CHARTS SECTION (New) -->
            <div id="charts-area" class="mb-8 fade-in space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">ุชูุฒูุน ุญุงูุงุช ุงูุทูุจุงุช</h3>
                        <div class="h-64 flex items-center justify-center relative">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">ุฃุนูู ุงููุณูููู ูุจูุนุงู</h3>
                        <div class="h-64 flex items-center justify-center relative">
                            <canvas id="marketerChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold text-slate-700 dark:text-slate-300 mb-4 text-sm">ุงูุฅูุฑุงุฏุงุช ุงูููููุฉ (ุขุฎุฑ 7 ุฃูุงู)</h3>
                    <div class="h-64 w-full relative">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TAB 1: ORDERS -->
            <div id="tab-orders" class="tab-content fade-in">
                <!-- Advanced Controls -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <div class="flex w-full md:w-auto gap-2">
                         <button onclick="openModal('order-modal')" class="flex-1 md:flex-none bg-indigo-600 text-white px-6 py-2.5 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition flex items-center justify-center gap-2 font-bold">
                            <i class="fas fa-plus"></i> <span class="hidden md:inline">ุทูุจ ุฌุฏูุฏ</span><span class="md:hidden">ุฅุถุงูุฉ</span>
                        </button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="filterToday()" class="relative px-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition shadow-sm whitespace-nowrap">
                            <i class="fas fa-calendar-day text-indigo-500"></i> ุทูุจุงุช ุงูููู
                            <span id="today-orders-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-sm">0</span>
                        </button>
                        <!-- Date Filter -->
                        <div class="relative w-full md:w-40">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-calendar-alt"></i></span>
                            <select id="filter-date" onchange="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white cursor-pointer appearance-none">
                                <option value="all">ูู ุงูุฃููุงุช</option>
                                <option value="today">ุงูููู</option>
                                <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
                                <option value="month">ูุฐุง ุงูุดูุฑ</option>
                            </select>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="relative w-full md:w-40">
                             <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-filter"></i></span>
                            <select id="filter-status" onchange="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white cursor-pointer appearance-none">
                                <option value="all">ูู ุงูุญุงูุงุช</option>
                                <option value="pending">ููุฏ ุงูุชูููุฐ</option>
                                <option value="review">ูุฑุงุฌุนุฉ</option>
                                <option value="done">ููุชูู</option>
                                <option value="rejected">ูุฑููุถ</option>
                            </select>
                        </div>

                        <!-- Search -->
                         <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-orders" onkeyup="renderOrders()" class="w-full pr-10 pl-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="ุจุญุซ (ุงุณูุ ุฑูู)...">
                        </div>
                    </div>
                </div>

                <!-- Responsive Table/Grid -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right responsive-table">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">ุงูุนููู</th>
                                    <th class="p-5">ุชูุงุตูู ุงูุฎุฏูุฉ</th>
                                    <th class="p-5">ุงููุงููุฉ</th>
                                    <th class="p-5 text-center">ุนุฑุจูู</th>
                                    <th class="p-5">ุงููุฑูู</th>
                                    <th class="p-5">ุงูุญุงูุฉ</th>
                                    <th class="p-5 text-center">ุชุญูู</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-orders-state" class="hidden p-10 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-400 mb-4">
                            <i class="fas fa-inbox text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-300">ูุง ุชูุฌุฏ ุทูุจุงุช</h3>
                        <p class="text-slate-500 dark:text-slate-500">ุญุงูู ุชุบููุฑ ุงูููุชุฑ ุฃู ุฃุถู ุทูุจ ุฌุฏูุฏ</p>
                    </div>
                </div>
            </div>

            <!-- TAB: DELIVERIES (New) -->
            <div id="tab-deliveries" class="tab-content hidden-section fade-in">
                <!-- Delivery Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุชุณูููุงุช ุงูููู</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="del-today-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center"><i class="fas fa-calendar-day"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ุชุณูููุงุช ุบุฏุงู</p>
                            <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="del-tmrw-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center"><i class="fas fa-sun"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase mb-1">ูุชุฃุฎุฑุฉ</p>
                            <h3 class="text-2xl font-black text-red-600 dark:text-red-400" id="del-late-count">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center"><i class="fas fa-exclamation-circle"></i></div>
                    </div>
                </div>

                <!-- Deliveries Table -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">ุฌุฏูู ุงูุชุณูููุงุช</h3>
                            <div class="text-sm text-slate-500">ูุฑุชุจุฉ ุญุณุจ ุงูุฃูุฑุจ ููุชุณููู</div>
                        </div>
                        <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-deliveries" onkeyup="renderDeliveries()" class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="ุจุญุซ ูู ุงูุชุณูููุงุช...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">ุชุงุฑูุฎ ุงูุชุณููู</th>
                                    <th class="p-5">ุงูุนููู</th>
                                    <th class="p-5">ุงูุฎุฏูุฉ</th>
                                    <th class="p-5">ุงููุชุจูู</th>
                                    <th class="p-5">ุงููุตูู</th>
                                    <th class="p-5">ุงูุญุงูุฉ</th>
                                    <th class="p-5 text-center">ุฅุฌุฑุงุก</th>
                                </tr>
                            </thead>
                            <tbody id="deliveries-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: COLLECTIONS (New) -->
            <div id="tab-collections" class="tab-content hidden-section fade-in">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">ุณุฌู ุงูุชุญุตููุงุช ูุงูุฏููู</h3>
                            <div class="text-sm text-slate-500">ูุนุฑุถ ูุฐุง ุงูุฌุฏูู ุงูุญุงูุฉ ุงููุงููุฉ ูุญุงูุฉ ุงูุทูุจ ููุท</div>
                        </div>
                        <div class="relative w-full md:w-64">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-collections" onkeyup="renderCollections()" class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="ุจุญุซ (ุนูููุ ุฑูู)...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-teal-50 dark:bg-teal-900/20 text-teal-800 dark:text-teal-400 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    <th class="p-5">ุฑูู ุงููุฑุฌุน</th>
                                    <th class="p-5">ุงูุนููู</th>
                                    <th class="p-5">ุงูุฎุฏูุฉ</th>
                                    <th class="p-5">ุฅุฌูุงูู ุงูุณุนุฑ</th>
                                    <th class="p-5 text-emerald-600">ุงููุฏููุน</th>
                                    <th class="p-5 text-red-500">ุงููุชุจูู (ุฏููู)</th>
                                    <th class="p-5">ุญุงูุฉ ุงูุทูุจ</th>
                                </tr>
                            </thead>
                            <tbody id="collections-table-body" class="text-sm divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-200"></tbody>
                            <tfoot id="collections-table-footer" class="bg-slate-50 dark:bg-slate-800 font-bold text-slate-800 dark:text-white border-t-2 border-slate-200 dark:border-slate-700"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 3: MARKETERS -->
            <div id="tab-marketers" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex gap-3">
                        <button onclick="openModal('staff-modal', 'marketer')" class="bg-emerald-600 text-white px-6 py-2.5 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition font-bold">
                            <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุณูู
                        </button>
                        <button onclick="openReportModal()" class="bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 px-6 py-2.5 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition font-bold">
                            <i class="fas fa-chart-pie text-emerald-500"></i> ุชูุฑูุฑ ุงูุนูููุงุช
                        </button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-marketers" onkeyup="renderMarketers()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="ุจุญุซ ุนู ูุณูู...">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="marketers-grid">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- TAB 4: DESIGNERS -->
            <div id="tab-designers" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('staff-modal', 'designer')" class="bg-purple-600 text-white px-6 py-2.5 rounded-xl hover:bg-purple-700 shadow-lg shadow-purple-500/30 transition font-bold">
                        <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุตูู
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-designers" onkeyup="renderDesigners()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 dark:text-white" placeholder="ุจุญุซ ุนู ูุตูู...">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6" id="designers-grid">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- TAB 5: USERS -->
            <div id="tab-users" class="tab-content hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button onclick="openModal('user-modal')" class="bg-slate-800 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl hover:bg-slate-900 shadow-lg transition font-bold">
                        <i class="fas fa-user-shield"></i> ุฅุถุงูุฉ ูุณุชุฎุฏู
                    </button>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 pointer-events-none"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-users" onkeyup="renderUsers()" class="w-full pr-10 pl-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="ุจุญุซ ุนู ูุณุชุฎุฏู...">
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden max-w-3xl mx-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                                <th class="p-4 text-slate-500 font-bold">ุงููุณุชุฎุฏู</th>
                                <th class="p-4 text-slate-500 font-bold">ุงูุตูุงุญูุฉ</th>
                                <th class="p-4 text-slate-500 font-bold">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 6: SETTINGS -->
            <div id="tab-settings" class="tab-content hidden-section fade-in">
                <div class="max-w-2xl mx-auto space-y-6">
                    
                    <!-- Change Password -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-key text-indigo-500"></i> ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
                        <form onsubmit="changePassword(event)" class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                                <input type="password" id="new-system-password" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 dark:text-white" required placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-bold transition">ุชุญุฏูุซ</button>
                        </form>
                    </div>

                    <!-- Activity Log -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-history text-slate-500"></i> ุณุฌู ุงููุดุงุทุงุช (ุขุฎุฑ 50 ุนูููุฉ)</h3>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto rounded-xl border border-slate-100 dark:border-slate-700">
                            <table class="w-full text-right">
                                <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3">ุงูุชูููุช</th>
                                        <th class="p-3">ุงููุณุชุฎุฏู</th>
                                        <th class="p-3">ุงูุญุฏุซ</th>
                                        <th class="p-3">ุงูุชูุงุตูู</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-log-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Backup -->
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2"><i class="fas fa-database text-orange-500"></i> ุงููุณุฎ ุงูุงุญุชูุงุทู</h3>
                        <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">
                            ุงูุจูุงูุงุช ูุญููุธุฉ ุนูู ูุฐุง ุงูุฌูุงุฒ ููุท. ูู ุจุชุญููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจุงูุชุธุงู.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="exportData()" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-indigo-200 dark:border-indigo-800 rounded-xl hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition group">
                                <i class="fas fa-download text-3xl text-indigo-400 group-hover:text-indigo-600 mb-3"></i>
                                <span class="font-bold text-indigo-700 dark:text-indigo-400">ุชุญููู ูุณุฎุฉ (Export)</span>
                            </button>
                            <label class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-emerald-200 dark:border-emerald-800 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition cursor-pointer group h-full">
                                <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                                <i class="fas fa-upload text-3xl text-emerald-400 group-hover:text-emerald-600 mb-3"></i>
                                <span class="font-bold text-emerald-700 dark:text-emerald-400">ุงุณุชุนุงุฏุฉ ูุณุฎุฉ (Import)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red-50 dark:bg-red-900/10 p-8 rounded-2xl shadow-sm border border-red-200 dark:border-red-900/30">
                        <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 border-b border-red-200 dark:border-red-800 pb-2"><i class="fas fa-exclamation-triangle"></i> ููุทูุฉ ุงูุฎุทุฑ</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-6 text-sm">
                            ุชุตููุฑ ุงููุธุงู ุณูููู ุจุญุฐู <strong>ุฌููุน ุงูุทูุจุงุช ูุงููุฏููุนุงุช ูุงูุชูุงุฑูุฑ</strong> ูุจุฏุก ููุณู ุฌุฏูุฏ. ูู ูุชู ุญุฐู ุญุณุงุจุงุช ุงูููุธููู ุฃู ุงููุณุชุฎุฏููู.
                        </p>
                        <button onclick="resetSystem()" class="w-full bg-red-600 text-white py-4 rounded-xl hover:bg-red-700 font-bold shadow-lg shadow-red-500/30 transition">ุชุตููุฑ ุงููุธุงู (ุจุฏุก ููุณู ุฌุฏูุฏ)</button>
                    </div>

                </div>
            </div>

        </main>
    </section>

    <!-- MODAL: ORDER -->
    <div id="order-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 md:p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white" id="modal-title">ุจูุงูุงุช ุงูุทูุจ</h3>
                <button onclick="closeModal('order-modal')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <form id="order-form" onsubmit="saveOrder(event)">
                <input type="hidden" id="order-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงุณู ุงูุนููู</label>
                        <input type="text" id="client-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition" required placeholder="ุงูุงุณู">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุฑูู ุงููุงุชู</label>
                        <input type="tel" id="client-phone" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition" placeholder="01xxxxxxxxx">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ููุน ุงูุฎุฏูุฉ</label>
                        <select id="service-type" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="ุณูุดูุงู ููุฏูุง">๐ฑ ุณูุดูุงู ููุฏูุง (Social Media)</option>
                            <option value="ุบูุงู">๐ผ๏ธ ุบูุงู (Cover)</option>
                            <option value="ุจูุณุชุฑ ูุฑุงุฌุนุฉ">๐ข ุจูุณุชุฑ ูุฑุงุฌุนุฉ</option>
                            <option value="ูุฑูุช ุดุฎุตูู">๐ ูุฑูุช ุดุฎุตูุฉ</option>
                            <option value="ุตูุฑ ูุตุบุฑุฉ">โถ๏ธ ุตูุฑ ูุตุบุฑุฉ (Thumbnails)</option>
                            <option value="ููุฌู">โ๏ธ ููุฌู (Logo)</option>
                            <option value="ุจุงูุฑ">๐ฉ ุจุงูุฑ (Banner)</option>
                            <option value="ุดูุงุฏุฉ">๐ ุดูุงุฏุฉ (Certificate)</option>
                            <option value="ูููู">๐ฝ๏ธ ูููู (Menu)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุชุงุฑูุฎ ุงูุชุณููู</label>
                        <input type="date" id="delivery-date" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุฅุฌูุงูู ุงูุณุนุฑ</label>
                        <input type="number" id="order-price" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white font-bold" placeholder="0.00" oninput="calculateRemaining(); calculateOrderCommission()">
                    </div>
                </div>

                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-2xl mb-5 border border-indigo-100 dark:border-indigo-800">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-end">
                        <div class="flex items-center gap-3 mb-2 md:mb-0 bg-white dark:bg-slate-800 p-3 rounded-xl border border-indigo-100 dark:border-indigo-900">
                            <input type="checkbox" id="deposit-paid" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                            <label for="deposit-paid" class="font-bold text-slate-700 dark:text-slate-300 cursor-pointer select-none">ุนุฑุจููุ</label>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-indigo-500 mb-1 uppercase">ุงููุฏููุน</label>
                            <input type="number" id="amount-paid" class="w-full bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-900 rounded-xl px-3 py-2 text-indigo-700 dark:text-indigo-400 font-bold" placeholder="0" oninput="calculateRemaining()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-red-500 mb-1 uppercase">ุงููุชุจูู</label>
                            <input type="text" id="amount-remaining" class="w-full bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900 rounded-xl px-3 py-2 text-red-600 dark:text-red-400 font-bold" readonly value="0">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงููุณูู</label>
                        <select id="order-marketer" onchange="calculateOrderCommission()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="">-- ูุจุงุดุฑ --</option>
                        </select>
                        <div id="order-commission-preview" class="text-xs font-bold text-emerald-600 mt-2 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงููุตูู</label>
                        <select id="order-designer" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="">-- ุงุฎุชุฑ ูุตูู --</option>
                        </select>
                    </div>
                </div>

                <div class="mb-5 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3"><i class="fas fa-layer-group text-indigo-500"></i> ุชูุงุตูู ุงูุชุตููู ูุงููููุงุช</label>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="text" id="design-link" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition text-sm" placeholder="๐ ุฑุงุจุท ูููุงุช ุงูุชุตููู (Google Drive / Dropbox / Images URL)">
                        <textarea id="design-notes" rows="2" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white transition text-sm" placeholder="๐ ููุงุญุธุงุช ุฅุถุงููุฉ ููุชุตููู..."></textarea>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงูุญุงูุฉ</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="pending" class="peer hidden" checked onchange="updateStatusSelect('pending')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-yellow-100 peer-checked:text-yellow-700 font-bold transition">ููุฏ ุงูุชูููุฐ</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="review" class="peer hidden" onchange="updateStatusSelect('review')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-blue-100 peer-checked:text-blue-700 font-bold transition">ูุฑุงุฌุนุฉ</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="done" class="peer hidden" onchange="updateStatusSelect('done')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-emerald-100 peer-checked:text-emerald-700 font-bold transition">ููุชูู</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status-radio" value="rejected" class="peer hidden" onchange="updateStatusSelect('rejected')">
                            <div class="py-2 text-center rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 peer-checked:bg-red-100 peer-checked:text-red-700 font-bold transition">ูุฑููุถ</div>
                        </label>
                    </div>
                    <select id="order-status" class="hidden"><option value="pending"></option></select>
                </div>

                <div class="flex gap-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3.5 rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-500/30 transition">ุญูุธ</button>
                    <button type="button" onclick="closeModal('order-modal')" class="px-8 py-3.5 border border-slate-200 dark:border-slate-700 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold transition">ุฅูุบุงุก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- STAFF MODAL -->
    <div id="staff-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl fade-in border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white" id="staff-modal-title">ุฅุถุงูุฉ ููุธู</h3>
            <form onsubmit="saveStaff(event)">
                <input type="hidden" id="staff-id">
                <input type="hidden" id="staff-role">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงูุงุณู</label>
                    <input type="text" id="staff-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุฑูู ุงููุงุชู</label>
                    <input type="text" id="staff-phone" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 dark:text-white">
                </div>
                
                <div id="marketer-fields" class="hidden p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl mb-4 border border-emerald-100 dark:border-emerald-900">
                    <label class="block text-sm font-bold text-emerald-800 dark:text-emerald-400 mb-2">ูุณุจุฉ ุงูุนูููุฉ (%)</label>
                    <input type="number" id="staff-commission" class="w-full bg-white dark:bg-slate-800 border border-emerald-200 dark:border-emerald-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="ูุซูุงู: 10">
                </div>

                <div id="designer-fields" class="hidden p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-4 border border-purple-100 dark:border-purple-900 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-800 dark:text-purple-400 mb-2">ุงูุชุฎุตุต</label>
                        <input type="text" id="staff-specialty" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-purple-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-purple-800 dark:text-purple-400 mb-2">ูุญูุธุฉ (ูุงุด)</label>
                        <input type="text" id="staff-wallet" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-purple-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 dark:text-white">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold">ุญูุธ</button>
                    <button type="button" onclick="closeModal('staff-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">ุฅุบูุงู</button>
                </div>
            </form>
        </div>
    </div>

    <!-- USER MODAL -->
    <div id="user-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white" id="user-modal-title">ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</h3>
            <form onsubmit="saveUser(event)">
                <input type="hidden" id="user-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="new-username" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ูููุฉ ุงููุฑูุฑ <span class="text-xs font-normal text-slate-400">(ุงุชุฑููุง ูุงุฑุบุฉ ุนูุฏ ุงูุชุนุฏูู ููุฅุจูุงุก ุนูููุง)</span></label>
                    <input type="text" id="new-password" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">ุตูุงุญูุงุช ุงููุตูู ููุตูุญุงุช</label>
                    <div class="grid grid-cols-2 gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="orders"><span class="text-sm text-slate-600 dark:text-slate-400">ุงูุทูุจุงุช</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="deliveries"><span class="text-sm text-slate-600 dark:text-slate-400">ุงูุชุณูููุงุช</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="collections"><span class="text-sm text-slate-600 dark:text-slate-400">ุงูุชุญุตููุงุช</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="marketers"><span class="text-sm text-slate-600 dark:text-slate-400">ุงููุณูููู</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="designers"><span class="text-sm text-slate-600 dark:text-slate-400">ุงููุตูููู</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="users"><span class="text-sm text-slate-600 dark:text-slate-400">ุงููุณุชุฎุฏููู</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="perm-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" value="settings"><span class="text-sm text-slate-600 dark:text-slate-400">ุงูุฅุนุฏุงุฏุงุช</span></label>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงูุฏูุฑ</label>
                    <select id="new-role" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-white">
                        <option value="assistant">ูุณุงุนุฏ (Assistant)</option>
                        <option value="admin">ูุฏูุฑ (Admin)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-slate-800 dark:bg-slate-700 text-white py-3 rounded-xl hover:bg-slate-900 dark:hover:bg-slate-600 font-bold">ุญูุธ ุงูุจูุงูุงุช</button>
                <button type="button" onclick="closeModal('user-modal')" class="w-full mt-2 py-3 text-slate-500 dark:text-slate-400">ุฅูุบุงุก</button>
            </form>
        </div>
    </div>

    <!-- PAYOUT MODAL -->
    <div id="payout-modal" class="fixed inset-0 bg-slate-900/80 hidden z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-8 shadow-2xl border border-slate-200 dark:border-slate-700 fade-in">
            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white">ุชุณุฌูู ุฏูุนุฉ ูุงููุฉ</h3>
            <form onsubmit="savePayout(event)">
                <input type="hidden" id="payout-staff-id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงูููุธู</label>
                    <input type="text" id="payout-staff-name" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 dark:text-slate-400" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุงููุจูุบ</label>
                    <input type="number" id="payout-amount" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white font-bold" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ุชุงุฑูุฎ ุงูุฏูุน</label>
                    <input type="date" id="payout-date" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ููุงุญุธุงุช</label>
                    <textarea id="payout-notes" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:text-white" rows="2" placeholder="ุฃู ุชูุงุตูู ุฅุถุงููุฉ..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl hover:bg-emerald-700 font-bold">ุชุณุฌูู</button>
                    <button type="button" onclick="closeModal('payout-modal')" class="px-6 py-3 border rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-slate-600 dark:text-slate-400">ุฅูุบุงุก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="report-modal" class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl p-8 shadow-2xl fade-in border border-slate-200 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-white">ุชูุฑูุฑ ุงูุนูููุงุช ุงูุดูุฑู</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">ุชุญููู ูุงูู ูุฃุฏุงุก ุงููุณูููู</p>
                </div>
                <button onclick="closeModal('report-modal')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-6 flex items-center gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                <label class="font-bold text-slate-700 dark:text-slate-300">ุงุฎุชุฑ ุงูุดูุฑ:</label>
                <input type="month" id="report-month" onchange="renderReportTable()" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-700 dark:text-white focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>

            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-3 border-r-4 border-emerald-500 pr-3">ุงููุณูููู (ุงูุนูููุงุช)</h4>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">ุงููุณูู</th>
                            <th class="p-4">ุฅุฌูุงูู ุงููุจูุนุงุช</th>
                            <th class="p-4 text-blue-600 dark:text-blue-400">ูุญุตูุฉ (ูู ุงููุฏููุน)</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">ุชู ุตุฑูู</th>
                            <th class="p-4 text-slate-500">ููุงุญุธุงุช ุงูุฏูุน</th>
                            <th class="p-4 text-center">ุชุณุฌูู ุฏูุน</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-900"></tbody>
                    <tfoot class="bg-slate-50 dark:bg-slate-800 font-bold text-slate-800 dark:text-white border-t-2 border-slate-200 dark:border-slate-700">
                        <tr id="report-table-footer"></tr>
                    </tfoot>
                </table>
            </div>

            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-3 mt-8 border-r-4 border-purple-500 pr-3">ุงููุตูููู (ุงููุฏููุนุงุช)</h4>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">ุงููุตูู</th>
                            <th class="p-4">ุงูุชุฎุตุต</th>
                            <th class="p-4 text-emerald-600 dark:text-emerald-400">ุชู ุตุฑูู (ูุฐุง ุงูุดูุฑ)</th>
                            <th class="p-4 text-slate-500">ููุงุญุธุงุช ุงูุฏูุน</th>
                            <th class="p-4 text-center">ุชุณุฌูู ุฏูุน</th>
                        </tr>
                    </thead>
                    <tbody id="report-designers-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-900"></tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl hover:bg-slate-900 transition font-bold flex items-center gap-2">
                    <i class="fas fa-print"></i> ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const defaultData = {
            users: [{ id: 1, username: 'admin', password: 'admin', role: 'admin' }],
            staff: [],
            orders: [],
            payouts: [],
            logs: []
        };

        let db = JSON.parse(localStorage.getItem('agencyDB')) || defaultData;
        if(!db.payouts) db.payouts = []; // Ensure payouts exists for old data
        if(!db.logs) db.logs = []; // Ensure logs exists
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

        // Chart Instances
        let statusChartInstance = null;
        let marketerChartInstance = null;
        let revenueChartInstance = null;

        // Dark Mode Logic
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            // Fix Chart.js colors on toggle
            if(Chart.defaults) {
                Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
                Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0';
            }
            if(currentUser) renderCharts(); // Re-render charts to update colors
        }
        
        // Init Dark Mode
        if(localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        // Date Display
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // --- AUTH ---
        function checkAuth() {
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            
            if (currentUser) {
                loginScreen.classList.add('hidden-section');
                dashboardScreen.classList.remove('hidden-section');
                
                document.getElementById('user-name-display').innerText = currentUser.username;
                document.getElementById('user-avatar').innerText = currentUser.username.charAt(0).toUpperCase();
                
                initDashboard();
            } else {
                loginScreen.classList.remove('hidden-section');
                dashboardScreen.classList.add('hidden-section');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const user = db.users.find(usr => usr.username === u && usr.password === p);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                checkAuth();
                showNotification('ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ', 'success');
            } else {
                showNotification('ุฎุทุฃ ูู ุงูุจูุงูุงุช', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            checkAuth();
        }

        // --- DASHBOARD ---
        function initDashboard() {
            renderOrders();
            renderStats();
            applyPermissions();
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'text-white'));
            document.getElementById('nav-orders').classList.add('bg-slate-800', 'text-white');
        }

        function switchTab(tabName) {
            // Permission Check
            if (currentUser.role !== 'admin' && currentUser.permissions && !currentUser.permissions.includes(tabName)) {
                showNotification('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐู ุงูุตูุญุฉ', 'error');
                return;
            }

            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('bg-slate-800', 'text-white');
                el.classList.add('text-slate-300');
            });

            document.getElementById(`tab-${tabName}`).classList.remove('hidden-section');
            document.getElementById(`nav-${tabName}`).classList.add('bg-slate-800', 'text-white');
            document.getElementById(`nav-${tabName}`).classList.remove('text-slate-300');

            document.getElementById('page-title').innerText = document.getElementById(`nav-${tabName}`).innerText.trim();
            
            if(tabName === 'orders') {
                document.getElementById('stats-overview').classList.remove('hidden');
                document.getElementById('charts-area').classList.remove('hidden');
            } else {
                document.getElementById('stats-overview').classList.add('hidden');
                document.getElementById('charts-area').classList.add('hidden');
            }
            
            if(tabName === 'marketers') renderMarketers();
            if(tabName === 'collections') renderCollections();
            if(tabName === 'deliveries') renderDeliveries();
            if(tabName === 'designers') renderDesigners();
            if(tabName === 'users') renderUsers();
            if(tabName === 'settings') renderLogs();
        }

        function applyPermissions() {
            const allTabs = ['orders', 'deliveries', 'collections', 'marketers', 'designers', 'users', 'settings'];
            
            if (currentUser.role === 'admin') {
                allTabs.forEach(t => document.getElementById('nav-' + t)?.classList.remove('hidden'));
            } else {
                const perms = currentUser.permissions || [];
                allTabs.forEach(t => {
                    const el = document.getElementById('nav-' + t);
                    if(perms.includes(t)) el?.classList.remove('hidden');
                    else el?.classList.add('hidden');
                });
            }
        }

        function toggleMobileMenu() {
            document.getElementById('sidebar-nav').classList.toggle('hidden');
        }

        // --- ORDERS LOGIC ---
        function renderOrders() {
            const tbody = document.getElementById('orders-table-body');
            const search = document.getElementById('search-orders').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;
            const filterDate = document.getElementById('filter-date').value;
            const emptyState = document.getElementById('empty-orders-state');
            
            tbody.innerHTML = '';

            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

            const filteredOrders = db.orders.filter(order => {
                const matchesSearch = order.client.toLowerCase().includes(search) || order.phone.includes(search);
                const matchesStatus = filterStatus === 'all' || order.status === filterStatus;
                
                let matchesDate = true;
                const orderDate = new Date(order.dateCreated);
                if(filterDate === 'today') matchesDate = orderDate.toDateString() === new Date().toDateString();
                if(filterDate === 'week') matchesDate = orderDate >= startOfWeek;
                if(filterDate === 'month') matchesDate = orderDate >= startOfMonth;

                return matchesSearch && matchesStatus && matchesDate;
            }).sort((a, b) => b.id - a.id);

            if (filteredOrders.length === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            filteredOrders.forEach(order => {
                const marketer = db.staff.find(s => s.id == order.marketerId)?.name || '<span class="text-slate-400">ูุจุงุดุฑ</span>';
                const designer = db.staff.find(s => s.id == order.designerId)?.name || '<span class="text-slate-400">---</span>';
                
                let statusBadge = '';
                if(order.status === 'pending') statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400">โณ ููุฏ ุงูุชูููุฐ</span>';
                else if(order.status === 'done') statusBadge = '<span class="status-badge bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">โ ููุชูู</span>';
                else if(order.status === 'rejected') statusBadge = '<span class="status-badge bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">โ ูุฑููุถ</span>';
                else statusBadge = '<span class="status-badge bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">๐ ูุฑุงุฌุนุฉ</span>';

                const depositBadge = order.deposit 
                    ? '<span class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 flex items-center justify-center mx-auto"><i class="fas fa-check"></i></span>' 
                    : '<span class="w-8 h-8 rounded-full bg-slate-100 text-slate-300 dark:bg-slate-700 dark:text-slate-500 flex items-center justify-center mx-auto"><i class="fas fa-times"></i></span>';

                let rowClass = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                
                if (order.deliveryDate && order.status !== 'done' && order.status !== 'rejected') {
                    const now = new Date();
                    const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                    const tmrw = new Date(now);
                    tmrw.setDate(tmrw.getDate() + 1);
                    const tomorrow = tmrw.getFullYear() + '-' + String(tmrw.getMonth() + 1).padStart(2, '0') + '-' + String(tmrw.getDate()).padStart(2, '0');

                    if (order.deliveryDate < today) rowClass = "bg-red-100/60 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 transition border-b border-red-200 dark:border-red-800 last:border-0";
                    else if (order.deliveryDate === today) rowClass = "bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/20 transition border-b border-red-100 dark:border-red-900/30 last:border-0";
                    else if (order.deliveryDate === tomorrow) rowClass = "bg-orange-50 hover:bg-orange-100 dark:bg-orange-900/10 dark:hover:bg-orange-900/20 transition border-b border-orange-100 dark:border-orange-900/30 last:border-0";
                }

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="p-5" data-label="ุงูุนููู">
                        <div>
                            <div class="font-bold text-slate-800 dark:text-slate-100">${order.client}</div>
                            <div class="text-xs text-slate-400 font-mono mt-1">${order.phone}</div>
                        </div>
                    </td>
                    <td class="p-5" data-label="ุงูุฎุฏูุฉ">
                        <span class="bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 px-2 py-1 rounded text-xs font-bold">${order.service}</span>
                        ${order.deliveryDate ? `<div class="text-xs text-slate-500 mt-1"><i class="fas fa-calendar-alt ml-1"></i> ${order.deliveryDate}</div>` : ''}
                        ${order.designNotes ? `<div class="text-[10px] text-slate-500 mt-1 bg-slate-50 dark:bg-slate-800 p-1 rounded border border-slate-100 dark:border-slate-700 truncate max-w-[150px]" title="${order.designNotes}"><i class="fas fa-sticky-note text-yellow-500"></i> ${order.designNotes}</div>` : ''}
                        ${order.designLink ? `<a href="${order.designLink}" target="_blank" class="text-[10px] text-blue-500 hover:underline mt-1 block"><i class="fas fa-link"></i> ุฑุงุจุท ุงููููุงุช</a>` : ''}
                    </td>
                    <td class="p-5" data-label="ุงููุงููุฉ">
                        <div>
                            <div class="font-bold text-slate-800 dark:text-slate-200">${parseFloat(order.price).toLocaleString()} ุฌ.ู</div>
                            ${(order.price - order.paid) > 0 ? `<div class="text-xs text-red-500 font-bold mt-1">ูุฏููููุฉ: ${(order.price - order.paid)}</div>` : '<div class="text-xs text-emerald-500 font-bold mt-1">ุฎุงูุต</div>'}
                        </div>
                    </td>
                    <td class="p-5 text-center" data-label="ุงูุนุฑุจูู">${depositBadge}</td>
                    <td class="p-5" data-label="ุงููุฑูู">
                        <div class="text-xs text-slate-500 dark:text-slate-400 mb-1"><i class="fas fa-bullhorn w-4"></i> ${marketer}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400"><i class="fas fa-paint-brush w-4"></i> ${designer}</div>
                    </td>
                    <td class="p-5" data-label="ุงูุญุงูุฉ">${statusBadge}</td>
                    <td class="p-5 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editOrder(${order.id})" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="printInvoice(${order.id})" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400 hover:bg-slate-200 transition" title="ุทุจุงุนุฉ ูุงุชูุฑุฉ"><i class="fas fa-print"></i></button>
                            <button onclick="sendWhatsApp(${order.id})" class="w-8 h-8 rounded-lg bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400 hover:bg-green-100 transition" title="ุฅุฑุณุงู ูุงุชุณุงุจ"><i class="fab fa-whatsapp"></i></button>
                            ${currentUser.role === 'admin' ? `<button onclick="deleteOrder(${order.id})" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 dark:bg-red-900/30 dark:text-red-400 hover:bg-red-100 transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterToday() {
            document.getElementById('filter-date').value = 'today';
            renderOrders();
        }

        function updateStatusSelect(val) {
            document.getElementById('order-status').value = val;
        }

        function saveOrder(e) {
            e.preventDefault();
            const id = document.getElementById('order-id').value;
            const statusRadio = document.querySelector('input[name="status-radio"]:checked').value;
            
            const newOrder = {
                client: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                service: document.getElementById('service-type').value,
                deliveryDate: document.getElementById('delivery-date').value,
                designLink: document.getElementById('design-link').value,
                designNotes: document.getElementById('design-notes').value,
                price: parseFloat(document.getElementById('order-price').value) || 0,
                paid: parseFloat(document.getElementById('amount-paid').value) || 0,
                deposit: document.getElementById('deposit-paid').checked,
                marketerId: document.getElementById('order-marketer').value,
                designerId: document.getElementById('order-designer').value,
                status: statusRadio
            };

            let dateCreated = Date.now();
            let dateAssigned = null;

            if (id) {
                const index = db.orders.findIndex(o => o.id == id);
                const existing = db.orders[index];
                dateCreated = existing.dateCreated;
                dateAssigned = existing.dateAssigned;
                if ((!existing.designerId && newOrder.designerId) || (existing.designerId && newOrder.designerId && existing.designerId != newOrder.designerId)) {
                    dateAssigned = Date.now();
                }
                db.orders[index] = { ...existing, ...newOrder, dateAssigned };
                logActivity('ุชุนุฏูู ุทูุจ', `ุชู ุชุนุฏูู ุจูุงูุงุช ุงูุทูุจ #${id} ููุนููู ${newOrder.client}`);
            } else {
                if (newOrder.designerId) dateAssigned = Date.now();
                const newId = Date.now();
                db.orders.push({ id: newId, ...newOrder, dateCreated, dateAssigned });
                logActivity('ุฅุถุงูุฉ ุทูุจ', `ุชู ุฅุถุงูุฉ ุทูุจ ุฌุฏูุฏ #${newId} ููุนููู ${newOrder.client}`);
            }

            saveDB();
            closeModal('order-modal');
            renderOrders();
            showNotification('ุชู ุงูุญูุธ', 'success');
        }

        function editOrder(id) {
            const order = db.orders.find(o => o.id == id);
            if (!order) return;

            populateStaffSelects();
            document.getElementById('order-id').value = order.id;
            document.getElementById('client-name').value = order.client;
            document.getElementById('client-phone').value = order.phone;
            document.getElementById('service-type').value = order.service;
            document.getElementById('delivery-date').value = order.deliveryDate || '';
            document.getElementById('design-link').value = order.designLink || '';
            document.getElementById('design-notes').value = order.designNotes || '';
            document.getElementById('order-price').value = order.price;
            document.getElementById('amount-paid').value = order.paid;
            document.getElementById('deposit-paid').checked = order.deposit;
            document.getElementById('order-marketer').value = order.marketerId || "";
            document.getElementById('order-designer').value = order.designerId || "";
            
            const radios = document.getElementsByName('status-radio');
            radios.forEach(r => { if(r.value === order.status) r.checked = true; });
            document.getElementById('order-status').value = order.status;

            calculateRemaining();
            calculateOrderCommission();
            document.getElementById('modal-title').innerText = "ุชุนุฏูู ุงูุทูุจ";
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function deleteOrder(id) {
            if(confirm('ุญุฐู ูุฐุง ุงูุทูุจุ')) {
                const order = db.orders.find(o => o.id == id);
                db.orders = db.orders.filter(o => o.id != id);
                saveDB(); renderOrders();
                logActivity('ุญุฐู ุทูุจ', `ุชู ุญุฐู ุงูุทูุจ #${id} ููุนููู ${order ? order.client : 'ุบูุฑ ูุนุฑูู'}`);
                showNotification('ุชู ุงูุญุฐู', 'warning');
            }
        }

        function calculateRemaining() {
            const price = parseFloat(document.getElementById('order-price').value) || 0;
            const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
            const rem = price - paid;
            const el = document.getElementById('amount-remaining');
            el.value = rem.toFixed(2);
            if(rem <= 0) { el.classList.remove('text-red-600', 'bg-red-50'); el.classList.add('text-emerald-600', 'bg-emerald-50'); }
            else { el.classList.add('text-red-600', 'bg-red-50'); el.classList.remove('text-emerald-600', 'bg-emerald-50'); }
        }

        function calculateOrderCommission() {
            const marketerId = document.getElementById('order-marketer').value;
            const price = parseFloat(document.getElementById('order-price').value) || 0;
            const displayEl = document.getElementById('order-commission-preview');
            
            if(!marketerId) {
                displayEl.classList.add('hidden');
                return;
            }

            const marketer = db.staff.find(s => s.id == marketerId);
            if(marketer && marketer.commission) {
                const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
                const totalComm = (price * parseFloat(marketer.commission)) / 100;
                const currentComm = (paid * parseFloat(marketer.commission)) / 100;
                displayEl.innerHTML = `<i class="fas fa-coins ml-1"></i> ุนูููุฉ ุญุงููุฉ (ูู ุงูุนุฑุจูู/ุงููุฏููุน): ${currentComm.toLocaleString()} ุฌ.ู <span class="text-slate-400">| ุงููููุฉ: ${totalComm.toLocaleString()}</span>`;
                displayEl.classList.remove('hidden');
            } else {
                displayEl.classList.add('hidden');
            }
        }

        // --- DELIVERIES LOGIC ---
        function renderDeliveries() {
            const tbody = document.getElementById('deliveries-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-deliveries').value.toLowerCase();

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            // Filter orders that have a delivery date and are not rejected
            // Sort by delivery date ascending (earliest first)
            const deliveryOrders = db.orders
                .filter(o => o.deliveryDate && o.status !== 'rejected' && (o.status !== 'done' || o.deliveryDate === todayStr) &&
                             (o.client.toLowerCase().includes(search) || o.service.toLowerCase().includes(search))
                )
                .sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));

            // Stats Calculation
            const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1);
            const tmrwStr = tmrw.toISOString().split('T')[0];

            let todayCount = 0;
            let tmrwCount = 0;
            let lateCount = 0;

            deliveryOrders.forEach(order => {
                if (order.deliveryDate === todayStr) todayCount++;
                else if (order.deliveryDate === tmrwStr) tmrwCount++;
                else if (order.deliveryDate < todayStr) lateCount++;

                const designer = db.staff.find(s => s.id == order.designerId)?.name || '<span class="text-slate-400">---</span>';
                const remaining = order.price - order.paid;
                
                let dateClass = "text-slate-700 dark:text-slate-300";
                let dateIcon = "fa-calendar-alt";
                if (order.deliveryDate < todayStr) { dateClass = "text-red-600 font-bold"; dateIcon = "fa-exclamation-circle"; }
                else if (order.deliveryDate === todayStr) { dateClass = "text-indigo-600 font-bold"; dateIcon = "fa-star"; }
                else if (order.deliveryDate === tmrwStr) { dateClass = "text-orange-500 font-bold"; dateIcon = "fa-clock"; }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="p-5">
                        <div class="${dateClass} flex items-center gap-2">
                            <i class="fas ${dateIcon}"></i>
                            <span dir="ltr">${order.deliveryDate}</span>
                        </div>
                    </td>
                    <td class="p-5 font-bold">${order.client}</td>
                    <td class="p-5"><span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs">${order.service}</span></td>
                    <td class="p-5 ${remaining > 0 ? 'text-red-500 font-bold' : 'text-emerald-500'}">${remaining > 0 ? remaining.toLocaleString() + ' ุฌ.ู' : 'ุฎุงูุต'}</td>
                    <td class="p-5 text-sm">${designer}</td>
                    <td class="p-5">
                        <span class="px-2 py-1 rounded text-xs font-bold ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : (order.status === 'done' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700')}">
                            ${order.status === 'pending' ? 'ููุฏ ุงูุชูููุฐ' : (order.status === 'done' ? 'ููุชูู' : 'ูุฑุงุฌุนุฉ')}
                        </span>
                    </td>
                    <td class="p-5 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editOrder(${order.id})" class="text-blue-500 hover:text-blue-700 transition" title="ุชุนุฏูู"><i class="fas fa-edit"></i></button>
                            <button onclick="sendDeliveryWhatsApp(${order.id})" class="text-green-500 hover:text-green-700 transition" title="ุฅุฑุณุงู ูุงุชุณุงุจ (ุชุณููู)"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('del-today-count').innerText = todayCount;
            document.getElementById('del-tmrw-count').innerText = tmrwCount;
            document.getElementById('del-late-count').innerText = lateCount;

            if(deliveryOrders.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">ูุง ุชูุฌุฏ ุชุณูููุงุช ูุงุฏูุฉ</td></tr>';
        }

        // --- COLLECTIONS LOGIC ---
        function renderCollections() {
            const tbody = document.getElementById('collections-table-body');
            const tfoot = document.getElementById('collections-table-footer');
            const search = document.getElementById('search-collections').value.toLowerCase();
            tbody.innerHTML = '';
            
            let totalPrices = 0;
            let totalPaid = 0;
            let totalDebt = 0;

            const sortedOrders = db.orders
                .filter(o => o.client.toLowerCase().includes(search) || o.id.toString().includes(search))
                .sort((a, b) => b.dateCreated - a.dateCreated);

            sortedOrders.forEach(order => {
                const remaining = order.price - order.paid;
                totalPrices += parseFloat(order.price);
                totalPaid += parseFloat(order.paid);
                totalDebt += remaining;

                let statusText = '';
                let statusColor = '';
                if(order.status === 'pending') { statusText = 'ููุฏ ุงูุชูููุฐ'; statusColor = 'text-yellow-600'; }
                else if(order.status === 'done') { statusText = 'ููุชูู'; statusColor = 'text-emerald-600'; }
                else if(order.status === 'rejected') { statusText = 'ูุฑููุถ'; statusColor = 'text-red-600'; }
                else { statusText = 'ูุฑุงุฌุนุฉ'; statusColor = 'text-blue-600'; }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="p-5 font-mono text-slate-500">#${order.id}</td>
                    <td class="p-5 font-bold text-slate-800 dark:text-slate-200">${order.client}</td>
                    <td class="p-5"><span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs">${order.service}</span></td>
                    <td class="p-5 font-bold">${parseFloat(order.price).toLocaleString()} ุฌ.ู</td>
                    <td class="p-5 text-emerald-600 font-bold">${parseFloat(order.paid).toLocaleString()} ุฌ.ู</td>
                    <td class="p-5 font-bold ${remaining > 0 ? 'text-red-500' : 'text-slate-400'}">${remaining > 0 ? remaining.toLocaleString() + ' ุฌ.ู' : '-'}</td>
                    <td class="p-5 font-bold ${statusColor}">${statusText}</td>
                `;
                tbody.appendChild(tr);
            });

            tfoot.innerHTML = `
                <tr>
                    <td colspan="3" class="p-5 text-left">ุงูุฅุฌูุงููุงุช</td>
                    <td class="p-5">${totalPrices.toLocaleString()} ุฌ.ู</td>
                    <td class="p-5 text-emerald-600">${totalPaid.toLocaleString()} ุฌ.ู</td>
                    <td class="p-5 text-red-500">${totalDebt.toLocaleString()} ุฌ.ู</td>
                    <td></td>
                </tr>
            `;
        }

        // --- DESIGNERS ---
        function renderDesigners() {
            const container = document.getElementById('designers-grid');
            container.innerHTML = '';
            const search = document.getElementById('search-designers').value.toLowerCase();
            
            db.staff.filter(s => s.type === 'designer' && (s.name.toLowerCase().includes(search) || s.specialty.toLowerCase().includes(search))).forEach(d => {
                const activeTasks = db.orders.filter(o => o.designerId == d.id && (o.status === 'pending' || o.status === 'review'));
                const completedTasks = db.orders.filter(o => o.designerId == d.id && o.status === 'done');

                let tasksHtml = '';
                if(activeTasks.length > 0) {
                    tasksHtml = '<div class="space-y-4 mt-4">';
                    activeTasks.forEach(t => {
                        const now = Date.now();
                        const timeElapsed = t.dateAssigned ? (now - t.dateAssigned) : 0;
                        const hoursElapsed = timeElapsed / (1000 * 60 * 60);
                        const percent = Math.min((hoursElapsed / 24) * 100, 100);
                        let colorClass = 'bg-emerald-500';
                        if(percent > 50) colorClass = 'bg-yellow-500';
                        if(percent > 90) colorClass = 'bg-red-500';

                        tasksHtml += `
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-sm text-slate-700 dark:text-slate-200">${t.client}</span>
                                    <span class="text-xs bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 px-2 py-0.5 rounded">${t.service}</span>
                                </div>
                                <div class="progress-bar-container bg-slate-200 dark:bg-slate-700">
                                    <div class="progress-bar-fill ${colorClass}" style="width: ${percent}%"></div>
                                </div>
                                <div class="flex justify-between mt-1 text-[10px] font-bold text-slate-400">
                                    <span>ูุฑู ${Math.floor(hoursElapsed)}ุณ</span>
                                    <span>24ุณ</span>
                                </div>
                            </div>
                        `;
                    });
                    tasksHtml += '</div>';
                } else {
                    tasksHtml = `<div class="text-center py-4 text-slate-400 text-sm">ูุง ููุงู ูุดุทุฉ</div>`;
                }

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 flex items-center justify-center text-xl font-bold">${d.name.charAt(0)}</div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 dark:text-white">${d.name}</h3>
                                <p class="text-purple-600 dark:text-purple-400 text-sm">${d.specialty}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editStaff(${d.id})" class="text-slate-300 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                            ${currentUser.role === 'admin' ? `<button onclick="deleteStaff(${d.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <div class="bg-slate-50 dark:bg-slate-700 p-2 rounded-xl text-center"><div class="text-lg font-bold text-purple-600 dark:text-purple-400">${activeTasks.length}</div><div class="text-xs text-slate-400">ุฌุงุฑู</div></div>
                        <div class="bg-slate-50 dark:bg-slate-700 p-2 rounded-xl text-center"><div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${completedTasks.length}</div><div class="text-xs text-slate-400">ููุฌุฒ</div></div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">${tasksHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        // --- MARKETERS ---
        function renderMarketers() {
            const container = document.getElementById('marketers-grid');
            container.innerHTML = '';
            const search = document.getElementById('search-marketers').value.toLowerCase();
            
            db.staff.filter(s => s.type === 'marketer' && (s.name.toLowerCase().includes(search) || s.phone.includes(search))).forEach(m => {
                const mOrders = db.orders.filter(o => o.marketerId == m.id && o.status !== 'rejected');
                const totalSales = mOrders.reduce((sum, o) => sum + parseFloat(o.price), 0);
                const totalPaid = mOrders.reduce((sum, o) => sum + parseFloat(o.paid), 0);
                // Commission based on COLLECTED amounts (Deposits + Full Payments)
                const commissionVal = (totalPaid * (parseFloat(m.commission) || 0)) / 100;

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 card-hover relative overflow-hidden";
                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-green-600"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-bold text-xl text-slate-800 dark:text-white">${m.name}</h3>
                            <p class="text-sm text-slate-500">${m.phone}</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-bold px-3 py-1 rounded-lg text-sm">%${m.commission}</div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">ุงูุทูุจุงุช</span>
                            <span class="font-bold text-slate-800 dark:text-white">${mOrders.length}</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">ุงููุจูุนุงุช</span>
                            <span class="font-bold text-slate-800 dark:text-white">${totalSales.toLocaleString()} ุฌ.ู</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">ุงูุชุญุตููุงุช (ุนุฑุจูู/ูุงูู)</span>
                            <span class="font-bold text-emerald-600 dark:text-emerald-400">${totalPaid.toLocaleString()} ุฌ.ู</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-emerald-600 text-white rounded-xl shadow-lg mt-2">
                            <span class="font-bold text-emerald-100">ุงูุนูููุฉ</span>
                            <span class="font-bold text-xl">${commissionVal.toLocaleString()} ุฌ.ู</span>
                        </div>
                    </div>
                    <div class="absolute top-4 left-4 flex gap-2">
                        <button onclick="editStaff(${m.id})" class="text-slate-300 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteStaff(${m.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "agency_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
            showNotification('ุชู ุชุญููู ุงููุณุฎุฉ', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.users && json.orders) {
                        if(confirm('ุงุณุชุจุฏุงู ุงูุจูุงูุงุชุ')) {
                            db = json; saveDB(); location.reload();
                        }
                    } else showNotification('ููู ุบูุฑ ุตุงูุญ', 'error');
                } catch(err) { showNotification('ุฎุทุฃ ูู ุงูููู', 'error'); }
            };
            reader.readAsText(file);
        }
        
        function changePassword(e) {
            e.preventDefault();
            const newPass = document.getElementById('new-system-password').value;
            if(!newPass) return;
            
            if(currentUser) {
                const userIdx = db.users.findIndex(u => u.id === currentUser.id);
                if(userIdx !== -1) {
                    db.users[userIdx].password = newPass;
                    currentUser.password = newPass;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    saveDB();
                    showNotification('ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ', 'success');
                    document.getElementById('new-system-password').value = '';
                }
            }
        }

        function resetSystem() {
            if(confirm('ูู ุฃูุช ูุชุฃูุฏ ุชูุงูุงูุ ุณูุชู ุญุฐู ุฌููุน ุงูุทูุจุงุช ูุงููุฏููุนุงุช ูุจุฏุก ููุณู ุฌุฏูุฏ! ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
                if(confirm('ุชุฃููุฏ ููุงุฆู: ูู ุชุฑูุฏ ุชุตููุฑ ุงููุธุงูุ')) {
                    db.orders = [];
                    db.payouts = [];
                    saveDB();
                    location.reload();
                }
            }
        }

        // --- ACTIVITY LOG LOGIC ---
        function logActivity(action, details) {
            if(!db.logs) db.logs = [];
            const user = currentUser ? currentUser.username : 'System';
            db.logs.unshift({
                id: Date.now(),
                user,
                action,
                details,
                timestamp: Date.now()
            });
            // Keep only last 1000 logs to prevent storage bloat
            if(db.logs.length > 1000) db.logs = db.logs.slice(0, 1000);
            // Note: saveDB() is usually called after this in the parent function
        }

        function renderLogs() {
            const container = document.getElementById('activity-log-body');
            if(!container) return;
            container.innerHTML = '';
            const logs = db.logs || [];
            
            if(logs.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">ูุง ููุฌุฏ ูุดุงุทุงุช ูุณุฌูุฉ</td></tr>';
                return;
            }

            logs.slice(0, 50).forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('ar-EG');
                let actionClass = 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
                if(log.action.includes('ุฅุถุงูุฉ')) actionClass = 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400';
                if(log.action.includes('ุชุนุฏูู')) actionClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
                if(log.action.includes('ุญุฐู')) actionClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';

                container.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition text-sm">
                        <td class="p-3 text-slate-500 dark:text-slate-400 font-mono text-xs">${date}</td>
                        <td class="p-3 font-bold text-slate-800 dark:text-slate-200">${log.user}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${actionClass}">${log.action}</span></td>
                        <td class="p-3 text-slate-600 dark:text-slate-300">${log.details}</td>
                    </tr>
                `;
            });
        }

        // --- UTILS ---
        function saveDB() {
            localStorage.setItem('agencyDB', JSON.stringify(db));
            renderStats();
        }

        function saveStaff(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            const type = document.getElementById('staff-role').value;
            const name = document.getElementById('staff-name').value;
            const phone = document.getElementById('staff-phone').value;
            let extraData = {};
            if(type === 'marketer') extraData.commission = document.getElementById('staff-commission').value;
            else {
                extraData.specialty = document.getElementById('staff-specialty').value;
                extraData.wallet = document.getElementById('staff-wallet').value;
            }
            
            if (id) {
                const index = db.staff.findIndex(s => s.id == id);
                if (index !== -1) {
                    db.staff[index] = { ...db.staff[index], name, phone, ...extraData };
                }
            } else {
                db.staff.push({ id: Date.now(), name, type, phone, ...extraData });
            }
            
            saveDB(); closeModal('staff-modal');
            if(type === 'marketer') renderMarketers(); else renderDesigners();
            showNotification('ุชู ุงูุญูุธ ุจูุฌุงุญ', 'success');
        }

        function editStaff(id) {
            const staff = db.staff.find(s => s.id == id);
            if(!staff) return;
            
            openModal('staff-modal', staff.type);
            document.getElementById('staff-id').value = staff.id;
            document.getElementById('staff-name').value = staff.name;
            document.getElementById('staff-phone').value = staff.phone;
            document.getElementById('staff-modal-title').innerText = "ุชุนุฏูู ุจูุงูุงุช ุงูููุธู";

            if(staff.type === 'marketer') {
                document.getElementById('staff-commission').value = staff.commission;
            } else {
                document.getElementById('staff-specialty').value = staff.specialty;
                document.getElementById('staff-wallet').value = staff.wallet;
            }
        }

        function deleteStaff(id) {
            if(confirm('ุญุฐู ุงูููุธูุ')) {
                db.staff = db.staff.filter(s => s.id != id);
                saveDB();
                if(!document.getElementById('tab-marketers').classList.contains('hidden-section')) renderMarketers();
                if(!document.getElementById('tab-designers').classList.contains('hidden-section')) renderDesigners();
            }
        }
        
        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const r = document.getElementById('new-role').value;
            
            // Collect Permissions
            const perms = [];
            document.querySelectorAll('.perm-checkbox:checked').forEach(cb => perms.push(cb.value));

            if (id) {
                // Edit Mode
                const index = db.users.findIndex(usr => usr.id == id);
                if (index !== -1) {
                    const existing = db.users[index];
                    // Check duplicate username if changed
                    if (existing.username !== u && db.users.find(usr => usr.username === u)) { showNotification('ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ุจุงููุนู', 'error'); return; }
                    
                    db.users[index] = { 
                        ...existing, 
                        username: u, 
                        role: r, 
                        permissions: perms,
                        password: p ? p : existing.password // Update password only if provided
                    };
                }
            } else {
                // Add Mode
                if(db.users.find(usr => usr.username === u)) { showNotification('ุงููุณุชุฎุฏู ููุฌูุฏ', 'error'); return; }
                if(!p) { showNotification('ูููุฉ ุงููุฑูุฑ ูุทููุจุฉ', 'error'); return; }
                db.users.push({ id: Date.now(), username: u, password: p, role: r, permissions: perms });
            }

            saveDB(); closeModal('user-modal'); renderUsers();
            showNotification('ุชู ุงูุญูุธ ุจูุฌุงุญ', 'success');
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('search-users').value.toLowerCase();
            
            db.users.filter(u => u.username.toLowerCase().includes(search)).forEach(u => {
                const permsCount = u.role === 'admin' ? 'ุงููู' : (u.permissions ? u.permissions.length : 0);
                tbody.innerHTML += `
                    <tr class="border-b border-slate-50 dark:border-slate-700 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700">
                        <td class="p-4 font-bold text-slate-700 dark:text-slate-200">${u.username}</td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-full ${u.role === 'admin' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400'} text-xs font-bold">${u.role === 'admin' ? 'ูุฏูุฑ ูุงูู' : 'ูุณุงุนุฏ'}</span>
                            ${u.role !== 'admin' ? `<span class="text-xs text-slate-400 mr-2">(${permsCount} ุตูุงุญูุงุช)</span>` : ''}
                        </td>
                        <td class="p-4">
                            <div class="flex gap-3">
                                <button onclick="editUser(${u.id})" class="text-blue-400 hover:text-blue-600 transition"><i class="fas fa-edit"></i></button>
                                ${u.username !== 'admin' ? `<button onclick="deleteUser(${u.id})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>` : '<span class="text-slate-300"><i class="fas fa-lock"></i></span>'}
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if(!user) return;

            document.getElementById('user-id').value = user.id;
            document.getElementById('new-username').value = user.username;
            document.getElementById('new-password').value = ''; // Don't show password
            document.getElementById('new-role').value = user.role;
            document.getElementById('user-modal-title').innerText = "ุชุนุฏูู ุงููุณุชุฎุฏู";

            // Set Permissions
            const perms = user.permissions || [];
            document.querySelectorAll('.perm-checkbox').forEach(cb => {
                cb.checked = perms.includes(cb.value);
            });

            openModal('user-modal');
        }
        
        function deleteUser(id) {
            if(confirm('ุญุฐู ุงููุณุชุฎุฏูุ')) {
                db.users = db.users.filter(u => u.id != id);
                saveDB(); renderUsers();
                logActivity('ุญุฐู ูุณุชุฎุฏู', `ุชู ุญุฐู ุงููุณุชุฎุฏู ID: ${id}`);
            }
        }

        function renderStats() {
            document.getElementById('stat-total-orders').innerText = db.orders.length;
            const revenue = db.orders.filter(o => o.status !== 'rejected').reduce((sum, o) => sum + (parseFloat(o.paid) || 0), 0);
            document.getElementById('stat-revenue').innerText = revenue.toLocaleString() + ' ุฌ.ู';
            
            // Debt Logic
            const debt = db.orders.filter(o => o.status !== 'rejected').reduce((sum, o) => sum + (parseFloat(o.price) - parseFloat(o.paid)), 0);
            document.getElementById('stat-debt').innerText = debt.toLocaleString() + ' ุฌ.ู';
            
            // Net Profit Logic
            const totalPayouts = db.payouts.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const netProfit = revenue - totalPayouts;
            document.getElementById('stat-net-profit').innerText = netProfit.toLocaleString() + ' ุฌ.ู';

            // Today's Orders Badge
            const todayStr = new Date().toDateString();
            const todayCount = db.orders.filter(o => new Date(o.dateCreated).toDateString() === todayStr).length;
            const todayBadge = document.getElementById('today-orders-badge');
            if (todayBadge) {
                todayBadge.innerText = todayCount;
                if (todayCount > 0) todayBadge.classList.remove('hidden');
                else todayBadge.classList.add('hidden');
            }

            let lateCount = 0;
            const now = Date.now();
            db.orders.forEach(o => { if(o.status === 'pending' && o.designerId && (now - o.dateAssigned > 86400000)) lateCount++; });
            document.getElementById('stat-late-tasks').innerText = lateCount;
            updateNotifications();
            
            renderCharts();
        }

        function renderCharts() {
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            const ctxMarketer = document.getElementById('marketerChart').getContext('2d');
            const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
            
            // Prepare Data
            const statusCounts = { pending: 0, review: 0, done: 0, rejected: 0 };
            db.orders.forEach(o => { if(statusCounts[o.status] !== undefined) statusCounts[o.status]++; });

            const marketerSales = {};
            db.staff.filter(s => s.type === 'marketer').forEach(m => marketerSales[m.name] = 0);
            db.orders.forEach(o => {
                if(o.status !== 'rejected' && o.marketerId) {
                    const m = db.staff.find(s => s.id == o.marketerId);
                    if(m) marketerSales[m.name] = (marketerSales[m.name] || 0) + parseFloat(o.price);
                }
            });

            // Revenue Data (Last 7 Days)
            const last7Days = [];
            const revenueData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toLocaleDateString('ar-EG', { weekday: 'short', day: 'numeric' }));
                
                const startOfDay = new Date(d.setHours(0,0,0,0)).getTime();
                const endOfDay = new Date(d.setHours(23,59,59,999)).getTime();
                
                const dayRevenue = db.orders.reduce((sum, o) => {
                    if(o.status !== 'rejected' && o.dateCreated >= startOfDay && o.dateCreated <= endOfDay) {
                        return sum + (parseFloat(o.paid) || 0);
                    }
                    return sum;
                }, 0);
                revenueData.push(dayRevenue);
            }

            // Status Chart
            if(statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['ููุฏ ุงูุชูููุฐ', 'ูุฑุงุฌุนุฉ', 'ููุชูู', 'ูุฑููุถ'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts.review, statusCounts.done, statusCounts.rejected],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'Tajawal' } } } } }
            });

            // Marketer Chart
            if(marketerChartInstance) marketerChartInstance.destroy();
            marketerChartInstance = new Chart(ctxMarketer, {
                type: 'bar',
                data: {
                    labels: Object.keys(marketerSales),
                    datasets: [{
                        label: 'ุงููุจูุนุงุช (ุฌ.ู)',
                        data: Object.values(marketerSales),
                        backgroundColor: '#6366f1',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });

            // Revenue Chart
            if(revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(ctxRevenue, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'ุงูุฅูุฑุงุฏุงุช (ุฌ.ู)',
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981',
                        pointBorderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Tajawal' } } }
                }
            });
        }

        function printInvoice(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>ูุงุชูุฑุฉ #${order.id}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Tajawal', sans-serif; background-color: #f8f9fa; padding: 20px; -webkit-print-color-adjust: exact; }
                        .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); background: white; font-size: 16px; line-height: 24px; color: #555; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
                        .header img { max-height: 80px; margin-bottom: 10px; }
                        .header h1 { margin: 0; color: #1e293b; font-size: 24px; font-weight: 800; }
                        .header p { margin: 5px 0; color: #64748b; font-size: 14px; }
                        
                        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .info-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
                        .info-table td:first-child { font-weight: bold; color: #334155; width: 150px; }
                        
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 10px; }
                        .row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                        .row.final { border-top: 2px solid #cbd5e1; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 1.2em; color: #0f172a; }
                        
                        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px dashed #cbd5e1; text-align: center; font-size: 12px; color: #94a3b8; }
                        .footer h4 { margin: 0 0 10px; color: #475569; font-size: 14px; }
                        .footer p { margin: 2px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .invoice-box { box-shadow: none; border: none; padding: 0; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-box">
                        <div class="header">
                            <img src="https://via.placeholder.com/150x80?text=LOGO" alt="Logo">
                            <h1>ูุงุชูุฑุฉ ุทูุจ ุฎุฏูุฉ</h1>
                            <p>ุฑูู ุงููุฑุฌุน: #${order.id}</p>
                            <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>

                        <table class="info-table">
                            <tr><td>ุงูุนููู:</td><td>${order.client}</td></tr>
                            <tr><td>ุฑูู ุงููุงุชู:</td><td>${order.phone}</td></tr>
                            <tr><td>ุงูุฎุฏูุฉ:</td><td>${order.service}</td></tr>
                            <tr><td>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</td><td>${new Date(order.dateCreated).toLocaleDateString('ar-EG')}</td></tr>
                        </table>

                        <div class="total-section">
                            <div class="row"><span>ุงูุฅุฌูุงูู:</span> <span>${parseFloat(order.price).toLocaleString()} ุฌ.ู</span></div>
                            <div class="row"><span>ุงููุฏููุน:</span> <span>${parseFloat(order.paid).toLocaleString()} ุฌ.ู</span></div>
                            <div class="row final" style="color: ${(order.price - order.paid) > 0 ? '#dc2626' : '#16a34a'}"><span>ุงููุชุจูู:</span> <span>${(order.price - order.paid).toLocaleString()} ุฌ.ู</span></div>
                        </div>

                        <div class="footer">
                            <h4>ุงูุดุฑูุท ูุงูุฃุญูุงู</h4>
                            <p>1. ุงูุนุฑุจูู ุงููุฏููุน ูุง ูุณุชุฑุฏ ูู ุญุงูุฉ ุจุฏุก ุงูุนูู.</p>
                            <p>2. ูุชู ุชุณููู ุงููููุงุช ุงูููุงุฆูุฉ (Source Files) ุจุนุฏ ุณุฏุงุฏ ูุงูู ุงููุจูุบ ุงููุชุจูู.</p>
                            <p>3. ุงูุชุนุฏููุงุช ุงููุฌุงููุฉ ูุชุงุญุฉ ูุฑุชูู ููุท ุจุนุฏ ุงูุชุณููู ุงูุฃููู.</p>
                            <p style="margin-top: 15px; font-weight: bold;">ุดูุฑุงู ูุซูุชูู ุจูุง!</p>
                        </div>
                    </div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function sendWhatsApp(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;

            let phone = order.phone.replace(/\D/g, '');
            // ุงูุชุฑุงุถ ุฃู ุงูุฃุฑูุงู ูุตุฑูุฉุ ุฅุฐุง ุจุฏุฃุช ุจู 01 ูุชู ุงุณุชุจุฏุงู ุงูุตูุฑ ุจู 20
            if (phone.startsWith('01')) phone = '2' + phone; 

            const remaining = order.price - order.paid;
            const message = `ูุฑุญุจุงู ${order.client}ุ ๐

ุฅููู ุชูุงุตูู ูุงุชูุฑุฉ ุทูุจู ุฑูู #${order.id}:
๐ ุงูุฎุฏูุฉ: ${order.service}
๐ฐ ุงูุฅุฌูุงูู: ${parseFloat(order.price).toLocaleString()} ุฌ.ู
โ ุงููุฏููุน: ${parseFloat(order.paid).toLocaleString()} ุฌ.ู
โ ุงููุชุจูู: ${remaining.toLocaleString()} ุฌ.ู

ุดูุฑุงู ูุซูุชู ุจูุง! ๐น`;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function sendDeliveryWhatsApp(id) {
            const order = db.orders.find(o => o.id == id);
            if(!order) return;

            let phone = order.phone.replace(/\D/g, '');
            if (phone.startsWith('01')) phone = '2' + phone; 

            let message = `ูุฑุญุจุงู ${order.client}ุ ๐\n\n`;
            message += `ูุณุนุฏูุง ุฅุฎุจุงุฑู ุจุฃู ุทูุจู (${order.service}) ุฌุงูุฒ ููุชุณููู! ๐\n\n`;
            
            if(order.designLink) {
                message += `๐ ุฑุงุจุท ุงูุชุตููู/ุงููููุงุช:\n${order.designLink}\n\n`;
            }

            const remaining = order.price - order.paid;
            if(remaining > 0) {
                message += `โ ูุฑุฌู ุงูุนูู ุฃู ููุงู ูุจูุบ ูุชุจูู: ${remaining.toLocaleString()} ุฌ.ู\n\n`;
            }

            message += `ุดูุฑุงู ูุชุนุงููู ูุนูุง! ๐น`;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- NOTIFICATIONS SYSTEM ---
        function toggleNotificationMenu() {
            const menu = document.getElementById('notification-menu');
            menu.classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.getElementById('notification-bell-container');
            const menu = document.getElementById('notification-menu');
            if (container && !container.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        function updateNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const now = Date.now();
            
            const lateOrders = db.orders.filter(o => 
                o.status === 'pending' && 
                o.designerId && 
                (now - o.dateAssigned > 86400000)
            );

            if (lateOrders.length > 0) {
                badge.classList.remove('hidden');
                list.innerHTML = '';
                lateOrders.forEach(o => {
                    const timeDiff = now - o.dateAssigned;
                    const hoursLate = Math.floor(timeDiff / (1000 * 60 * 60));
                    list.innerHTML += `
                        <div class="p-3 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/30 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/20 transition" onclick="editOrder(${o.id}); toggleNotificationMenu()">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">#${o.id} ${o.client}</h4>
                                <span class="text-[10px] font-bold text-red-500 bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-red-200 dark:border-red-800">${hoursLate}ุณ</span>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ุงูุฎุฏูุฉ: ${o.service}</p>
                        </div>`;
                });
            } else {
                badge.classList.add('hidden');
                list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm"><i class="fas fa-check-circle text-2xl mb-2 text-emerald-500"></i><br>ูุง ุชูุฌุฏ ุชูุจููุงุช</div>`;
            }
        }

        // --- REPORT LOGIC ---
        function openReportModal() {
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('report-month').value = monthStr;
            renderReportTable();
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function renderReportTable() {
            const monthVal = document.getElementById('report-month').value;
            if(!monthVal) return;
            
            const [year, month] = monthVal.split('-').map(Number);
            const tbody = document.getElementById('report-table-body');
            const tfoot = document.getElementById('report-table-footer');
            const tbodyDesigners = document.getElementById('report-designers-body');
            
            tbody.innerHTML = '';
            tbodyDesigners.innerHTML = '';
            
            let grandTotalSales = 0;
            let grandCollectedComm = 0;
            let grandPayouts = 0;

            db.staff.filter(s => s.type === 'marketer').forEach(m => {
                // Filter orders for this marketer in the selected month
                const mOrders = db.orders.filter(o => {
                    const d = new Date(o.dateCreated);
                    return o.marketerId == m.id && 
                           d.getMonth() === (month - 1) && 
                           d.getFullYear() === year && 
                           o.status !== 'rejected';
                });

                const commRate = parseFloat(m.commission) || 0;
                const totalSales = mOrders.reduce((sum, o) => sum + parseFloat(o.price), 0);
                
                // Calculate commission based on ALL non-rejected orders (Deposits count)
                const totalPaid = mOrders.reduce((sum, o) => sum + parseFloat(o.paid), 0);
                const collectedComm = (totalPaid * commRate) / 100; 
                
                // Calculate Payouts for this month
                const mPayouts = db.payouts.filter(p => {
                    const d = new Date(p.date);
                    return p.staffId == m.id && d.getMonth() === (month - 1) && d.getFullYear() === year;
                });
                const totalPayouts = mPayouts.reduce((sum, p) => sum + parseFloat(p.amount), 0);
                const payoutNotes = mPayouts.map(p => p.notes).filter(n => n).join(' | ');

                grandTotalSales += totalSales;
                grandCollectedComm += collectedComm;
                grandPayouts += totalPayouts;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <td class="p-4 font-bold">${m.name} <span class="text-xs text-slate-400">(${commRate}%)</span></td>
                        <td class="p-4">${totalSales.toLocaleString()} ุฌ.ู</td>
                        <td class="p-4 text-blue-600 dark:text-blue-400 font-bold">${collectedComm.toLocaleString()} ุฌ.ู</td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${totalPayouts.toLocaleString()} ุฌ.ู</td>
                        <td class="p-4 text-xs text-slate-500 max-w-[200px] truncate" title="${payoutNotes}">${payoutNotes}</td>
                        <td class="p-4 text-center">
                            <button onclick="openPayoutModal(${m.id}, '${m.name}')" class="bg-emerald-100 text-emerald-600 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 w-8 h-8 rounded-lg transition"><i class="fas fa-hand-holding-usd"></i></button>
                        </td>
                    </tr>
                `;
            });

            if(tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';
            }

            tfoot.innerHTML = `
                <td class="p-4">ุงูุฅุฌูุงูู ุงูููู</td>
                <td class="p-4">${grandTotalSales.toLocaleString()} ุฌ.ู</td>
                <td class="p-4 text-blue-600 dark:text-blue-400">${grandCollectedComm.toLocaleString()} ุฌ.ู</td>
                <td class="p-4 text-emerald-600 dark:text-emerald-400">${grandPayouts.toLocaleString()} ุฌ.ู</td>
                <td></td>
                <td></td>
            `;

            // Render Designers
            db.staff.filter(s => s.type === 'designer').forEach(d => {
                const dPayouts = db.payouts.filter(p => {
                    const date = new Date(p.date);
                    return p.staffId == d.id && date.getMonth() === (month - 1) && date.getFullYear() === year;
                });
                const totalDPayouts = dPayouts.reduce((sum, p) => sum + parseFloat(p.amount), 0);
                const dPayoutNotes = dPayouts.map(p => p.notes).filter(n => n).join(' | ');

                tbodyDesigners.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <td class="p-4 font-bold">${d.name}</td>
                        <td class="p-4 text-slate-500">${d.specialty}</td>
                        <td class="p-4 text-emerald-600 dark:text-emerald-400 font-bold">${totalDPayouts.toLocaleString()} ุฌ.ู</td>
                        <td class="p-4 text-xs text-slate-500 max-w-[200px] truncate" title="${dPayoutNotes}">${dPayoutNotes}</td>
                        <td class="p-4 text-center">
                            <button onclick="openPayoutModal(${d.id}, '${d.name}')" class="bg-emerald-100 text-emerald-600 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 w-8 h-8 rounded-lg transition"><i class="fas fa-hand-holding-usd"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if(tbodyDesigners.innerHTML === '') {
                tbodyDesigners.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400">ูุง ููุฌุฏ ูุตูููู</td></tr>';
            }
        }

        function populateStaffSelects() {
            const mSelect = document.getElementById('order-marketer');
            const dSelect = document.getElementById('order-designer');
            mSelect.innerHTML = '<option value="">-- ูุจุงุดุฑ --</option>';
            dSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ูุตูู --</option>';
            db.staff.filter(s => s.type === 'marketer').forEach(m => mSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);
            db.staff.filter(s => s.type === 'designer').forEach(d => dSelect.innerHTML += `<option value="${d.id}">${d.name} (${d.specialty})</option>`);
        }

        function openModal(modalId, type = null) {
            if(modalId === 'staff-modal') {
                document.getElementById('staff-id').value = ''; // Clear ID for new add
                document.getElementById('staff-role').value = type;
                document.getElementById('marketer-fields').classList.add('hidden');
                document.getElementById('designer-fields').classList.add('hidden');
                if(type === 'marketer') {
                    document.getElementById('staff-modal-title').innerText = "ุฅุถุงูุฉ ูุณูู";
                    document.getElementById('marketer-fields').classList.remove('hidden');
                } else {
                    document.getElementById('staff-modal-title').innerText = "ุฅุถุงูุฉ ูุตูู";
                    document.getElementById('designer-fields').classList.remove('hidden');
                }
            } else if (modalId === 'order-modal') {
                document.getElementById('order-form').reset();
                document.getElementById('order-id').value = '';
                document.getElementById('modal-title').innerText = "ุทูุจ ุฌุฏูุฏ";
                document.getElementById('amount-remaining').value = '0';
                document.getElementById('design-link').value = '';
                document.getElementById('design-notes').value = '';
                document.getElementById('amount-remaining').classList.remove('bg-emerald-50', 'text-emerald-600');
                document.getElementById('order-commission-preview').classList.add('hidden');
                populateStaffSelects();
                document.querySelector('input[name="status-radio"][value="pending"]').checked = true;
                document.getElementById('order-status').value = 'pending';
            } else if (modalId === 'user-modal') {
                // Reset user modal if opened directly (Add mode)
                if(!document.getElementById('user-id').value) {
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.querySelectorAll('.perm-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('user-modal-title').innerText = "ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ";
                }
            }
            const el = document.getElementById(modalId);
            el.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openPayoutModal(id, name) {
            document.getElementById('payout-staff-id').value = id;
            document.getElementById('payout-staff-name').value = name;
            document.getElementById('payout-amount').value = '';
            document.getElementById('payout-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payout-notes').value = '';
            document.getElementById('payout-modal').classList.remove('hidden');
        }

        function savePayout(e) {
            e.preventDefault();
            const staffId = document.getElementById('payout-staff-id').value;
            const amount = parseFloat(document.getElementById('payout-amount').value);
            const date = document.getElementById('payout-date').value;
            const notes = document.getElementById('payout-notes').value;
            
            db.payouts.push({ id: Date.now(), staffId, amount, date, notes });
            saveDB();
            closeModal('payout-modal');
            renderReportTable(); // Refresh report to show new value
            showNotification('ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ', 'success');
        }

        function showNotification(msg, type = 'success') {
            const area = document.getElementById('notification-area');
            const div = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-orange-500');
            div.className = `${colorClass} text-white px-6 py-4 rounded-xl shadow-xl fade-in flex items-center gap-3 min-w-[320px] transform transition-all duration-300`;
            div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} text-xl"></i><span class="font-bold">${msg}</span>`;
            area.appendChild(div);
            setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateX(-20px)'; setTimeout(() => div.remove(), 300); }, 3000);
        }

        checkAuth();
    </script>
</body>
</html>
